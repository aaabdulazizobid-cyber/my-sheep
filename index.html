<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>دفتر الغنم — شامل</title>
<meta name="theme-color" content="#10b981">
<style>
:root{
  --brand:#10b981; --brand2:#34d399;
  --ink:#0f172a; --muted:#6b7280;
  --bg:#f6f7fb; --card:#ffffff; --line:#e5e7eb;
  --warn:#f59e0b; --danger:#ef4444;
  --chip:#ecfeff; --chipb:#a5f3fc; --chips:#155e75;
  --thead:#dcfce7; --row:#f8fffc; --row2:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic","Noto Sans Arabic",Tahoma,sans-serif}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px}
.top h1{margin:0;font-size:18px;font-weight:800}
.wrap{max-width:1040px;margin:auto;padding:12px}

/* KPIs */
.grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:640px){.grid4{grid-template-columns:repeat(2,1fr)}}
.kpi{border:1px solid #d9f5ea;border-radius:12px;padding:10px;text-align:center;cursor:pointer;background:#fff}
.kpi b{display:block;font-size:18px;line-height:1}
.kpi span{font-size:12px;color:var(--muted);line-height:1.2;margin-top:4px;display:block}
.kpi.click{transition:.15s transform,.15s box-shadow}
.kpi.click:hover{box-shadow:0 8px 18px #00000010}
.kpi.click:active{transform:scale(.98)}

/* ألوان الكروت (نفس روح بونيكام) */
.kpi.col{color:#fff;border:0}
.kpi.col b,.kpi.col span{color:#fff}
.kpi.c1{background:linear-gradient(180deg,#ff8bd1,#ff78a7)}
.kpi.c2{background:linear-gradient(180deg,#ffb84d,#ff9a00)}
.kpi.c3{background:linear-gradient(180deg,#5da8ff,#2f6fff)}
.kpi.c4{background:linear-gradient(180deg,#4ed69e,#1fb97e)}
.kpi.c5{background:linear-gradient(180deg,#9c6bff,#7a44e6)}
.kpi.c6{background:linear-gradient(180deg,#ff6b6b,#ff3e3e)}
.kpi.c7{background:linear-gradient(180deg,#3cb5ff,#2578ff)}
.kpi.c8{background:linear-gradient(180deg,#ffb659,#ffa12e)}
.kpi.c9{background:linear-gradient(180deg,#3aa4ff,#2f6fff)}
.kpi.c10{background:linear-gradient(180deg,#43d39e,#19b87b)}
.kpi.c11{background:linear-gradient(180deg,#66c7ff,#2f7dff)}
.kpi.c12{background:linear-gradient(180deg,#47d9b3,#1ebf95)}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #00000008}
.section{padding:10px}

.searchbar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.searchbar input,.searchbar select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:13px}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
.btn.gray{background:#f3f4f6}

/* القائمة */
.list .item{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff 0%,#f6fffb 100%)}
.item:last-child{border-bottom:0}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:var(--chip);border:1px solid var(--chipb);padding:2px 8px;border-radius:999px;color:var(--chips);margin-inline-start:6px}
.badge.sold{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.badge.np{background:#fef9c3;border-color:#fde68a;color:#7a5b00}
.badge.dead{background:#fde68a;border-color:#fcd34d;color:#92400e}
.controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}

/* أولاد الأم */
.children{margin-top:10px;background:#f0fdf4;border:1px dashed var(--line);border-radius:12px;padding:8px}
.children h4{margin:0 0 6px 0;font-size:13px;color:#065f46}
.kids{display:flex;flex-wrap:wrap;gap:6px}
.kid{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}

/* جداول */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
.table thead th{background:var(--thead)}
.table tbody tr:nth-child(odd){background:var(--row)}
.table tbody tr:nth-child(even){background:var(--row2)}

/* مودالات */
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:flex-end;justify-content:center;z-index:50}
.modal.open{display:flex}
.sheet{background:#fff;width:min(760px,100%);border-radius:16px 16px 0 0;padding:14px;border:1px solid var(--line)}
.sheet h3{margin:0 0 8px 0}
.form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.row{display:flex;flex-direction:column}
.row label{font-size:12px;color:var(--muted);margin-bottom:4px}
.form input,.form select,.form textarea{padding:10px;border:1px solid var(--line);border-radius:10px}
.form textarea{grid-column:1 / span 2;min-height:70px}
.sheet .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
@media(max-width:640px){.form{grid-template-columns:1fr}}

/* تبويبات + رجوع */
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.tab{padding:6px 10px;border-radius:999px;border:1px solid var(--line);cursor:pointer;background:#fff}
.tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
.backbar{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.backbar .btn{padding:6px 10px}

/* تبويبات فرعية للمواليد */
.subtabs{display:flex;gap:6px;margin:6px 0}
.subtabs .tab{padding:4px 10px}
</style>
</head>
<body>
<div class="top">
  <h1>دفتر الغنم — شامل</h1>
  <small>افتح من Safari → مشاركة → أضِف للشاشة الرئيسية (PWA)</small>
</div>

<div class="wrap">
  <!-- KPIs ملونة -->
  <div class="grid4">
    <div class="kpi click col c4"  id="kpi_totalAll"><b id="s_totalAll">0</b><span>إجمالي (الكل)</span></div>
    <div class="kpi click col c3"  id="kpi_total"><b id="s_total">0</b><span>إجمالي (حية)</span></div>
    <div class="kpi click col c2"  id="kpi_ewes"><b id="s_ewes">0</b><span>أمهات</span></div>
    <div class="kpi click col c1"  id="kpi_prodEwes"><b id="s_prodEwes">0</b><span>أمهات مُنتِجة</span></div>
  </div>
  <div class="grid4" style="margin-top:6px">
    <div class="kpi click col c6"  id="kpi_npEwes"><b id="s_npEwes">0</b><span>أمهات غير مُنتِجة</span></div>
    <div class="kpi click col c8"  id="kpi_birthYear"><b id="s_birthYear">0</b><span>مواليد سنة</span></div>
    <div class="kpi click col c5"  id="kpi_soldYear"><b id="s_soldYear">0</b><span>مباعة سنة</span></div>
    <div class="kpi click col c7"  id="kpi_deathYear"><b id="s_deathYear">0</b><span>النفوق سنة</span></div>
  </div>
  <div class="grid4" style="margin-top:6px">
    <div class="kpi click col c12" id="kpi_feedYear"><b id="s_feedYear">0</b><span>تكلفة العلف سنة</span></div>
    <div class="kpi click col c10" id="kpi_treatYear"><b id="s_treatYear">0</b><span>تكلفة العلاجات سنة</span></div>
    <div class="kpi click col c9"  id="kpi_vaccYear"><b id="s_vaccYear">0</b><span>التحصينات سنة</span></div>
    <div class="kpi click col c11" id="kpi_summary"><b>📊</b><span>ملخص السنة</span></div>
  </div>

  <!-- الأدوات -->
  <div class="card section" style="margin:12px 0;">
    <div class="searchbar">
      <input id="q" placeholder="بحث بالوسم/المجموعة/الحالة…" oninput="renderList()">
      <select id="viewMode" onchange="renderList()">
        <option value="all">الكل</option>
        <option value="ewes">الأمهات فقط</option>
        <option value="productive">الأمهات المُنتِجة</option>
        <option value="np">غير المُنتِجة</option>
        <option value="newborns">المواليد فقط</option>
      </select>
      <select id="fltStatus" onchange="renderList()">
        <option value="alive">الحية فقط</option>
        <option value="sold">المباعة</option>
        <option value="all">الكل</option>
      </select>
      <button class="btn solid" onclick="openForm()">＋ إضافة رأس</button>
      <button class="btn" onclick="addFeed()">🌾 علف</button>
      <button class="btn" onclick="exportDB()">⬇️ تصدير</button>
      <label class="btn">⬆️ استيراد<input type="file" accept="application/json" style="display:none" onchange="importDB(event)"></label>
      <button class="btn gray" onclick="openRestore()">⏪ استرجاع</button>
      <button class="btn gray" onclick="quickDemo()">وضع تجربة</button>
    </div>
  </div>

  <!-- القائمة -->
  <div class="card list" id="list"></div>

  <!-- السجلات -->
  <div class="card section" style="margin-top:12px">
    <div class="backbar">
      <button class="btn gray" onclick="goHome()">⬅︎ رجوع للوحة</button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="births" onclick="setTab(this)">👶 سجلات الولادات</div>
      <div class="tab" data-tab="newbornList" onclick="setTab(this)">🍼 قائمة المواليد</div>
      <div class="tab" data-tab="sales" onclick="setTab(this)">💰 المبيعات</div>
      <div class="tab" data-tab="feed" onclick="setTab(this)">🌾 العلف</div>
      <div class="tab" data-tab="treat" onclick="setTab(this)">💊 العلاجات</div>
      <div class="tab" data-tab="vacc" onclick="setTab(this)">💉 التحصينات</div>
      <div class="tab" data-tab="death" onclick="setTab(this)">☠️ النفوق</div>
      <div class="tab" data-tab="summary" onclick="setTab(this)">📊 ملخص السنة</div>
    </div>

    <!-- الولادات -->
    <div id="pane_births">
      <div style="overflow:auto;">
        <table class="table" id="tblBirths">
          <thead><tr><th>التاريخ</th><th>الأم</th><th>المواليد</th><th>تفاصيل</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- قائمة المواليد (إناث/ذكور) -->
    <div id="pane_newbornList" style="display:none">
      <div class="subtabs">
        <div class="tab active" data-sub="f" onclick="setNewbornSub(this)">إناث (<span id="nb_f_count">0</span>)</div>
        <div class="tab" data-sub="m" onclick="setNewbornSub(this)">ذكور (<span id="nb_m_count">0</span>)</div>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="tblNewborns">
          <thead><tr><th>الوسم</th><th>الجنس</th><th>الأم</th><th>تاريخ الميلاد</th><th>الحالة</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- المبيعات -->
    <div id="pane_sales" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblSales">
          <thead><tr><th>التاريخ</th><th>الوسم</th><th>التفصيل</th><th>المبلغ</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- العلف -->
    <div id="pane_feed" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblFeed">
          <thead><tr><th>التاريخ</th><th>القيمة</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- العلاجات -->
    <div id="pane_treat" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblTreat">
          <thead><tr><th>التاريخ</th><th>القيمة</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- التحصينات -->
    <div id="pane_vacc" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblVacc">
          <thead><tr><th>التاريخ</th><th>اسم التحصين</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- النفوق -->
    <div id="pane_death" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblDeath">
          <thead><tr><th>التاريخ</th><th>الوسم</th><th>السبب</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ملخص السنة -->
    <div id="pane_summary" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblSummary">
          <thead><tr><th>البند</th><th>سنة</th><th>إجمالي</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- نافذة النموذج -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 id="formTitle">إضافة/تعديل رأس</h3>
    <div class="form">
      <div class="row"><label>الوسم</label><input id="f_id" placeholder="مثال: 406"></div>
      <div class="row"><label>الجنس</label><select id="f_sex"><option>أنثى</option><option>ذكر</option></select></div>
      <div class="row"><label>المجموعة</label><input id="f_group" placeholder="حري/نعيمي…"></div>
      <div class="row"><label>تاريخ الميلاد</label><input id="f_dob" type="date"></div>
      <div class="row"><label>الأم (وسم)</label><input id="f_mother"></div>
      <div class="row"><label>الأب (وسم)</label><input id="f_father"></div>
      <div class="row"><label>آخر وزن (كجم)</label><input id="f_weight" type="number" step="0.1"></div>
      <div class="row"><label>الحالة</label><select id="f_status"><option>حية</option><option>مباعة</option><option>نافقة</option></select></div>
      <div class="row" style="grid-column:1 / span 2"><label><input type="checkbox" id="f_np"> أم غير منتجة</label></div>
      <div class="row" style="grid-column:1 / span 2"><label>ملاحظات</label><textarea id="f_notes" placeholder="ملاحظات…"></textarea></div>
    </div>
    <div class="bar">
      <button class="btn" onclick="closeForm()">إلغاء</button>
      <button class="btn solid" onclick="submitForm()">حفظ</button>
    </div>
  </div>
</div>

<!-- نافذة الاسترجاع -->
<div class="modal" id="restoreModal">
  <div class="sheet">
    <h3>استرجاع نسخة احتياطية</h3>
    <div id="restoreList" class="section" style="max-height:50vh;overflow:auto;"></div>
    <div class="bar">
      <button class="btn" onclick="closeRestore()">إغلاق</button>
    </div>
  </div>
</div>

<script>
/*** التخزين ***/
const KEY='sheep-db-v11';
const BKKEY=KEY+'-backups';
const BKMAX=12;
let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(KEY))||seed()}catch(e){return seed()}}
function save(){ localStorage.setItem(KEY,JSON.stringify(DB)); autoBackup(); }
function seed(){return{sheep:{},events:[],finance:[],treatments:[],vaccines:[],deaths:[]}}
/*
events: [{type:'birth'|'movement'|'weight', ids:[], date, details, amount?}]
finance: [{id,type:'feed',date,desc,qty,cost}]
treatments: [{id,date,sheepId,diagnosis,drug,dose,cost}]
*/

/*** أدوات عامة ***/
const $=id=>document.getElementById(id);
const dstr=(d=new Date())=>new Date(d).toISOString().slice(0,10);
const money=n=>(+n||0).toLocaleString('ar-SA');
const fmt=d=>!d?'—':new Date(d).toLocaleDateString('ar');

/*** نسخ احتياطي تلقائي + استرجاع ***/
function autoBackup(){
  const list=JSON.parse(localStorage.getItem(BKKEY)||'[]');
  const last=(list[0]||{}).hash;
  const cur=JSON.stringify(DB);
  const hash=cur.length+':'+(cur.charCodeAt(0)||0);
  if(hash!==last){
    list.unshift({ts:Date.now(), date:dstr(), hash, size:cur.length, data:cur});
    while(list.length>BKMAX) list.pop();
    localStorage.setItem(BKKEY,JSON.stringify(list));
  }
}
function openRestore(){
  const list=JSON.parse(localStorage.getItem(BKKEY)||'[]');
  const box=$('restoreList'); box.innerHTML='';
  if(!list.length){box.innerHTML='<div class="meta">لا توجد نسخ محفوظة بعد.</div>'}
  list.forEach((b,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div style="flex:1"><div class="name">${new Date(b.ts).toLocaleString('ar')}</div>
      <div class="meta">الحجم ${b.size.toLocaleString()} بايت</div></div>`;
    const btn=document.createElement('button'); btn.className='btn warn'; btn.textContent='استرجاع هذه';
    btn.onclick=()=>{ if(confirm('استرجاع هذه النسخة؟ سيتم استبدال البيانات الحالية.')){ DB=JSON.parse(b.data); save(); renderAll(); closeRestore(); alert('تم الاسترجاع ✅') } };
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='حذف النسخة';
    del.onclick=()=>{ const arr=JSON.parse(localStorage.getItem(BKKEY)||'[]'); arr.splice(i,1); localStorage.setItem(BKKEY,JSON.stringify(arr)); openRestore(); };
    div.append(btn,del); box.appendChild(div);
  });
  $('restoreModal').classList.add('open');
}
function closeRestore(){$('restoreModal').classList.remove('open')}

/*** تبويب السجلات ***/
function setTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const map={'births':'pane_births','newbornList':'pane_newbornList','sales':'pane_sales','feed':'pane_feed','treat':'pane_treat','vacc':'pane_vacc','death':'pane_death','summary':'pane_summary'};
  Object.values(map).forEach(id=>$(id).style.display='none');
  $(map[el.dataset.tab]).style.display='';
}

/*** أولاد الأم وتجميع الدُفعات ***/
function kidsOf(m){return Object.values(DB.sheep).filter(s=>s.motherId===m).sort((a,b)=>a.id>b.id?1:-1)}
function packByDate(m){const map={};kidsOf(m).forEach(k=>{const d=k.dob||'غير معروف';(map[d]??=[]).push(k)});return Object.entries(map).sort((a,b)=>a[0]>b[0]?-1:1)}

/*** إعادة تسمية الوسم وتحديث كل المراجع (لسماح تعديل أرقام المواليد) ***/
function renameSheepId(oldId,newId){
  if(!DB.sheep[oldId]) return true;
  if(newId!==oldId && DB.sheep[newId]){ alert('الوسم موجود'); return false; }
  const src=DB.sheep[oldId];
  DB.sheep[newId]=Object.assign({}, src, {id:newId, updatedAt:new Date().toISOString()});
  if(newId!==oldId) delete DB.sheep[oldId];
  // تحديث مراجع الأم/الأب في باقي الرؤوس
  Object.values(DB.sheep).forEach(s=>{
    if(s.motherId===oldId){ s.motherId=newId; s.updatedAt=new Date().toISOString(); }
    if(s.fatherId===oldId){ s.fatherId=newId; s.updatedAt=new Date().toISOString(); }
  });
  // تحديث الأحداث
  DB.events.forEach(e=>{ if(e.ids) e.ids=e.ids.map(x=>x===oldId?newId:x); });
  // تحديث جداول أخرى
  DB.treatments.forEach(t=>{ if(t.sheepId===oldId) t.sheepId=newId; });
  DB.vaccines.forEach(v=>{ if(v.sheepId===oldId) v.sheepId=newId; });
  DB.deaths.forEach(d=>{ if(d.sheepId===oldId) d.sheepId=newId; });
  return true;
}

/*** نموذج الرأس ***/
let editingId=null;
function openForm(id=null){
  editingId=id||null;
  if(id){
    const s=DB.sheep[id]; if(!s) return;
    $('formTitle').textContent='تعديل رأس';
    $('f_id').value=s.id; $('f_id').disabled=false; // ← السماح بتعديل الوسم
    $('f_sex').value=s.sex||'أنثى'; $('f_group').value=s.group||'';
    $('f_dob').value=s.dob||''; $('f_mother').value=s.motherId||''; $('f_father').value=s.fatherId||'';
    $('f_weight').value=s.lastWeight??''; $('f_status').value=s.status||'حية';
    $('f_notes').value=s.notes||''; $('f_np').checked=!!s.nonProductive;
  }else{
    ['f_id','f_group','f_dob','f_mother','f_father','f_weight','f_notes'].forEach(k=>$(k).value='');
    $('f_id').disabled=false; $('f_sex').value='أنثى'; $('f_status').value='حية'; $('f_np').checked=false;
    $('formTitle').textContent='إضافة رأس';
  }
  $('modal').classList.add('open');
}
function closeForm(){$('modal').classList.remove('open')}
function submitForm(){
  const rec={
    id:$('f_id').value.trim(), sex:$('f_sex').value, group:$('f_group').value.trim(),
    dob:$('f_dob').value||'', motherId:$('f_mother').value.trim(), fatherId:$('f_father').value.trim(),
    lastWeight:$('f_weight').value?+$('f_weight').value:null, status:$('f_status').value,
    notes:$('f_notes').value.trim(), nonProductive:$('f_np').checked
  };
  if(!rec.id){alert('الوسم مطلوب');return}
  if(editingId){
    if(rec.id!==editingId){ if(!renameSheepId(editingId, rec.id)) return; }
    DB.sheep[rec.id]=Object.assign(DB.sheep[rec.id]||{}, rec, {updatedAt:new Date().toISOString()});
  }else{
    if(DB.sheep[rec.id]){alert('الوسم موجود');return}
    DB.sheep[rec.id]=Object.assign(rec,{soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
  }
  save(); renderAll(); closeForm();
}

/*** عمليات على الرؤوس ***/
function setWeight(id){
  const s=DB.sheep[id]; if(!s)return;
  const v=prompt('الوزن (كجم):',s.lastWeight??''); if(v===null)return;
  const w=parseFloat(v); if(!isFinite(w))return alert('رقم غير صالح');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:w+' كجم'});
  save(); renderAll();
}
function editSheep(id){openForm(id)}
function removeSheep(id){
  if(!confirm('حذف الرأس '+id+'؟'))return;
  delete DB.sheep[id];
  DB.events=DB.events.filter(e=>!(e.ids||[]).includes(id));
  DB.treatments=DB.treatments.filter(x=>x.sheepId!==id);
  DB.vaccines=DB.vaccines.filter(x=>x.sheepId!==id);
  DB.deaths=DB.deaths.filter(x=>x.sheepId!==id);
  save(); renderAll();
}

/*** المواليد ***/
function addChild(m){
  const mom=DB.sheep[m]; if(!mom)return alert('الأم غير موجودة');
  const i=kidsOf(m).length+1; const id=m+'-'+String(i).padStart(2,'0'); const date=dstr();
  DB.sheep[id]={id,sex:'أنثى',group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'مولود',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.events.push({type:'birth',ids:[m,id],date,details:'1 مولود'});
  if(mom.nonProductive){ mom.nonProductive=false; mom.updatedAt=new Date().toISOString(); }
  save(); renderAll();
}
function addTwin(m){
  const mom=DB.sheep[m]; if(!mom)return;
  const base=kidsOf(m).length; const date=dstr();
  const mk=i=>m+'-'+String(base+i).padStart(2,'0');
  const a=mk(1), b=mk(2);
  DB.sheep[a]={id:a,sex:'أنثى',group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'توأم',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.sheep[b]={id:b,sex:'ذكر', group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'توأم',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.events.push({type:'birth',ids:[m,a,b],date,details:'2 مولود (توأم)'});
  if(mom.nonProductive){ mom.nonProductive=false; mom.updatedAt=new Date().toISOString(); }
  save(); renderAll();
}
function addMany(m){const n=+prompt('كم مولود؟','3'); if(!n||n<=0)return; for(let i=0;i<n;i++) addChild(m)}

/*** البيع ***/
function sellSheep(id){
  const s=DB.sheep[id]; if(!s)return;
  const price=+prompt('سعر البيع (ريال):','0'); if(isNaN(price))return;
  const date=prompt('تاريخ البيع (YYYY-MM-DD):',dstr()); if(date===null)return;
  s.status='مباعة'; s.soldPrice=price; s.soldDate=date; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'movement',ids:[id],date,details:'بيع',amount:price});
  save(); renderAll();
}
function deleteSale(evId){
  if(!confirm('حذف عملية البيع؟'))return;
  DB.events=DB.events.filter(e=>e._id!==evId);
  const sale=SALE_CACHE[evId];
  if(sale && DB.sheep[sale.sid] && DB.sheep[sale.sid].status==='مباعة'){
    DB.sheep[sale.sid].status='حية'; DB.sheep[sale.sid].soldPrice=null; DB.sheep[sale.sid].soldDate='';
  }
  save(); renderAll();
}
let SALE_CACHE={};

/*** العلف — تاريخ + قيمة فقط ***/
function addFeed(){
  const date=prompt('تاريخ (YYYY-MM-DD):',dstr()); if(date===null)return;
  const cv=prompt('القيمة (ريال):','0'); if(cv===null)return;
  const cost=+cv; if(!isFinite(cost))return alert('قيمة غير صالحة');
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date,desc:'',qty:null,cost});
  save(); renderAll(); alert('تم تسجيل العلف ✅');
}
function deleteFeed(id){ if(!confirm('حذف سجل العلف؟'))return; DB.finance=DB.finance.filter(r=>r.id!==id); save(); renderAll(); }

/*** العلاجات — تاريخ + قيمة فقط (مثل السابق) ***/
function addTreatment(id){
  if(!DB.sheep[id]) return alert('الرأس غير موجود');
  const date=prompt('تاريخ العلاج (YYYY-MM-DD):', dstr()); if(date===null) return;
  const costV=prompt('القيمة (ريال):','0'); if(costV===null) return;
  const cost=+costV; if(!isFinite(cost)) return alert('قيمة غير صالحة');
  DB.treatments.push({id:'treat_'+Date.now(), date, sheepId:id, diagnosis:'', drug:'', dose:'', cost});
  save(); renderAll(); alert('تم تسجيل العلاج ✅');
}
function deleteTreatment(id){ if(!confirm('حذف سجل العلاج؟'))return; DB.treatments=DB.treatments.filter(x=>x.id!==id); save(); renderAll(); }

/*** التحصينات — اسم + تاريخ فقط ***/
function addVaccine(id){
  if(!DB.sheep[id]) return alert('الرأس غير موجود');
  const date=prompt('تاريخ التحصين (YYYY-MM-DD):', dstr()); if(date===null) return;
  const vaccine=prompt('اسم التحصين:',''); if(vaccine===null) return;
  DB.vaccines.push({id:'vac_'+Date.now(), date, sheepId:id, vaccine, dose:'', notes:''});
  save(); renderAll(); alert('تم تسجيل التحصين ✅');
}

/*** نفوق ***/
function markDead(id){
  const s=DB.sheep[id]; if(!s) return alert('غير موجود');
  const date=prompt('تاريخ النفوق (YYYY-MM-DD):', dstr()); if(date===null) return;
  const cause=prompt('سبب النفوق — اختياري:',''); if(cause===null) return;
  s.status='نافقة'; s.updatedAt=new Date().toISOString();
  DB.deaths.push({id:'die_'+Date.now(), date, sheepId:id, cause});
  DB.events.push({type:'movement', ids:[id], date, details:'نفوق', amount:0});
  save(); renderAll();
}

/*** إحصاءات ***/
function getStats(){
  const since=new Date(); since.setDate(since.getDate()-365);
  const all=Object.values(DB.sheep);
  const alive=all.filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  const ewes=alive.filter(s=>s.sex==='أنثى').length;
  const prodEwes=alive.filter(s=>s.sex==='أنثى'&&!s.nonProductive).length;
  const npEwes=alive.filter(s=>s.sex==='أنثى'&&!!s.nonProductive).length;
  // ← تعديل: عدد الولادات من أحداث الولادة خلال سنة
  const birthYear=DB.events.filter(e=>e.type==='birth'&&e.date&&new Date(e.date)>=since).length;
  const feedYear=DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const soldYearEv=DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')&&new Date(e.date)>=since);
  const soldYear=soldYearEv.length; const revYear=soldYearEv.reduce((a,e)=>a+(+e.amount||0),0);
  const treatYear=DB.treatments.filter(t=>new Date(t.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const deathYear=DB.deaths.filter(d=>new Date(d.date)>=since).length;
  const vaccYear=DB.vaccines.filter(v=>new Date(v.date)>=since).length;
  const totalAll = all.length;
  return {totalAlive:alive.length, totalAll, ewes, prodEwes, npEwes, birthYear, feedYear, soldYear, revYear, treatYear, deathYear, vaccYear};
}
function statsToUI(){
  const s=getStats();
  $('s_totalAll').textContent=s.totalAll;
  $('s_total').textContent=s.totalAlive;
  $('s_ewes').textContent=s.ewes;
  $('s_prodEwes').textContent=s.prodEwes;
  $('s_npEwes').textContent=s.npEwes;
  $('s_birthYear').textContent=s.birthYear;
  $('s_feedYear').textContent=money(s.feedYear);
  $('s_soldYear').textContent=s.soldYear;
  $('s_treatYear').textContent=money(s.treatYear);
  $('s_deathYear').textContent=s.deathYear;
  $('s_vaccYear').textContent=s.vaccYear;
}

/*** إظهار/إخفاء قائمة الغنم عند فتح صفحات داخلية ***/
function showList(flag){ $('list').style.display = flag ? '' : 'none'; }
function goHome(){ showList(true); window.scrollTo({top:document.querySelector('.wrap').offsetTop,behavior:'smooth'}); }

/*** فتح صفحات داخلية من المربعات ***/
function openSection(name, sub){
  const recordNames=['sales','death','feed','treat','vacc','summary','newborns'];
  if(recordNames.includes(name)){ showList(false); } else { showList(true); }
  const map={ sales:'sales', death:'death', feed:'feed', treat:'treat', vacc:'vacc', summary:'summary', newborns:'newbornList' };
  const tab=document.querySelector(`.tab[data-tab="${map[name]||'summary'}"]`);
  if(tab) setTab(tab);
  if(name==='newborns'){
    const target=sub==='m'
      ? document.querySelector('#pane_newbornList .tab[data-sub="m"]')
      : document.querySelector('#pane_newbornList .tab[data-sub="f"]');
    if(target) setNewbornSub(target);
  }
  document.querySelector('.tabs').scrollIntoView({behavior:'smooth'});
}

/*** ربط الـ KPIs ***/
document.addEventListener('DOMContentLoaded',()=>{
  $('kpi_totalAll').onclick =()=> openSection('summary');
  $('kpi_total').onclick   =()=>{ showList(true); $('fltStatus').value='alive'; $('viewMode').value='all'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_ewes').onclick    =()=>{ showList(true); $('viewMode').value='ewes'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_prodEwes').onclick=()=>{ showList(true); $('viewMode').value='productive'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_npEwes').onclick  =()=>{ showList(true); $('viewMode').value='np'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_birthYear').onclick=()=> openSection('newborns','f');
  $('kpi_soldYear').onclick =()=> openSection('sales');
  $('kpi_deathYear').onclick=()=> openSection('death');
  $('kpi_feedYear').onclick =()=> openSection('feed');
  $('kpi_treatYear').onclick=()=> openSection('treat');
  $('kpi_vaccYear').onclick =()=> openSection('vacc');
  $('kpi_summary').onclick  =()=> openSection('summary');
});

/*** عرض القائمة ***/
function renderList(){
  const q=($('q').value||'').trim().toLowerCase();
  const mode=$('viewMode').value, flt=$('fltStatus').value;
  let arr=Object.values(DB.sheep);

  if(q){
    arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q));
  }
  if(mode==='ewes'){arr=arr.filter(s=>s.sex==='أنثى')}
  else if(mode==='productive'){arr=arr.filter(s=>s.sex==='أنثى'&&!s.nonProductive)}
  else if(mode==='np'){arr=arr.filter(s=>s.sex==='أنثى'&&!!s.nonProductive)}
  else if(mode==='newborns'){arr=arr.filter(s=>s.motherId&&s.motherId!=='')}

  if(flt==='alive')arr=arr.filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  else if(flt==='sold')arr=arr.filter(s=>s.status==='مباعة');

  arr.sort((a,b)=>{if(a.sex!==b.sex)return a.sex==='أنثى'?-1:1;return a.id>b.id?1:-1});

  const box=$('list'); box.innerHTML='';
  if(!arr.length){box.innerHTML='<div class="item">لا توجد سجلات..</div>';return}

  arr.forEach(s=>{
    const row=document.createElement('div'); row.className='item';
    const info=document.createElement('div'); info.style.flex='1';

    const title=document.createElement('div');
    title.innerHTML=`<span class="name">${s.id}</span>
      ${s.sex==='أنثى'?'<span class="badge">أم</span>':''}
      ${s.nonProductive?'<span class="badge np">🛑 غير منتجة</span>':''}
      ${s.status==='نافقة'?'<span class="badge dead">نافقة</span>':''}
      ${(s.status!=='حية'&&s.status!=='نافقة')?`<span class="badge sold">${s.status}${s.soldPrice!=null?' • '+s.soldPrice+' ر.س':''}</span>`:''}`;
    info.appendChild(title);

    const meta=document.createElement('div'); meta.className='meta';
    meta.textContent=`${s.group||'–'} • ${s.sex||'–'} • ${fmt(s.dob)}${s.lastWeight!=null?' • '+s.lastWeight+' كجم':''}`;
    info.appendChild(meta);

    if(s.sex==='أنثى'){
      const packs=packByDate(s.id); const wrap=document.createElement('div'); wrap.className='children';
      wrap.innerHTML=`<h4>مواليد ${packs.length?'':'— لا يوجد'}</h4>`;
      packs.forEach(([date,kids])=>{
        const line=document.createElement('div'); line.style.margin='6px 0';
        line.innerHTML=`<div class="meta">دفعة ${fmt(date)} (${kids.length})</div>`;
        const rowKids=document.createElement('div'); rowKids.className='kids';
        kids.forEach(k=>{const b=document.createElement('span'); b.className='kid'; b.textContent=`${k.id} • ${k.sex||'—'}`; rowKids.appendChild(b)});
        line.appendChild(rowKids); wrap.appendChild(line);
      });
      info.appendChild(wrap);
    }

    const ctr=document.createElement('div'); ctr.className='controls';
    if (s.sex==='أنثى' && s.status!=='مباعة' && s.status!=='نافقة') {
      const b1=btn('+ مولود',()=>addChild(s.id));
      const b2=btn('توأم +',()=>addTwin(s.id));
      const b3=btn('+ متعدد',()=>addMany(s.id));
      ctr.append(b1,b2,b3);
    }
    if(s.status!=='نافقة') ctr.append(btn('⚖️ وزن',()=>setWeight(s.id)));
    ctr.append(btn('علاج 💊',()=>addTreatment(s.id)), btn('لقاح 💉',()=>addVaccine(s.id)));
    if(s.status!=='نافقة') ctr.append(btn('بيع 💰',()=>sellSheep(s.id),'warn'));
    ctr.append(btn('تعديل',()=>editSheep(s.id)));
    if(s.status!=='نافقة') ctr.append(btn('نفوق ☠️',()=>markDead(s.id),'danger'));
    ctr.append(btn('حذف 🗑',()=>removeSheep(s.id),'danger'));

    info.appendChild(ctr);
    row.appendChild(info);
    box.appendChild(row);
  });

  function btn(t,fn,cls=''){const b=document.createElement('button'); b.className='btn'+(cls?' '+cls:''); b.textContent=t; b.onclick=fn; return b}
}

/*** السجلات ***/
function renderLogs(){
  // ولادات
  const tbB=$('tblBirths').querySelector('tbody'); tbB.innerHTML='';
  DB.events.filter(e=>e.type==='birth').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(e=>{
    const mom=(e.ids||[])[0]||'—'; const kids=(e.ids||[]).slice(1).join('، ');
    tbB.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${mom}</td><td>${kids||'—'}</td><td>${e.details||''}</td></tr>`);
  });

  // قائمة المواليد
  renderNewbornList();

  // مبيعات
  const tbS=$('tblSales').querySelector('tbody'); tbS.innerHTML=''; SALE_CACHE={};
  DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||''))
    .sort((a,b)=>(b.date||'').localeCompare(a.date||''))
    .forEach(e=>{
      const sid=(e.ids||[])[0]||'—'; const id='_sale_'+(e._id||(e._id=String(Math.random()).slice(2)));
      SALE_CACHE[id]={sid};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(e.date)}</td><td>${sid}</td><td>بيع</td><td>${money(+e.amount||0)}</td>`;
      const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn danger'; b.textContent='🗑'; b.onclick=()=>deleteSale(id);
      td.appendChild(b); tr.appendChild(td); tbS.appendChild(tr);
    });

  // علف
  const tbF=$('tblFeed').querySelector('tbody'); tbF.innerHTML='';
  DB.finance.filter(f=>f.type==='feed').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${money(r.cost||0)}</td>`;
    const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn danger'; b.textContent='🗑'; b.onclick=()=>deleteFeed(r.id);
    td.appendChild(b); tr.appendChild(td); tbF.appendChild(tr);
  });

  // علاج
  const tbT=$('tblTreat').querySelector('tbody'); tbT.innerHTML='';
  DB.treatments.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(t.date)}</td><td>${money(+t.cost||0)}</td>`;
    const td=document.createElement('td'); const bd=document.createElement('button'); bd.className='btn danger'; bd.textContent='🗑'; bd.onclick=()=>deleteTreatment(t.id);
    td.appendChild(bd);
    tr.appendChild(td); tbT.appendChild(tr);
  });

  // التحصينات
  const tbV=$('tblVacc').querySelector('tbody'); tbV.innerHTML='';
  DB.vaccines.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(v.date)}</td><td>${v.vaccine||''}</td>`;
    tbV.appendChild(tr);
  });

  // نفوق
  const tbD=$('tblDeath').querySelector('tbody'); tbD.innerHTML='';
  DB.deaths.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(d.date)}</td><td>${d.sheepId}</td><td>${d.cause||'—'}</td>`;
    tbD.appendChild(tr);
  });

  // ملخص السنة
  renderSummary();
}

/*** قائمة المواليد (إناث/ذكور) ***/
let NEWBORN_SUB='f';
function setNewbornSub(el){
  document.querySelectorAll('#pane_newbornList .subtabs .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  NEWBORN_SUB=el.dataset.sub;
  renderNewbornList();
}
function renderNewbornList(){
  const arr=Object.values(DB.sheep).filter(s=>s.motherId&&s.motherId!=='');
  const f=arr.filter(s=>s.sex==='أنثى');
  const m=arr.filter(s=>s.sex==='ذكر');
  $('nb_f_count').textContent=f.length;
  $('nb_m_count').textContent=m.length;
  const show=NEWBORN_SUB==='f'?f:m;
  const tb=$('tblNewborns').querySelector('tbody'); tb.innerHTML='';
  show.sort((a,b)=>a.id>b.id?1:-1).forEach(s=>{
    tb.insertAdjacentHTML('beforeend',`<tr><td>${s.id}</td><td>${s.sex||'—'}</td><td>${s.motherId||'—'}</td><td>${fmt(s.dob)}</td><td>${s.status||'—'}</td></tr>`);
  });
}

/*** ملخص السنة ***/
function renderSummary(){
  const since=new Date(); since.setDate(since.getDate()-365);
  const feedYear = DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const treatYear= DB.treatments.filter(t=>new Date(t.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const costYear = feedYear + treatYear;
  const revYear  = DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')&&new Date(e.date)>=since).reduce((a,e)=>a+(+e.amount||0),0);
  const netYear  = revYear - costYear;

  const feedAll  = DB.finance.filter(f=>f.type==='feed').reduce((a,b)=>a+(+b.cost||0),0);
  const treatAll = DB.treatments.reduce((a,b)=>a+(+b.cost||0),0);
  const costAll  = feedAll + treatAll;
  const revAll   = DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')).reduce((a,e)=>a+(+e.amount||0),0);
  const netAll   = revAll - costAll;

  const rows = [
    ['🌾 العلف', money(feedYear),  money(feedAll)],
    ['💊 العلاجات', money(treatYear), money(treatAll)],
    ['📦 المصاريف (علف+علاجات)', money(costYear), money(costAll)],
    ['💰 المبيعات', money(revYear), money(revAll)],
    ['📈 الصافي', money(netYear), money(netAll)],
  ];
  const tb=$('tblSummary').querySelector('tbody'); tb.innerHTML='';
  rows.forEach(r=> tb.insertAdjacentHTML('beforeend', `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`));
}

/*** تصدير/استيراد وتجربة ***/
function exportDB(){
  const blob=new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='sheep-backup-'+dstr()+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importDB(ev){
  const f=ev.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); renderAll(); alert('تم الاستيراد ✅') }catch{ alert('ملف غير صالح') } };
  r.readAsText(f);
}
function quickDemo(){
  if(!confirm('تعبئة بيانات تجربة؟'))return;
  DB=seed();
  DB.sheep['600']={id:'600',sex:'أنثى',group:'حري',dob:'2024-10-10',status:'حية',nonProductive:true};
  DB.sheep['600-01']={id:'600-01',sex:'أنثى',group:'مواليد',dob:dstr(),motherId:'600',status:'حية'};
  DB.events.push({type:'birth',ids:['600','600-01'],date:dstr(),details:'1 مولود'});
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date:dstr(),desc:'',qty:null,cost:160});
  DB.treatments.push({id:'treat_'+(Date.now()+1),date:dstr(),sheepId:'600',diagnosis:'',drug:'',dose:'',cost:25});
  DB.vaccines.push({id:'vac_'+(Date.now()+2),date:dstr(),sheepId:'600',vaccine:'جرعة اختبار',dose:'',notes:''});
  save(); renderAll();
}

/*** هجرة ولادات مفقودة (مرة واحدة) ***/
(function migrateBirthsOnce(){
  const FLAG=KEY+'-migrated';
  if(localStorage.getItem(FLAG))return;
  const seen=new Set(DB.events.filter(e=>e.type==='birth').map(e=>(e.ids||[]).join('|')+'@'+e.date));
  const buckets={};
  Object.values(DB.sheep).forEach(s=>{
    if(s.motherId&&s.dob){
      const k=s.motherId+'@'+s.dob; (buckets[k]??={mom:s.motherId,date:s.dob,kids:[]}).kids.push(s.id)
    }
  });
  Object.values(buckets).forEach(b=>{
    const key=[b.mom].concat(b.kids).join('|')+'@'+b.date;
    if(!seen.has(key)){ DB.events.push({type:'birth',ids:[b.mom].concat(b.kids),date:b.date,details:`${b.kids.length} مولود (مهاجرة)`}); }
  });
  save(); localStorage.setItem(FLAG,'1');
})();

/*** تشغيل شامل ***/
function renderAll(){ renderList(); statsToUI(); renderLogs(); }
renderAll();

/*** PWA ***/
(function injectPWA(){
  const manifest = {
    "name":"دفتر الغنم — شامل","short_name":"دفتر الغنم","start_url":"./","display":"standalone",
    "background_color":"#10b981","theme_color":"#10b981",
    "icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%2310b981'/%3E%3Ctext x='50%25' y='57%25' text-anchor='middle' font-size='120' fill='white'%3E%F0%9F%90%91%3C/text%3E%3C/svg%3E","sizes":"256x256","type":"image/svg+xml"}]
  };
  const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const mUrl=URL.createObjectURL(mBlob); const link=document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

  if('serviceWorker' in navigator){
    const swCode=`
      const CACHE='sheep-cache-v2';
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim(); });
      self.addEventListener('fetch',e=>{
        e.respondWith(
          caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{ const cp=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,cp)); return res; }).catch(()=>r))
        );
      });
    `;
    const swBlob=new Blob([swCode],{type:'text/javascript'});
    const swUrl=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();
</script>
</body>
</html>
