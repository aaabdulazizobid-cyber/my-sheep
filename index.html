<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>دفتر الغنم — شامل (علاج/نفوق/لقاحات)</title>
<meta name="theme-color" content="#10b981">
<style>
:root{--brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px}
.top h1{margin:0;font-size:18px;font-weight:800}
.wrap{max-width:1000px;margin:auto;padding:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
.kpi b{display:block;font-size:20px}
.kpi span{font-size:12px;color:var(--muted)}
.kpi.click{cursor:pointer;transition:.15s transform}.kpi.click:active{transform:scale(.98)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.section{padding:10px}
.searchbar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.searchbar input,.searchbar select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:13px}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.gray{background:#f3f4f6}
.list .item{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75;margin-inline-start:6px}
.badge.sold{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.badge.np{background:#e5e7eb;border-color:#d1d5db;color:#374151}
.controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.children{margin-top:10px;background:#f9fafb;border:1px dashed var(--line);border-radius:12px;padding:8px}
.children h4{margin:0 0 6px 0;font-size:13px;color:#0f766e}
.kids{display:flex;flex-wrap:wrap;gap:6px}.kid{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:flex-end;justify-content:center;z-index:50}
.modal.open{display:flex}.sheet{background:#fff;width:min(720px,100%);border-radius:16px 16px 0 0;padding:14px;border:1px solid var(--line)}
.sheet h3{margin:0 0 8px 0}.form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.row{display:flex;flex-direction:column}.row label{font-size:12px;color:var(--muted);margin-bottom:4px}
.form input,.form select,.form textarea{padding:10px;border:1px solid var(--line);border-radius:10px}
.form textarea{grid-column:1 / span 2;min-height:70px}.sheet .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
@media(max-width:640px){.form{grid-template-columns:1fr}}
.badge.dead{background:#fde68a;border-color:#fcd34d;color:#92400e}
</style>
</head>
<body>
<div class="top"><h1>دفتر الغنم — شامل</h1>
<small>افتح من Safari → مشاركة → أضِف للشاشة الرئيسية</small></div>

<div class="wrap">
  <!-- KPIs -->
  <div class="grid4">
    <div class="kpi"><b id="s_total">0</b><span>إجمالي (حية)</span></div>
    <div class="kpi click" id="kpi_ewes"><b id="s_ewes">0</b><span>أمهات</span></div>
    <div class="kpi click" id="kpi_birthYear"><b id="s_birthYear">0</b><span>مواليد سنة</span></div>
    <div class="kpi"><b id="s_feedYear">0</b><span>تكلفة العلف سنة</span></div>
  </div>
  <div class="grid4" style="margin-top:8px">
    <div class="kpi"><b id="s_soldYear">0</b><span>مباعة سنة</span></div>
    <div class="kpi"><b id="s_revYear">0</b><span>إيراد سنة</span></div>
    <div class="kpi"><b id="s_treatYear">0</b><span>تكلفة العلاج سنة</span></div>
    <div class="kpi"><b id="s_deathYear">0</b><span>النفوق سنة</span></div>
  </div>

  <!-- أدوات -->
  <div class="card section" style="margin:12px 0;">
    <div class="searchbar">
      <input id="q" placeholder="بحث بالوسم/المجموعة/الحالة…" oninput="renderList()">
      <select id="viewMode" onchange="renderList()">
        <option value="all">الكل</option>
        <option value="ewes">الأمهات فقط</option>
        <option value="newborns">المواليد فقط</option>
        <option value="np">غير المنتِجة</option>
      </select>
      <select id="fltStatus" onchange="renderList()">
        <option value="alive">الحية فقط</option>
        <option value="sold">المباعة</option>
        <option value="all">الكل</option>
      </select>
      <button class="btn solid" onclick="openForm()">＋ إضافة رأس</button>
      <button class="btn" onclick="addFeed()">💸 علف</button>
      <button class="btn" onclick="exportDB()">⬇️ تصدير</button>
      <label class="btn">⬆️ استيراد<input type="file" accept="application/json" style="display:none" onchange="importDB(event)"></label>
      <button class="btn gray" onclick="quickDemo()">وضع تجربة</button>
    </div>
  </div>

  <!-- القائمة -->
  <div class="card list" id="list"></div>

  <!-- السجلات -->
  <div class="card section" style="margin-top:12px">
    <h3>السجلات</h3>

    <div style="overflow:auto;margin-top:6px">
      <table class="table" id="tblBirths">
        <thead><tr><th>التاريخ</th><th>الأم</th><th>المواليد</th><th>تفاصيل</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblSales">
        <thead><tr><th>التاريخ</th><th>الوسم</th><th>التفصيل</th><th>المبلغ</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblFeed">
        <thead><tr><th>التاريخ</th><th>الوصف</th><th>الكمية</th><th>التكلفة</th><th></th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblTreat">
        <thead><tr><th>التاريخ</th><th>الوسم</th><th>العلاج/التشخيص</th><th>الجرعة</th><th>التكلفة</th><th></th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblVacc">
        <thead><tr><th>التاريخ</th><th>الوسم</th><th>اللقاح</th><th>الجرعة</th><th>ملاحظات</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblDeath">
        <thead><tr><th>التاريخ</th><th>الوسم</th><th>السبب</th></tr></thead><tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- نافذة النموذج -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 id="formTitle">إضافة/تعديل رأس</h3>
    <div class="form">
      <div class="row"><label>الوسم</label><input id="f_id" placeholder="مثال: 406"></div>
      <div class="row"><label>الجنس</label>
        <select id="f_sex"><option>أنثى</option><option>ذكر</option></select></div>
      <div class="row"><label>المجموعة</label><input id="f_group" placeholder="حري/نعيمي…"></div>
      <div class="row"><label>تاريخ الميلاد</label><input id="f_dob" type="date"></div>
      <div class="row"><label>الأم (وسم)</label><input id="f_mother"></div>
      <div class="row"><label>الأب (وسم)</label><input id="f_father"></div>
      <div class="row"><label>آخر وزن (كجم)</label><input id="f_weight" type="number" step="0.1"></div>
      <div class="row"><label>الحالة</label>
        <select id="f_status"><option>حية</option><option>مباعة</option><option>نافقة</option></select></div>
      <div class="row" style="grid-column:1 / span 2">
        <label><input type="checkbox" id="f_np"> أم غير منتجة</label>
      </div>
      <div class="row" style="grid-column:1 / span 2">
        <label>ملاحظات</label><textarea id="f_notes" placeholder="ملاحظات…"></textarea>
      </div>
    </div>
    <div class="bar">
      <button class="btn" onclick="closeForm()">إلغاء</button>
      <button class="btn solid" onclick="submitForm()">حفظ</button>
    </div>
  </div>
</div>

<script>
/*** التخزين ***/
const KEY='sheep-db-v10';
let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(KEY))||seed()}catch(e){return seed()}}
function save(){localStorage.setItem(KEY,JSON.stringify(DB))}
function seed(){return{sheep:{},events:[],finance:[],medicals:[],vaccines:[],deaths:[]}}
// ملاحظات:
// finance: [{id,type:'feed',date,desc,qty,cost}]
// medicals: [{id,date,sheepId,drug,diagnosis,dose,cost}]
// vaccines: [{id,date,sheepId,vaccine,dose,notes}]
// deaths: [{id,date,sheepId,cause}]

const byId=id=>document.getElementById(id);
const dstr=(d=new Date())=>new Date(d).toISOString().slice(0,10);
const money=n=>(+n||0).toLocaleString('ar-SA');
const fmt=d=>!d?'—':new Date(d).toLocaleDateString('ar');

/*** أطفال الأم وتجميع الدُفعات ***/
function getChildren(m){return Object.values(DB.sheep).filter(s=>s.motherId===m).sort((a,b)=>a.id>b.id?1:-1)}
function groupByBirthDate(m){const map={};getChildren(m).forEach(k=>{const d=k.dob||'غير معروف';(map[d]??=[]).push(k)});return Object.entries(map).sort((a,b)=>a[0]>b[0]?-1:1)}

/*** نموذج الإضافة/التعديل ***/
let editingId=null;
function openForm(id=null){
  editingId=id||null;
  if(id){
    const s=DB.sheep[id]; if(!s) return;
    byId('formTitle').textContent='تعديل رأس';
    byId('f_id').value=s.id; byId('f_id').disabled=true;
    byId('f_sex').value=s.sex||'أنثى';
    byId('f_group').value=s.group||'';
    byId('f_dob').value=s.dob||'';
    byId('f_mother').value=s.motherId||'';
    byId('f_father').value=s.fatherId||'';
    byId('f_weight').value=s.lastWeight??'';
    byId('f_status').value=s.status||'حية';
    byId('f_notes').value=s.notes||'';
    byId('f_np').checked=!!s.nonProductive;
  }else{
    ['f_id','f_group','f_dob','f_mother','f_father','f_weight','f_notes'].forEach(k=>byId(k).value='');
    byId('f_id').disabled=false; byId('f_sex').value='أنثى'; byId('f_status').value='حية'; byId('f_np').checked=false;
    byId('formTitle').textContent='إضافة رأس';
  }
  byId('modal').classList.add('open');
}
function closeForm(){byId('modal').classList.remove('open')}
function submitForm(){
  const rec={
    id:byId('f_id').value.trim(),
    sex:byId('f_sex').value, group:byId('f_group').value.trim(),
    dob:byId('f_dob').value||'', motherId:byId('f_mother').value.trim(),
    fatherId:byId('f_father').value.trim(),
    lastWeight:byId('f_weight').value?+byId('f_weight').value:null,
    status:byId('f_status').value, notes:byId('f_notes').value.trim(),
    nonProductive: byId('f_np').checked
  };
  if(!rec.id){alert('الوسم مطلوب');return}
  if(editingId){Object.assign(DB.sheep[editingId],rec,{updatedAt:new Date().toISOString()})}
  else{
    if(DB.sheep[rec.id]){alert('الوسم موجود');return}
    DB.sheep[rec.id]=Object.assign(rec,{soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})
  }
  save(); closeForm(); renderList(); statsToUI();
}

/*** عمليات على الرؤوس ***/
function setWeight(id){const s=DB.sheep[id];if(!s)return;const v=prompt('الوزن (كجم):',s.lastWeight??'');if(v===null)return;const w=parseFloat(v);if(!isFinite(w))return alert('رقم غير صالح');s.lastWeight=w;s.updatedAt=new Date().toISOString();DB.events.push({type:'weight',ids:[id],date:dstr(),details:w+' كجم'});save();renderList();renderLogs()}
function editSheep(id){openForm(id)}
function removeSheep(id){if(!confirm('حذف الرأس '+id+'؟'))return;delete DB.sheep[id];DB.events=DB.events.filter(e=>!(e.ids||[]).includes(id));DB.medicals=DB.medicals.filter(x=>x.sheepId!==id);DB.vaccines=DB.vaccines.filter(x=>x.sheepId!==id);DB.deaths=DB.deaths.filter(x=>x.sheepId!==id);save();renderList();statsToUI();renderLogs()}

/*** المواليد ***/
function addChild(m){const mom=DB.sheep[m];if(!mom)return alert('الأم غير موجودة');const i=getChildren(m).length+1;const id=m+'-'+String(i).padStart(2,'0');const date=dstr();DB.sheep[id]={id,sex:'أنثى',group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'مولود',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.events.push({type:'birth',ids:[m,id],date,details:'1 مولود'});save();renderList();statsToUI();renderLogs()}
function addTwin(m){const mom=DB.sheep[m];if(!mom)return;const base=getChildren(m).length;const date=dstr();const mk=i=>m+'-'+String(base+i).padStart(2,'0');const a=mk(1),b=mk(2);DB.sheep[a]={id:a,sex:'أنثى',group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'توأم',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.sheep[b]={id:b,sex:'ذكر',group:'مواليد',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'توأم',status:'حية',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.events.push({type:'birth',ids:[m,a,b],date,details:'2 مولود (توأم)'});save();renderList();statsToUI();renderLogs()}
function addMany(m){const n=+prompt('كم مولود؟','3');if(!n||n<=0)return;for(let i=0;i<n;i++)addChild(m)}

/*** البيع ***/
function sellSheep(id){const s=DB.sheep[id];if(!s)return;const price=+prompt('سعر البيع (ريال):','0');if(isNaN(price))return;const date=prompt('تاريخ البيع (YYYY-MM-DD):',dstr());if(date===null)return;s.status='مباعة';s.soldPrice=price;s.soldDate=date;s.updatedAt=new Date().toISOString();DB.events.push({type:'movement',ids:[id],date,details:'بيع',amount:price});save();renderList();statsToUI();renderLogs()}

/*** علف ***/
function addFeed(){
  const date=prompt('تاريخ (YYYY-MM-DD):',dstr());if(date===null)return;
  const desc=prompt('الوصف:','علف');if(desc===null)return;
  const qv=prompt('الكمية (اختياري):','');const qty=qv===''?null:+qv;if(qv!==''&&!isFinite(qty))return alert('كمية غير صالحة');
  const cv=prompt('التكلفة (ريال):','0');if(cv===null)return;const cost=+cv;if(!isFinite(cost))return alert('تكلفة غير صالحة');
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date,desc,qty,cost});
  save();statsToUI();renderLogs();alert('تم تسجيل العلف ✅')
}
function deleteFeed(fid){if(!confirm('حذف سجل العلف؟'))return;DB.finance=DB.finance.filter(r=>!(r.type==='feed'&&r.id===fid));save();statsToUI();renderLogs()}

/*** علاج (طبي) ***/
function addTreatment(id){
  if(!DB.sheep[id]) return alert('الرأس غير موجود');
  const date=prompt('تاريخ العلاج (YYYY-MM-DD):', dstr()); if(date===null) return;
  const diagnosis=prompt('التشخيص/الملاحظة:',''); if(diagnosis===null) return;
  const drug=prompt('اسم العلاج/الدواء:',''); if(drug===null) return;
  const dose=prompt('الجرعة (مثال: 5مل مرتين):',''); if(dose===null) return;
  const costV=prompt('تكلفة العلاج (ريال) — اختياري:',''); if(costV===null) return;
  const cost= costV===''? null : +costV; if(costV!=='' && !isFinite(cost)) return alert('تكلفة غير صالحة');
  DB.medicals.push({id:'med_'+Date.now(), date, sheepId:id, drug, diagnosis, dose, cost});
  save(); renderLogs(); statsToUI(); alert('تم تسجيل العلاج ✅');
}
function deleteTreatment(mid){
  if(!confirm('حذف سجل العلاج؟')) return;
  DB.medicals = DB.medicals.filter(m=>m.id!==mid);
  save(); renderLogs(); statsToUI();
}

/*** لقاحات ***/
function addVaccine(id){
  if(!DB.sheep[id]) return alert('الرأس غير موجود');
  const date=prompt('تاريخ اللقاح (YYYY-MM-DD):', dstr()); if(date===null) return;
  const vaccine=prompt('اسم اللقاح:','لقاح طاعون/جدري…'); if(vaccine===null) return;
  const dose=prompt('الجرعة:','مثال: 2 مل'); if(dose===null) return;
  const notes=prompt('ملاحظات — اختياري:',''); if(notes===null) return;
  DB.vaccines.push({id:'vac_'+Date.now(), date, sheepId:id, vaccine, dose, notes});
  save(); renderLogs(); alert('تم تسجيل اللقاح ✅');
}

/*** نفوق ***/
function markDead(id){
  const s=DB.sheep[id]; if(!s) return alert('غير موجود');
  const date=prompt('تاريخ النفوق (YYYY-MM-DD):', dstr()); if(date===null) return;
  const cause=prompt('سبب النفوق — اختياري:',''); if(cause===null) return;
  s.status='نافقة'; s.updatedAt=new Date().toISOString();
  DB.deaths.push({id:'die_'+Date.now(), date, sheepId:id, cause});
  DB.events.push({type:'movement', ids:[id], date, details:'نفوق', amount:0});
  save(); renderList(); renderLogs(); statsToUI();
}

/*** إحصاءات ***/
function getStats(){
  const since=new Date();since.setDate(since.getDate()-365);
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  const ewes=alive.filter(s=>s.sex==='أنثى').length;
  const birthYear=Object.values(DB.sheep).filter(s=>s.dob&&new Date(s.dob)>=since).length;

  const feedYear=DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const feedAll=DB.finance.filter(f=>f.type==='feed').reduce((a,b)=>a+(+b.cost||0),0);

  const soldYearEv=DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')&&new Date(e.date)>=since);
  const soldYear=soldYearEv.length; const revYear=soldYearEv.reduce((a,e)=>a+(+e.amount||0),0);
  const revAll=DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')).reduce((a,e)=>a+(+e.amount||0),0);

  const treatYear=DB.medicals.filter(m=>new Date(m.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const deathYear=DB.deaths.filter(d=>new Date(d.date)>=since).length;

  return{total:alive.length,ewes,birthYear,feedYear,feedAll,soldYear,revYear,revAll,treatYear,deathYear}
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birthYear').textContent=s.birthYear;
  byId('s_feedYear').textContent=money(s.feedYear);
  byId('s_soldYear').textContent=s.soldYear;
  byId('s_revYear').textContent=money(s.revYear);
  byId('s_feedAll').textContent=money(s.feedAll);
  byId('s_revAll').textContent=money(s.revAll);
  byId('s_treatYear').textContent=money(s.treatYear);
  byId('s_deathYear').textContent=s.deathYear;
}

/*** الفلترة والـ KPI ***/
function setView(m){byId('viewMode').value=m;renderList();window.scrollTo({top:document.querySelector('.wrap').offsetTop,behavior:'smooth'})}
document.addEventListener('DOMContentLoaded',()=>{
  byId('kpi_birthYear').onclick=()=>setView('newborns');
  byId('kpi_ewes').onclick=()=>setView('ewes')
})

/*** عرض القائمة ***/
function renderList(){
  const q=(byId('q').value||'').trim().toLowerCase();
  const mode=byId('viewMode').value, flt=byId('fltStatus').value;
  let arr=Object.values(DB.sheep);

  if(q){arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q))}

  if(mode==='ewes'){arr=arr.filter(s=>s.sex==='أنثى')}
  else if(mode==='newborns'){arr=arr.filter(s=>s.motherId&&s.motherId!=='')}
  else if(mode==='np'){arr=arr.filter(s=>s.sex==='أنثى'&&!!s.nonProductive)}

  if(flt==='alive')arr=arr.filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  else if(flt==='sold')arr=arr.filter(s=>s.status==='مباعة');

  arr.sort((a,b)=>{if(a.sex!==b.sex)return a.sex==='أنثى'?-1:1;return a.id>b.id?1:-1});

  const box=byId('list'); box.innerHTML='';
  if(!arr.length){box.innerHTML='<div class="item">لا توجد سجلات..</div>';return}

  arr.forEach(s=>{
    const row=document.createElement('div');row.className='item';
    const info=document.createElement('div');info.style.flex='1';

    const title=document.createElement('div');
    title.innerHTML=`<span class="name">${s.id}</span>
      ${s.sex==='أنثى'?'<span class="badge">أم</span>':''}
      ${s.nonProductive?'<span class="badge np">🛑 غير منتجة</span>':''}
      ${s.status==='نافقة'?'<span class="badge dead">نافقة</span>':''}
      ${s.status!=='حية'&&s.status!=='نافقة'?`<span class="badge sold">${s.status}${s.soldPrice!=null?' • '+s.soldPrice+' ر.س':''}</span>`:''}`;
    info.appendChild(title);

    const meta=document.createElement('div');meta.className='meta';
    meta.textContent=`${s.group||'–'} • ${s.sex||'–'} • ${fmt(s.dob)}${s.lastWeight!=null?' • '+s.lastWeight+' كجم':''}`;
    info.appendChild(meta);

    if(s.sex==='أنثى'){
      const packs=groupByBirthDate(s.id);const wrap=document.createElement('div');wrap.className='children';
      wrap.innerHTML=`<h4>مواليد ${packs.length?'':'— لا يوجد'}</h4>`;
      packs.forEach(([date,kids])=>{
        const line=document.createElement('div');line.style.margin='6px 0';
        line.innerHTML=`<div class="meta">دفعة ${fmt(date)} (${kids.length})</div>`;
        const rowKids=document.createElement('div');rowKids.className='kids';
        kids.forEach(k=>{const b=document.createElement('span');b.className='kid';b.textContent=`${k.id} • ${k.sex||'—'}`;rowKids.appendChild(b)})
        line.appendChild(rowKids);wrap.appendChild(line);
      });
      info.appendChild(wrap);
    }

    const ctr=document.createElement('div');ctr.className='controls';
    if(s.sex==='أنثى'&&s.status!=='مباعة'&&s.status!=='نافقة'){
      const b1=btn('+ مولود',()=>addChild(s.id));
      const b2=btn('توأم +',()=>addTwin(s.id));
      const b3=btn('+ متعدد',()=>addMany(s.id));
      ctr.append(b1,b2,b3);
    }
    if(s.status!=='نافقة') ctr.append(btn('⚖️ وزن',()=>setWeight(s.id)));
    ctr.append(
      btn('علاج 💊',()=>addTreatment(s.id)),
      btn('لقاح 💉',()=>addVaccine(s.id))
    );
    if(s.status!=='نافقة') ctr.append(btn('بيع 💰',()=>sellSheep(s.id),'warn'));
    ctr.append(btn('تعديل',()=>editSheep(s.id)));
    if(s.status!=='نافقة') ctr.append(btn('نفوق ☠️',()=>markDead(s.id),'danger'));
    ctr.append(btn('حذف 🗑',()=>removeSheep(s.id),'danger'));
    info.appendChild(ctr);

    row.appendChild(info); box.appendChild(row);
  });

  function btn(t,fn,cls=''){const b=document.createElement('button');b.className='btn'+(cls?' '+cls:'');b.textContent=t;b.onclick=fn;return b}
}

/*** السجلات ***/
function renderLogs(){
  // ولادات
  const tbB=byId('tblBirths').querySelector('tbody');tbB.innerHTML='';
  DB.events.filter(e=>e.type==='birth').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(e=>{
    const mom=(e.ids||[])[0]||'—';const kids=(e.ids||[]).slice(1).join('، ');
    tbB.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${mom}</td><td>${kids||'—'}</td><td>${e.details||''}</td></tr>`)
  });

  // مبيعات
  const tbS=byId('tblSales').querySelector('tbody');tbS.innerHTML='';
  DB.events.filter(e=>e.type==='movement'&&/بيع/.test(e.details||'')).sort((a,b)=>(b.date||'').localeCompare(a.date||''))
    .forEach(e=>tbS.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${(e.ids||[])[0]||'—'}</td><td>بيع</td><td>${money(+e.amount||0)}</td></tr>`));

  // علف
  const tbF=byId('tblFeed').querySelector('tbody');tbF.innerHTML='';
  DB.finance.filter(f=>f.type==='feed').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const qty=(r.qty==null||r.qty==='')?'—':r.qty;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.desc||'—'}</td><td>${qty}</td><td>${money(r.cost||0)}</td>`;
    const td=document.createElement('td');const b=document.createElement('button');b.className='btn danger';b.textContent='🗑 حذف';b.onclick=()=>deleteFeed(r.id);td.appendChild(b);tr.appendChild(td);
    tbF.appendChild(tr);
  });

  // علاج
  const tbT=byId('tblTreat').querySelector('tbody');tbT.innerHTML='';
  DB.medicals.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(m.date)}</td><td>${m.sheepId}</td><td>${(m.drug||'')+(m.diagnosis?(' — '+m.diagnosis):'')}</td><td>${m.dose||'—'}</td><td>${m.cost==null?'—':money(m.cost)}</td>`;
    const td=document.createElement('td');const b=document.createElement('button');b.className='btn danger';b.textContent='🗑';b.onclick=()=>deleteTreatment(m.id);td.appendChild(b);tr.appendChild(td);
    tbT.appendChild(tr);
  });

  // لقاحات
  const tbV=byId('tblVacc').querySelector('tbody');tbV.innerHTML='';
  DB.vaccines.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(v.date)}</td><td>${v.sheepId}</td><td>${v.vaccine||''}</td><td>${v.dose||'—'}</td><td>${v.notes||'—'}</td>`;
    tbV.appendChild(tr);
  });

  // نفوق
  const tbD=byId('tblDeath').querySelector('tbody');tbD.innerHTML='';
  DB.deaths.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(d.date)}</td><td>${d.sheepId}</td><td>${d.cause||'—'}</td>`;
    tbD.appendChild(tr);
  });
}

/*** تصدير/استيراد وتجربة ***/
function exportDB(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sheep-backup-'+dstr()+'.json';a.click();URL.revokeObjectURL(a.href)}
function importDB(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{DB=JSON.parse(r.result);save();renderList();statsToUI();renderLogs();alert('تم الاستيراد ✅')}catch{alert('ملف غير صالح')}};r.readAsText(f)}
function quickDemo(){
  if(!confirm('تعبئة بيانات تجربة؟'))return;
  DB=seed();
  DB.sheep['500']={id:'500',sex:'أنثى',group:'حري',dob:'2024-12-01',status:'حية',nonProductive:false};
  DB.sheep['500-01']={id:'500-01',sex:'أنثى',group:'مواليد',dob:dstr(),motherId:'500',status:'حية'};
  DB.events.push({type:'birth',ids:['500','500-01'],date:dstr(),details:'1 مولود'});
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date:dstr(),desc:'شعير',qty:150,cost:180});
  DB.medicals.push({id:'med_'+Date.now(),date:dstr(),sheepId:'500',drug:'أوكسيتetracycline',diagnosis:'حمى',dose:'5 مل / مرتين',cost:30});
  DB.vaccines.push({id:'vac_'+Date.now(),date:dstr(),sheepId:'500',vaccine:'طاعون',dose:'2 مل',notes:'وقائي'});
  DB.deaths.push({id:'die_'+(Date.now()+1),date:dstr(),sheepId:'500-01',cause:'حادث'});
  DB.sheep['500-01'].status='نافقة';
  save(); renderList(); statsToUI(); renderLogs();
}

/*** هجرة ولادات مفقودة (مرة واحدة) ***/
(function migrateBirths(){const FLAG=KEY+'-migrated';if(localStorage.getItem(FLAG))return;const seen=new Set(DB.events.filter(e=>e.type==='birth').map(e=>(e.ids||[]).join('|')+'@'+e.date));const buckets={};Object.values(DB.sheep).forEach(s=>{if(s.motherId&&s.dob){const k=s.motherId+'@'+s.dob;(buckets[k]??={mom:s.motherId,date:s.dob,kids:[]}).kids.push(s.id)}});let add=0;Object.values(buckets).forEach(b=>{const key=[b.mom].concat(b.kids).join('|')+'@'+b.date;if(!seen.has(key)){DB.events.push({type:'birth',ids:[b.mom].concat(b.kids),date:b.date,details:`${b.kids.length} مولود (مهاجرة)`});add++}});save();localStorage.setItem(FLAG,'1')})();

/*** تشغيل أولي ***/
renderList();statsToUI();renderLogs();
</script>
</body>
</html>
