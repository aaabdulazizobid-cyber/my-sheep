<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#17a2b8" />
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„ (PWA)</title>

<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icon-192.png" />
<link rel="icon" href="icon-192.png" />

<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--text:#1f2937;--muted:#6b7280;
    --brand:#17a2b8;--brand2:#0ea5a0;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
    --chip:#eef2ff;--line:#e5e7eb;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:10px}
  .topbar{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-radius:10px;padding:10px 12px;margin:10px 0}
  .topbar .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .hint{font-size:12px;color:#d1fae5}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
  .k{background:var(--card);border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:12px}
  .k small{color:var(--muted)}
  .k b{display:block;font-size:20px;margin-top:4px}
  .tools{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
  .btn{border:0;background:#e8f7fb;color:#054;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(.97)}
  .btn.green{background:#d1fae5;color:#065f46}
  .btn.warn{background:#fff7ed;color:#7c2d12}
  .btn.danger{background:#fee2e2;color:#7f1d1d}
  .btn.ghost{background:#f3f4f6;color:#111827}
  .btn.out{background:#eef2ff;color:#3730a3}
  .search{flex:1;min-width:160px}
  .search input{width:100%;padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:12px;margin:12px 0}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .head{display:flex;gap:10px;align-items:center}
  .tag{font-weight:700}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;color:#334155}
  .chip.sold{background:#fff7ed;border-color:#fcd34d}
  .chip.dead{background:#fee2e2;border-color:#fecaca}
  .actions{display:flex;flex-wrap:wrap;gap:6px}
  .child{padding:8px;border:1px dashed var(--line);border-radius:10px;margin-top:6px;background:#fafafa}
  .tabs{display:flex;gap:6px;border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:6px;overflow:auto}
  .tab{padding:6px 10px;border-radius:10px;background:#f3f4f6;cursor:pointer;white-space:nowrap}
  .tab.active{background:#e0f2fe;color:#0c4a6e}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:right}
  .muted{color:var(--muted)}
  /* Bottom sheet */
  .sheet{position:fixed;inset-inline:0;bottom:-100%;background:var(--card);box-shadow:0 -10px 30px rgba(0,0,0,.15);border-radius:16px 16px 0 0;padding:14px;transition:.25s;z-index:50;max-height:92vh;overflow:auto}
  .sheet.show{bottom:0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid .full{grid-column:1/-1}
  input,select,textarea{border:1px solid var(--line);border-radius:10px;padding:9px;background:#fff}
  textarea{min-height:70px}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="title">ğŸ‘ <span>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” <b>Ø´Ø§Ù…Ù„</b></span> <span class="hint">â€¢ Ø§ÙØªØ­ Ø¨Ù€ Safari Ø«Ù… â€œØ¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©â€</span></div>
  </div>

  <!-- KPIs -->
  <div class="kpi">
    <div class="k"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</small><b id="k_total">0</b></div>
    <div class="k"><small>Ø£Ù…Ù‡Ø§Øª</small><b id="k_ewes">0</b></div>
    <div class="k"><small>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø³Ù†Ø©</small><b id="k_ybirth">0</b></div>
    <div class="k"><small>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø³Ù†Ø©</small><b id="k_feed">0</b></div>
    <div class="k"><small>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª Ø³Ù†Ø©</small><b id="k_treat">0</b></div>
    <div class="k"><small>Ø¥ÙŠØ±Ø§Ø¯ Ø³Ù†Ø©</small><b id="k_income">0</b></div>
    <div class="k"><small>Ø§Ù„ÙØ§Ø¦Ø¶ Ø³Ù†Ø©</small><b id="k_profit">0</b></div>
    <div class="k"><small>Ù…Ø¨Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</small><b id="k_soldm">0</b></div>
  </div>

  <!-- Tools -->
  <div class="tools">
    <button class="btn out" onclick="exportDB()">ØªØµØ¯ÙŠØ± ğŸ“¤</button>
    <label class="btn ghost" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯">
      Ø§Ø³ØªÙŠØ±Ø§Ø¯ ğŸ“¥ <input type="file" hidden onchange="importDB(this.files[0])"/>
    </label>

    <button class="btn" onclick="addFeed()">ğŸŒ¾ Ø¹Ù„Ù</button>
    <button class="btn" onclick="addTreatmentGlobal()">ğŸ’Š Ø¹Ù„Ø§Ø¬</button>
    <button class="btn green" onclick="openForm()">Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³ ï¼‹</button>

    <button class="btn ghost" onclick="setFilter('ewesOnly')">Ø§Ù„Ø£Ù…Ù‡Ø§Øª ÙÙ‚Ø·</button>
    <button class="btn ghost" onclick="setFilter('newbornsOnly')">Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ÙÙ‚Ø·</button>
    <button class="btn ghost" onclick="setFilter('aliveOnly')">Ø§Ù„Ø­ÙŠØ© ÙÙ‚Ø·</button>
    <button class="btn ghost" onclick="setFilter('staleEwes')">Ø£Ù…Ù‡Ø§Øª Ø¨Ù„Ø§ ÙˆÙ„Ø§Ø¯Ø© (Ø³Ù†Ø©)</button>

    <div class="search"><input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©..." oninput="render()"/></div>
  </div>

  <!-- animals list -->
  <div id="list"></div>

  <!-- Logs -->
  <div class="card">
    <div class="tabs" id="logTabs"></div>
    <div id="logsView"></div>
  </div>

  <div style="height:70px"></div>
</div>

<!-- Add/Edit sheet -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="row" style="margin-bottom:8px">
    <b id="sheetTitle">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³</b>
    <div class="actions"><button class="btn danger" onclick="closeForm()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button></div>
  </div>

  <div class="grid">
    <label>Ø§Ù„ÙˆØ³Ù…<input id="f_tag" placeholder="Ù…Ø«Ø§Ù„: 406"/></label>
    <label>Ø§Ù„Ø¬Ù†Ø³
      <select id="f_sex">
        <option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option>
      </select>
    </label>
    <label>Ø§Ù„Ø­Ø§Ù„Ø©
      <select id="f_status">
        <option>Ø­ÙŠØ©</option><option>Ù…Ø¨Ø§Ø¹</option><option>Ù†ÙÙˆÙ‚</option>
      </select>
    </label>
    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©<input id="f_group" placeholder="Ø­Ø±ÙŠ / Ù†Ø¹ÙŠÙ…ÙŠ ..."/></label>
    <label>Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)<input id="f_dam" placeholder="ÙˆØ³Ù… Ø§Ù„Ø£Ù… Ø¥Ù† ÙˆØ¬Ø¯"/></label>
    <label>Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)<input id="f_sire" placeholder="ÙˆØ³Ù… Ø§Ù„Ø£Ø¨"/></label>
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯<input id="f_dob" type="date"/></label>
    <label>Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)<input id="f_w" type="number" inputmode="decimal"/></label>
    <label class="full">Ù…Ù„Ø§Ø­Ø¸Ø§Øª<textarea id="f_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea></label>
  </div>

  <div class="row" style="margin-top:8px">
    <div class="actions">
      <button class="btn green" onclick="saveHead()">Ø­ÙØ¸ âœ…</button>
      <button class="btn ghost" onclick="closeForm()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
  <input type="hidden" id="f_id"/>
</div>

<script>
/* ========= Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage ========= */
const KEY='sheepDB_v4';
let DB = load();
const tabs=[
  {id:'feed',   title:'ğŸŒ¾ Ø§Ù„Ø¹Ù„Ù'},
  {id:'treat',  title:'ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª'},
  {id:'sales',  title:'ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª'},
  {id:'deaths', title:'â˜ ï¸ Ø§Ù„Ù†ÙÙˆÙ‚'},
  {id:'year',   title:'ğŸ“Œ Ù…Ù„Ø®Øµ Ø³Ù†Ø©'}
];
let currentTab='feed';
let filterMode='all';

function load(){
  try{
    const x=JSON.parse(localStorage.getItem(KEY)||'{}');
    return Object.assign({
      animals:[], feed:[], treatments:[], sales:[], deaths:[]
    }, x);
  }catch(e){ return {animals:[],feed:[],treatments:[],sales:[],deaths:[]} }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(DB)); }

/* ========= Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ®/Ø¨Ø­Ø« ========= */
const today = ()=>new Date();
const dstr  = (d=today())=>d.toISOString().slice(0,10);
const daysAgo=(n)=>{const d=today(); d.setDate(d.getDate()-n); return d;};
const inLastYear=(ds)=> new Date(ds)>=daysAgo(365);
const inThisMonth=(ds)=>{const d=new Date(ds), n=today(); return d.getFullYear()==n.getFullYear() && d.getMonth()==n.getMonth();};

const byTag = (id)=> DB.animals.find(a=>a.id==id);
const alive = (a)=> a.status!=='Ù…Ø¨Ø§Ø¹' && a.status!=='Ù†ÙÙˆÙ‚';
const isEwe = (a)=> a.sex==='Ø£Ù†Ø«Ù‰';
const lambsOf = (damId)=> DB.animals.filter(a=>a.dam===damId);
const nextChildId=(damId)=>{ const n=lambsOf(damId).length+1; return `${damId}-${String(n).padStart(2,'0')}`; };
const money = (n)=> Number(n||0).toLocaleString('ar-SA');

/* ========= Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª ========= */
function setFilter(f){ filterMode=f; render(); }

function render(){
  let arr=[...DB.animals];
  const q=(document.getElementById('q').value||'').trim();

  if(filterMode==='aliveOnly')   arr=arr.filter(alive);
  if(filterMode==='ewesOnly')    arr=arr.filter(a=>alive(a)&&isEwe(a));
  if(filterMode==='newbornsOnly')arr=arr.filter(a=>a.dam && alive(a));
  if(filterMode==='staleEwes')   arr=arr.filter(a=>alive(a)&&isEwe(a))
                                     .filter(e=>!DB.animals.some(c=>c.dam===e.id && inLastYear(c.dob||'')));

  if(q) arr=arr.filter(a=>(a.id||'').includes(q)||(a.group||'').includes(q)||(a.status||'').includes(q));

  // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
  arr.sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));

  const list=document.getElementById('list');
  if(!arr.length){ list.innerHTML='<div class="card muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>'; stats(); renderLogs(); return; }

  let html='';
  for(const a of arr){
    const chips=[];
    chips.push(`<span class="chip">${a.sex||'-'}</span>`);
    chips.push(`<span class="chip">${a.group||'-'}</span>`);
    if(a.dob) chips.push(`<span class="chip">ÙˆÙ„Ø¯: ${a.dob}</span>`);
    if(a.weight) chips.push(`<span class="chip">ÙˆØ²Ù†: ${a.weight}ÙƒØ¬Ù…</span>`);
    if(a.status==='Ù…Ø¨Ø§Ø¹') chips.push(`<span class="chip sold">Ù…Ø¨Ø§Ø¹</span>`);
    if(a.status==='Ù†ÙÙˆÙ‚') chips.push(`<span class="chip dead">Ù†ÙÙˆÙ‚</span>`);
    if(a.dam) chips.push(`<span class="chip">Ø£Ù…: ${a.dam}</span>`);

    // Ù…ÙˆØ§Ù„ÙŠØ¯
    const kids=lambsOf(a.id).sort((x,y)=>(y.createdAt||'').localeCompare(x.createdAt||''));
    let children='';
    if(kids.length){
      children = `<div class="list">` + kids.map(k=>`
        <div class="child">
          <div class="row">
            <div class="head"><span class="tag">${k.id}</span> <span class="muted">Ù…ÙˆÙ„ÙˆØ¯ ${k.dob||''}</span></div>
            <div class="actions">
              <button class="btn"      onclick="weightPrompt('${k.id}')">ÙˆØ²Ù† âš–ï¸</button>
              <button class="btn warn" onclick="sellPrompt('${k.id}')">Ø¨ÙŠØ¹ ğŸ’°</button>
              <button class="btn danger" onclick="removeHead('${k.id}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>`).join('') + `</div>`;
    }else if(isEwe(a)){
      children = `<div class="muted" style="padding:6px 0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ù„ÙŠØ¯</div>`;
    }

    html+=`
      <div class="card">
        <div class="row">
          <div class="head">
            <span class="tag">${a.id}</span>
            <div class="chips">${chips.join('')}</div>
          </div>
          <div class="actions">
            <button class="btn" onclick="toggleChildren(this)">Ù…ÙˆØ§Ù„ÙŠØ¯ ğŸ‘¶</button>
            ${isEwe(a)? `
              <button class="btn" onclick="quickBirth('${a.id}',1)">+ Ù…ÙˆÙ„ÙˆØ¯</button>
              <button class="btn" onclick="quickBirth('${a.id}',2)">+ ØªÙˆØ£Ù…</button>
              <button class="btn" onclick="multiBirth('${a.id}')">+ Ù…ØªØ¹Ø¯Ø¯</button>`:''}
            <button class="btn" onclick="weightPrompt('${a.id}')">ÙˆØ²Ù† âš–ï¸</button>
            <button class="btn" onclick="openForm('${a.id}')">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
            <button class="btn warn" onclick="sellPrompt('${a.id}')">Ø¨ÙŠØ¹ ğŸ’°</button>
            <button class="btn danger" onclick="removeHead('${a.id}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="children" style="display:none">${children}</div>
      </div>`;
  }
  list.innerHTML=html;

  stats();
  renderLogs();
}
function toggleChildren(btn){
  const box=btn.closest('.card').querySelector('.children');
  box.style.display = (box.style.display==='none') ? 'block' : 'none';
}

/* ========= Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ========= */
function stats(){
  const aliveArr = DB.animals.filter(alive);
  const ewes = aliveArr.filter(isEwe);
  const yBirth = aliveArr.filter(a=>a.dob && inLastYear(a.dob));
  const feedY = DB.feed.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.cost||0),0);
  const trtY  = DB.treatments.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.cost||0),0);
  const incY  = DB.sales.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.price||0),0);
  const soldM = DB.sales.filter(r=>inThisMonth(r.date)).length;

  document.getElementById('k_total').textContent  = aliveArr.length;
  document.getElementById('k_ewes').textContent   = ewes.length;
  document.getElementById('k_ybirth').textContent = yBirth.length;
  document.getElementById('k_feed').textContent   = money(feedY)+' Ø±.Ø³';
  document.getElementById('k_treat').textContent  = money(trtY)+' Ø±.Ø³';
  document.getElementById('k_income').textContent = money(incY)+' Ø±.Ø³';
  document.getElementById('k_profit').textContent = money(incY-(feedY+trtY))+' Ø±.Ø³';
  document.getElementById('k_soldm').textContent  = soldM;
}

/* ========= Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù ========= */
function openForm(id){
  const e=id? byTag(id): null;
  document.getElementById('sheetTitle').textContent = id? ('ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³: '+id): 'Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³';
  document.getElementById('f_id').value = id||'';
  document.getElementById('f_tag').value = e?.id||'';
  document.getElementById('f_sex').value = e?.sex||'Ø£Ù†Ø«Ù‰';
  document.getElementById('f_status').value = e?.status||'Ø­ÙŠØ©';
  document.getElementById('f_group').value = e?.group||'';
  document.getElementById('f_dam').value = e?.dam||'';
  document.getElementById('f_sire').value = e?.sire||'';
  document.getElementById('f_dob').value = e?.dob||'';
  document.getElementById('f_w').value   = e?.weight||'';
  document.getElementById('f_note').value= e?.notes||'';
  document.getElementById('sheet').classList.add('show');
}
function closeForm(){ document.getElementById('sheet').classList.remove('show'); }
function saveHead(){
  const oldId = document.getElementById('f_id').value.trim();
  const obj={
    id: document.getElementById('f_tag').value.trim(),
    sex:document.getElementById('f_sex').value,
    status:document.getElementById('f_status').value,
    group:document.getElementById('f_group').value.trim(),
    dam:document.getElementById('f_dam').value.trim(),
    sire:document.getElementById('f_sire').value.trim(),
    dob:document.getElementById('f_dob').value||'',
    weight:+(document.getElementById('f_w').value||0),
    notes:document.getElementById('f_note').value.trim()
  };
  if(!obj.id) return alert('Ø§Ù„ÙˆØ³Ù… Ù…Ø·Ù„ÙˆØ¨');

  if(oldId){ // ØªØ¹Ø¯ÙŠÙ„
    const e=byTag(oldId); if(!e) return;
    // Ù„Ùˆ ØºÙŠÙ‘Ø± Ø§Ù„ÙˆØ³Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ø§ ÙŠØªØµØ§Ø¯Ù…
    if(oldId!==obj.id && byTag(obj.id)) return alert('ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
    // Ø­Ø¯Ø« Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙˆØ³Ù… (dam)
    DB.animals.forEach(x=>{ if(x.dam===oldId) x.dam=obj.id; });
    Object.assign(e,obj);
    e.id=obj.id;
  }else{ // Ø¥Ø¶Ø§ÙØ©
    if(byTag(obj.id)) return alert('ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
    obj.createdAt=new Date().toISOString();
    DB.animals.push(obj);
  }
  save(); closeForm(); render();
}
function removeHead(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø£Ø³ '+id+' ØŸ')) return;
  DB.animals = DB.animals.filter(a=>a.id!==id);
  // Ø§Ø­Ø°Ù Ø£ÙŠ Ø£Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø£Ø³ ÙƒØ£Ù…
  DB.animals = DB.animals.filter(a=>a.dam!==id);
  save(); render();
}

/* ========= ÙˆÙ„Ø§Ø¯Ø§Øª ========= */
function quickBirth(damId,count=1){
  const dam=byTag(damId); if(!dam) return;
  for(let i=0;i<count;i++){
    const suggested = nextChildId(damId);
    const tag = prompt('ÙˆØ³Ù… Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯', suggested); if(!tag) continue;
    if(byTag(tag)){ alert('ÙˆØ³Ù… Ù…ÙƒØ±Ø±ØŒ ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡'); continue; }
    const sex = prompt('Ø§Ù„Ø¬Ù†Ø³ (Ø£Ù†Ø«Ù‰/Ø°ÙƒØ±):','Ø£Ù†Ø«Ù‰')||'Ø£Ù†Ø«Ù‰';
    DB.animals.push({
      id:tag, sex, status:'Ø­ÙŠØ©', group:dam.group||'',
      dam:damId, sire:dam.sire||'', dob:dstr(),
      weight:0, notes:'', createdAt:new Date().toISOString()
    });
  }
  save(); render();
}
function multiBirth(damId){
  const n= +prompt('Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯:', '3'); if(!n||n<1) return;
  quickBirth(damId,n);
}

/* ========= ÙˆØ²Ù† / Ø¨ÙŠØ¹ / Ù†ÙÙˆÙ‚ ========= */
function weightPrompt(id){
  const a=byTag(id); if(!a) return;
  const w= +prompt('Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„ÙƒÙŠÙ„Ùˆ Ø¬Ø±Ø§Ù…:', a.weight||''); if(!isFinite(w)) return;
  a.weight=w; save(); render();
}
function sellPrompt(id){
  const a=byTag(id); if(!a) return;
  const price= +prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø±ÙŠØ§Ù„):','0'); if(!isFinite(price)) return;
  a.status='Ù…Ø¨Ø§Ø¹';
  DB.sales.push({id:'s'+Date.now(),date:dstr(),sheepId:id,price,detail:''});
  save(); render();
}
function deathPrompt(id){
  const a=byTag(id); if(!a) return;
  if(!confirm('ØªØ³Ø¬ÙŠÙ„ Ù†ÙÙˆÙ‚ Ù„Ù„Ø±Ø£Ø³ '+id+'ØŸ')) return;
  a.status='Ù†ÙÙˆÙ‚';
  DB.deaths.push({id:'d'+Date.now(),date:dstr(),sheepId:id,detail:''});
  save(); render();
}

/* ========= Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ø§Ù…Ø©: Ø§Ù„Ø¹Ù„Ù ÙˆØ§Ù„Ø¹Ù„Ø§Ø¬ ========= */
function addFeed(){
  const date = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (YYYY-MM-DD):', dstr()); if(date===null) return;
  const desc = prompt('Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù†ÙˆØ¹:', ''); if(desc===null) return;
  const qty  = prompt('Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…/Ø´ÙˆØ§Ù„...):', ''); if(qty===null) return;
  const cost = +prompt('Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„):', '0'); if(!isFinite(cost)) return;
  DB.feed.push({id:'f'+Date.now(),date,desc,qty,cost});
  save(); renderLogs(); stats();
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù');
}
function addTreatmentGlobal(){
  const sheepId = prompt('ÙˆØ³Ù… Ø§Ù„Ø±Ø£Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…):','') || '';
  const date    = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù„Ø§Ø¬ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const diagnosis = prompt('Ø§Ù„ØªØ´Ø®ÙŠØµ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:',''); if(diagnosis===null) return;
  const drug = prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ø¬/Ø§Ù„Ø¯ÙˆØ§Ø¡:',''); if(drug===null) return;
  const dose = prompt('Ø§Ù„Ø¬Ø±Ø¹Ø© (Ù…Ø«Ø§Ù„: 5 Ù…Ù„ Ù…Ø±ØªÙŠÙ†):',''); if(dose===null) return;
  const cost = +prompt('Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„):','0'); if(!isFinite(cost)) return;
  DB.treatments.push({id:'t'+Date.now(),date,sheepId:sheepId.trim(),diagnosis,drug,dose,cost});
  save(); renderLogs(); stats();
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ø¬');
}

/* ========= Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª) ========= */
function renderLogs(){
  const tabsBox=document.getElementById('logTabs');
  tabsBox.innerHTML = tabs.map(t=>`<div class="tab ${currentTab===t.id?'active':''}" onclick="currentTab='${t.id}';renderLogs()">${t.title}</div>`).join('');
  const box=document.getElementById('logsView');

  if(currentTab==='feed'){
    const rows=DB.feed.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>`
      <tr>
        <td>${r.date}</td><td>${r.desc||'-'}</td><td>${r.qty||'-'}</td><td>${money(r.cost)}</td>
        <td><button class="btn danger" onclick="delFeed('${r.id}')">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    box.innerHTML=`<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="5" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>`;
  }
  else if(currentTab==='treat'){
    const rows=DB.treatments.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>`
      <tr>
        <td>${r.date}</td><td>${r.sheepId||'-'}</td><td>${r.diagnosis||'-'}</td><td>${r.drug||'-'}</td><td>${r.dose||'-'}</td><td>${money(r.cost)}</td>
        <td><button class="btn danger" onclick="delTreatment('${r.id}')">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    box.innerHTML=`<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th><th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="7" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>`;
  }
  else if(currentTab==='sales'){
    const rows=DB.sales.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>`
      <tr>
        <td>${r.date}</td><td>${r.sheepId}</td><td>${money(r.price)}</td>
        <td><button class="btn danger" onclick="delSale('${r.id}')">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    box.innerHTML=`<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="4" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>`;
  }
  else if(currentTab==='deaths'){
    const rows=DB.deaths.sort((a,b)=>b.date.localeCompare(a.date)).map(r=>`
      <tr>
        <td>${r.date}</td><td>${r.sheepId}</td><td>${r.detail||'-'}</td>
        <td><button class="btn danger" onclick="delDeath('${r.id}')">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    box.innerHTML=`<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="4" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>`;
  }
  else if(currentTab==='year'){
    const feedY = DB.feed.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.cost||0),0);
    const trtY  = DB.treatments.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.cost||0),0);
    const incY  = DB.sales.filter(r=>inLastYear(r.date)).reduce((s,r)=>s+(+r.price||0),0);
    const births= DB.animals.filter(a=>a.dob && inLastYear(a.dob) && alive(a)).length;
    box.innerHTML=`
      <div class="card" style="background:#f0f9ff">
        <div class="kpi">
          <div class="k"><small>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø³Ù†Ø©</small><b>${births}</b></div>
          <div class="k"><small>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø³Ù†Ø©</small><b>${money(feedY)} Ø±.Ø³</b></div>
          <div class="k"><small>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª Ø³Ù†Ø©</small><b>${money(trtY)} Ø±.Ø³</b></div>
          <div class="k"><small>Ø¥ÙŠØ±Ø§Ø¯ Ø³Ù†Ø©</small><b>${money(incY)} Ø±.Ø³</b></div>
          <div class="k"><small>Ø§Ù„ÙØ§Ø¦Ø¶ Ø³Ù†Ø©</small><b>${money(incY-(feedY+trtY))} Ø±.Ø³</b></div>
        </div>
      </div>`;
  }
}
function delFeed(id){ DB.feed=DB.feed.filter(x=>x.id!==id); save(); renderLogs(); stats(); }
function delTreatment(id){ DB.treatments=DB.treatments.filter(x=>x.id!==id); save(); renderLogs(); stats(); }
function delSale(id){ DB.sales=DB.sales.filter(x=>x.id!==id); save(); renderLogs(); stats(); }
function delDeath(id){ DB.deaths=DB.deaths.filter(x=>x.id!==id); save(); renderLogs(); }

/* ========= ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ========= */
function exportDB(){
  const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='sheep_backup_'+dstr()+'.json'; a.click();
}
function importDB(file){
  if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{ DB=JSON.parse(fr.result); save(); render(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); }
    catch(e){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
  };
  fr.readAsText(file);
}

/* ========= ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ + SW ========= */
render();
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
}
</script>
</body>
</html>
