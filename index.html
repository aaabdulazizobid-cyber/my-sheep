<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„ (Ù…Ø­Ù„ÙŠ)</title>
<meta name="theme-color" content="#0ea5e9">
<style>
:root{--ink:#0f172a;--muted:#667085;--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--brand:#0ea5e9;--green:#22c55e;--warn:#f59e0b;--red:#ef4444}
*{box-sizing:border-box}html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Kufi Arabic',Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px;z-index:9}
header .row{display:flex;gap:8px;align-items:center;justify-content:space-between;max-width:1200px;margin:auto}
h1{font-size:18px;margin:0}.tag{font-size:12px;background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:999px}
main{max-width:1200px;margin:12px auto;padding:0 12px 40px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.green{background:var(--green);border-color:var(--green);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.red{background:var(--red);border-color:var(--red);color:#fff}
.grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.stat .k{font-size:12px;color:var(--muted)}.stat .v{font-weight:800;font-size:22px}
.sect{display:none}.sect.active{display:block}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:right;font-size:14px}
input,select,textarea{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
.cols{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
.cols-2{grid-template-columns:repeat(2,1fr)}.cols-3{grid-template-columns:repeat(3,1fr)}
.pill{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.pill .tab{border:1px solid var(--line);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
.pill .tab.active{background:#111827;color:#fff;border-color:#111827}
.stickybar{position:sticky;bottom:0;display:flex;justify-content:flex-end;gap:8px;background:linear-gradient(180deg,rgba(246,247,251,0),#f6f7fb 40%);padding:8px;border-radius:0 0 12px 12px}
.mini{font-size:12px;color:var(--muted)}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.cols{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.grid{grid-template-columns:1fr}.cols,.cols-2,.cols-3{grid-template-columns:1fr}}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>ğŸ‘ Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… <span class="tag">Ù…Ø­Ù„ÙŠ â€¢ Ø¨Ø¯ÙˆÙ† Ù†Øª â€¢ Ø´Ø§Ù…Ù„</span></h1>
    <div class="row">
      <button class="btn" onclick="show('dash')">Ù„ÙˆØ­Ø©</button>
      <button class="btn" onclick="show('flock')">Ø§Ù„Ù‚Ø·ÙŠØ¹</button>
      <button class="btn" onclick="show('events')">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
      <button class="btn" onclick="show('lineage')">Ø§Ù„Ø£Ù†Ø³Ø§Ø¨</button>
      <button class="btn" onclick="show('finance')">Ø§Ù„Ø£Ø¹Ù„Ø§Ù ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ</button>
      <button class="btn" onclick="show('settings')">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>
</header>

<main>
  <!-- Ù„ÙˆØ­Ø© -->
  <section id="dash" class="sect active">
    <div class="grid">
      <div class="card stat"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¤ÙˆØ³ (Ø­ÙŠØ©)</div><div class="v" id="s_total">0</div></div>
      <div class="card stat"><div class="k">Ø£Ù…Ù‡Ø§Øª</div><div class="v" id="s_ewes">0</div></div>
      <div class="card stat"><div class="k">Ù…ÙˆØ§Ù„ÙŠØ¯ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</div><div class="v" id="s_birth30">0</div></div>
      <div class="card stat"><div class="k">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù (30 ÙŠÙˆÙ…)</div><div class="v" id="s_feed30">0</div></div>
    </div>
    <div style="margin:10px 0" class="row">
      <button class="btn primary" onclick="openSheep()">â• Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³</button>
      <button class="btn" onclick="openBirth()">ğŸ¼ ÙˆÙ„Ø§Ø¯Ø©</button>
      <button class="btn" onclick="openVac()">ğŸ’‰ ØªØ·Ø¹ÙŠÙ…</button>
      <button class="btn warn" onclick="openMove()">ğŸ” Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡/Ù†ÙÙˆÙ‚</button>
      <button class="btn" onclick="openWeightQuick()">âš–ï¸ ÙˆØ²Ù†</button>
      <button class="btn green" onclick="openFeed()">ğŸŒ¾ Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ</button>
      <button class="btn" onclick="exportData()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
      <label class="btn" style="cursor:pointer">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept=".json" class="hidden" id="imp" onchange="importData(event)"></label>
    </div>
    <div class="card mini">Ù†ØµÙŠØ­Ø©: Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù€ Safari Ø«Ù… "Ù…Ø´Ø§Ø±ÙƒØ© â†’ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Ù„ÙŠØµÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø©.</div>
  </section>

  <!-- Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <section id="flock" class="sect">
    <div class="card">
      <div class="cols-3">
        <div><label>Ø¨Ø­Ø«</label><input id="q" oninput="renderFlock()" placeholder="ÙˆØ³Ù…/Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø­Ø§Ù„Ø©"></div>
        <div><label>ÙØ±Ø²</label>
          <select id="sort" onchange="renderFlock()">
            <option value="created">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
            <option value="id">Ø§Ù„ÙˆØ³Ù…</option>
            <option value="dob">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</option>
            <option value="group">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
            <option value="status">Ø§Ù„Ø­Ø§Ù„Ø©</option>
          </select>
        </div>
        <div><label>&nbsp;</label><button class="btn primary" onclick="openSheep()">â• Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³</button></div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table" id="tblF">
          <thead><tr><th>#</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th><th>Ø§Ù„Ø£Ù…</th><th>Ø¢Ø®Ø± ÙˆØ²Ù†</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
  <section id="events" class="sect">
    <div class="card">
      <div class="pill" id="evtTabs">
        <div class="tab active" data-t="all" onclick="switchEvt(event)">Ø§Ù„ÙƒÙ„</div>
        <div class="tab" data-t="birth" onclick="switchEvt(event)">ÙˆÙ„Ø§Ø¯Ø©</div>
        <div class="tab" data-t="vaccination" onclick="switchEvt(event)">ØªØ·Ø¹ÙŠÙ…</div>
        <div class="tab" data-t="movement" onclick="switchEvt(event)">Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡</div>
        <div class="tab" data-t="feed" onclick="switchEvt(event)">Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ</div>
        <div class="tab" data-t="weight" onclick="switchEvt(event)">Ø£ÙˆØ²Ø§Ù†</div>
      </div>
      <table class="table" id="tblE"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Ø§Ù„Ø£Ù†Ø³Ø§Ø¨ -->
  <section id="lineage" class="sect">
    <div class="card">
      <div class="cols-2">
        <div><label>ÙÙ„ØªØ±Ø© Ø£Ù… (ÙˆØ³Ù…)</label><input id="motherFilter" oninput="renderLineage()" placeholder="Ù…Ø«Ø§Ù„: 45"></div>
        <div><label>Ø¹Ø±Ø¶</label><select id="linView" onchange="renderLineage()"><option value="table">Ø¬Ø¯ÙˆÙ„</option><option value="trees">Ø£Ø´Ø¬Ø§Ø±</option></select></div>
      </div>
      <div id="linWrap" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Ø§Ù„Ø£Ø¹Ù„Ø§Ù ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
  <section id="finance" class="sect">
    <div class="grid">
      <div class="card">
        <h3 style="margin:4px 0">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ</h3>
        <div class="cols-3">
          <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="f_type"><option>Ø´Ø±Ø§Ø¡ Ø¹Ù„Ù</option><option>ØµØ±Ù Ø¹Ù„Ù</option><option>Ù…ØµØ±ÙˆÙ Ø¢Ø®Ø±</option></select></div>
          <div><label>Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØµÙ</label><input id="f_name" placeholder="Ø´Ø¹ÙŠØ±ØŒ Ø¨Ø±Ø³ÙŠÙ…..."></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="f_date" type="date"></div>
          <div><label>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</label><input id="f_qty" type="number" step="0.01"></div>
          <div><label>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø±ÙŠØ§Ù„)</label><input id="f_cost" type="number" step="0.01"></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="f_notes"></div>
        </div>
        <div class="stickybar"><button class="btn green" onclick="saveFeed()">Ø­ÙØ¸</button></div>
      </div>
      <div class="card">
        <h3 style="margin:4px 0">Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ Ø³Ø±ÙŠØ¹</h3>
        <div class="grid" style="grid-template-columns:repeat(2,1fr)">
          <div class="stat"><div class="k">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù (30 ÙŠÙˆÙ…)</div><div class="v" id="m_feed30">0</div></div>
          <div class="stat"><div class="k">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (30 ÙŠÙˆÙ…)</div><div class="v" id="m_rev30">0</div></div>
          <div class="stat"><div class="k">ØµØ§ÙÙŠ (30 ÙŠÙˆÙ…)</div><div class="v" id="m_net30">0</div></div>
          <div class="stat"><div class="k">ØªÙƒÙ„ÙØ©/Ø±Ø£Ø³ (30 ÙŠÙˆÙ…)</div><div class="v" id="m_perhead">0</div></div>
        </div>
        <p class="mini">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ ÙŠÙØ­Ø³Ø¨ Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª <b>Ø¨ÙŠØ¹</b> Ø§Ù„ØªÙŠ ØªØ³Ø¬Ù„ Ù‚ÙŠÙ…ØªÙ‡Ø§ ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ¹.</p>
      </div>
      <div class="card">
        <h3 style="margin:4px 0">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ù„Ø§Ù/Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
        <table class="table" id="tblFEE"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <section id="settings" class="sect">
    <div class="grid">
      <div class="card">
        <h3 style="margin:4px 0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div class="cols-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</label><input id="farm" oninput="saveSettings()"></div>
          <div><label>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label><input id="groups" oninput="saveSettings()" placeholder="Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹"></div>
        </div>
        <p class="mini">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ Ø¬Ù‡Ø§Ø²Ùƒ (localStorage). Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ±/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.</p>
      </div>
    </div>
  </section>
</main>

<!-- Ø­ÙˆØ§Ø± Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ -->
<dialog id="dlgSheep" style="width:min(760px,96%);border:0;border-radius:12px;padding:0">
  <form method="dialog" onsubmit="return false">
    <div class="card" style="border:0;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³</h3>
        <button class="btn" type="button" onclick="dlgSheep.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="cols">
        <div><label>Ø§Ù„ÙˆØ³Ù…</label><input id="s_id"></div>
        <div><label>Ø§Ù„Ø¬Ù†Ø³</label><select id="s_sex"><option></option><option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option></select></div>
        <div><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><input id="s_group" list="dlGroups"><datalist id="dlGroups"></datalist></div>
        <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="s_status"><option>Ø­ÙŠØ©</option><option>Ù…Ø¨Ø§Ø¹Ø©</option><option>Ù†Ø§ÙÙ‚Ø©</option></select></div>
        <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="s_dob" type="date"></div>
        <div><label>Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="s_mother" placeholder="ÙˆØ³Ù… Ø§Ù„Ø£Ù…"></div>
        <div><label>Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)</label><input id="s_father" placeholder="ÙˆØ³Ù… Ø§Ù„Ø£Ø¨"></div>
        <div><label>Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="s_lastw" type="number" step="0.01"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="s_notes" rows="2"></textarea></div>
      </div>
      <div class="stickybar">
        <button class="btn red" type="button" id="s_del" onclick="delSheep()" style="margin-inline-end:auto">Ø­Ø°Ù</button>
        <button class="btn" type="button" onclick="dlgSheep.close()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" type="button" onclick="saveSheep()">Ø­ÙØ¸</button>
      </div>
    </div>
  </form>
</dialog>

<!-- Ø­ÙˆØ§Ø±Ø§Øª Ù…Ø®ØªØµØ±Ø© -->
<dialog id="dlgBirth" style="width:min(640px,96%);border:0;border-radius:12px;padding:0">
  <form method="dialog" onsubmit="return false">
    <div class="card" style="border:0;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ğŸ¼ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø©</h3>
        <button class="btn" type="button" onclick="dlgBirth.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="cols-2">
        <div><label>Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="b_mom"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</label><input id="b_cnt" type="number" min="1" value="1"></div>
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="b_date" type="date"></div>
        <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="b_notes"></div>
      </div>
      <div class="stickybar"><button class="btn primary" type="button" onclick="saveBirth()">Ø­ÙØ¸</button></div>
    </div>
  </form>
</dialog>

<dialog id="dlgVac" style="width:min(720px,96%);border:0;border-radius:12px;padding:0">
  <form method="dialog" onsubmit="return false">
    <div class="card" style="border:0;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ğŸ’‰ ØªØ³Ø¬ÙŠÙ„ ØªØ·Ø¹ÙŠÙ…</h3>
        <button class="btn" type="button" onclick="dlgVac.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="cols-3">
        <div><label>Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label><input id="v_ids" placeholder="12, 45, 78"></div>
        <div><label>Ø§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­</label><input id="v_name"></div>
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="v_date" type="date"></div>
        <div><label>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</label><input id="v_next" type="date"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="v_notes"></div>
      </div>
      <div class="stickybar"><button class="btn primary" type="button" onclick="saveVac()">Ø­ÙØ¸</button></div>
    </div>
  </form>
</dialog>

<dialog id="dlgMove" style="width:min(720px,96%);border:0;border-radius:12px;padding:0">
  <form method="dialog" onsubmit="return false">
    <div class="card" style="border:0;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ğŸ” Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡/Ù†ÙÙˆÙ‚</h3>
        <button class="btn" type="button" onclick="dlgMove.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="cols-3">
        <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="m_type"><option>Ø¨ÙŠØ¹</option><option>Ø´Ø±Ø§Ø¡</option><option>Ù†ÙÙˆÙ‚</option><option>Ù†Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø©</option></select></div>
        <div><label>Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label><input id="m_ids"></div>
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="m_date" type="date"></div>
        <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±ÙŠØ§Ù„) â€” Ù„Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="m_amt" type="number" step="0.01"></div>
        <div><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù„Ù„Ù€ Ù†Ù‚Ù„)</label><input id="m_to"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="m_notes"></div>
      </div>
      <div class="stickybar"><button class="btn primary" type="button" onclick="saveMove()">Ø­ÙØ¸</button></div>
    </div>
  </form>
</dialog>

<script>
/* ========= Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ========= */
const KEY='sheep_data_v4';
let DB = (()=>{ try{ const t=localStorage.getItem(KEY); return t?JSON.parse(t):null }catch{ return null } })()
   || {sheep:{},events:[],finance:[],settings:{farm:'',groups:'Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹'}};
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(DB)); }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø© Ø£Ùˆ Ù…Ø­Ø¸ÙˆØ±Ø©.'); } }

function byId(x){return document.getElementById(x)}
function dstr(){return new Date().toISOString().slice(0,10)}
function fmt(d){if(!d) return 'â€”'; try{return new Date(d).toLocaleDateString('ar')}catch(e){return d}}
function show(id){document.querySelectorAll('.sect').forEach(s=>s.classList.remove('active')); byId(id).classList.add('active'); if(id==='finance') renderFinance(); if(id==='lineage') renderLineage();}

/* ========= Ù„ÙˆØ­Ø© ========= */
function stats(){
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  const ewes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰').length;
  const since=new Date(); since.setDate(since.getDate()-30);
  const birth30=DB.events.filter(e=>e.type==='birth'&&new Date(e.date)>=since).length;
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  return {total:alive.length, ewes, birth30, feed30}
}
function renderDash(){const s=stats(); byId('s_total').textContent=s.total; byId('s_ewes').textContent=s.ewes; byId('s_birth30').textContent=s.birth30; byId('s_feed30').textContent=s.feed30.toFixed(0)}

/* ========= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ========= */
function renderSettings(){ byId('farm').value=DB.settings.farm||''; byId('groups').value=DB.settings.groups||''; const dl=byId('dlGroups'); dl.innerHTML=''; (DB.settings.groups||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(g=>{const o=document.createElement('option');o.value=g;dl.appendChild(o);}) }
function saveSettings(){DB.settings.farm=byId('farm').value; DB.settings.groups=byId('groups').value; save(); renderSettings()}

/* ========= Ø§Ù„Ù‚Ø·ÙŠØ¹ ========= */
let editing=null;
function renderFlock(){
  const q=(byId('q').value||'').toLowerCase(), sort=byId('sort').value;
  let arr=Object.values(DB.sheep);
  if(q){arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q))}
  arr.sort((a,b)=>{if(sort==='id') return (a.id||'').localeCompare(b.id||''); if(sort==='dob') return (b.dob||'').localeCompare(a.dob||''); if(sort==='group') return (a.group||'').localeCompare(b.group||''); if(sort==='status') return (a.status||'').localeCompare(b.status||''); return (b.createdAt||'').localeCompare(a.createdAt||'')});
  const tb=byId('tblF').querySelector('tbody'); tb.innerHTML='';
  arr.forEach((s,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td><b>${s.id||''}</b></td><td>${s.status||'Ø­ÙŠØ©'}</td><td>${s.sex||''}</td><td>${s.group||''}</td><td>${fmt(s.dob)}</td><td>${s.motherId||''}</td><td>${s.lastWeight!=null?s.lastWeight+' ÙƒØ¬Ù…':'â€”'}</td><td>${s.notes||''}</td><td><button class="btn mini" onclick="editSheep('${s.id}')">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn mini" onclick="quickW('${s.id}')">ÙˆØ²Ù†</button></td>`; tb.appendChild(tr);})
}
function openSheep(){editing=null;['s_id','s_sex','s_group','s_dob','s_mother','s_father','s_lastw','s_notes'].forEach(i=>byId(i).value=''); byId('s_status').value='Ø­ÙŠØ©'; byId('s_del').style.display='none'; byId('dlgSheep').showModal()}
function editSheep(id){const s=DB.sheep[id]; if(!s) return; editing=id; byId('s_id').value=s.id||''; byId('s_sex').value=s.sex||''; byId('s_group').value=s.group||''; byId('s_status').value=s.status||'Ø­ÙŠØ©'; byId('s_dob').value=s.dob||''; byId('s_mother').value=s.motherId||''; byId('s_father').value=s.fatherId||''; byId('s_lastw').value=s.lastWeight!=null?s.lastWeight:''; byId('s_notes').value=s.notes||''; byId('s_del').style.display='inline-flex'; byId('dlgSheep').showModal()}
function saveSheep(){
  const id=(byId('s_id').value||'').trim(); if(!id) return alert('Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØ³Ù…');
  const s={id, sex:byId('s_sex').value||'', group:byId('s_group').value||'', status:byId('s_status').value||'Ø­ÙŠØ©', dob:byId('s_dob').value||'', motherId:byId('s_mother').value||'', fatherId:byId('s_father').value||'', lastWeight: byId('s_lastw').value?parseFloat(byId('s_lastw').value):null, notes:byId('s_notes').value||'', createdAt:DB.sheep[id]?.createdAt||new Date().toISOString(), updatedAt:new Date().toISOString()};
  if(editing&&editing!==id){ if(DB.sheep[id]) return alert('ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯'); delete DB.sheep[editing] }
  DB.sheep[id]=s; save(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'); byId('dlgSheep').close(); renderAll()
}
function delSheep(){if(!editing) return; if(confirm('Ø­Ø°ÙØŸ')){delete DB.sheep[editing]; save(); renderAll(); byId('dlgSheep').close()}}
function quickW(id){const s=DB.sheep[id]; if(!s) return; const v=prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):'); if(v==null) return; const w=parseFloat(v); if(!isFinite(w)) return alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); s.lastWeight=w; s.updatedAt=new Date().toISOString(); DB.events.push({type:'weight',ids:[id],date:dstr(),details:`${w} ÙƒØ¬Ù…`}); save(); renderAll()}

/* ========= Ø§Ù„Ø³Ø¬Ù„Ø§Øª ========= */
function switchEvt(e){document.querySelectorAll('#evtTabs .tab').forEach(t=>t.classList.remove('active')); e.target.classList.add('active'); renderEvents()}
function mapType(t){return ({birth:'ÙˆÙ„Ø§Ø¯Ø©',vaccination:'ØªØ·Ø¹ÙŠÙ…',movement:'Ø­Ø±ÙƒØ©',weight:'ÙˆØ²Ù†',feed:'Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ'})[t]||t}
function renderEvents(){const t=document.querySelector('#evtTabs .tab.active')?.dataset.t||'all'; let arr=DB.events.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')); if(t!=='all') arr=arr.filter(e=>e.type===t); const tb=byId('tblE').querySelector('tbody'); tb.innerHTML=''; arr.forEach(ev=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmt(ev.date)}</td><td>${mapType(ev.type)}</td><td>${(ev.ids||[]).join(', ')||'â€”'}</td><td>${ev.details||'â€”'}</td>`; tb.appendChild(tr);})}

/* ========= Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙƒÙ…Ù„Ø© ========= */
function openBirth(){byId('b_mom').value=''; byId('b_cnt').value='1'; byId('b_date').value=dstr(); byId('b_notes').value=''; byId('dlgBirth').showModal()}
function saveBirth(){const mom=(byId('b_mom').value||'').trim(); const cnt=parseInt(byId('b_cnt').value||'1'); const date=byId('b_date').value||dstr(); const notes=byId('b_notes').value||''; if(!mom) return alert('Ø£Ø¯Ø®Ù„ ÙˆØ³Ù… Ø§Ù„Ø£Ù…'); DB.events.push({type:'birth',ids:[mom],date,details:`${cnt} Ù…ÙˆÙ„ÙˆØ¯ â€” ${notes}`}); save(); renderAll(); byId('dlgBirth').close()}
function openVac(){byId('v_ids').value=''; byId('v_name').value=''; byId('v_date').value=dstr(); byId('v_next').value=''; byId('v_notes').value=''; byId('dlgVac').showModal()}
function saveVac(){const ids=(byId('v_ids').value||'').split(',').map(s=>s.trim()).filter(Boolean); const name=(byId('v_name').value||'').trim(); const date=byId('v_date').value||dstr(); const next=byId('v_next').value||''; const notes=byId('v_notes').value||''; if(!ids.length||!name) return alert('Ø§Ù„ÙˆØ³ÙˆÙ… ÙˆØ§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­'); ids.forEach(id=>{ if(DB.sheep[id]){ DB.sheep[id].vaccinations=(DB.sheep[id].vaccinations||[]); DB.sheep[id].vaccinations.push({name,date,next}); }}); DB.events.push({type:'vaccination',ids,date,details:`${name}${next? ' â€” Ø§Ù„Ù‚Ø§Ø¯Ù…: '+fmt(next):''} ${notes}`}); save(); renderAll(); byId('dlgVac').close()}
function openMove(){byId('m_type').value='Ø¨ÙŠØ¹'; byId('m_ids').value=''; byId('m_date').value=dstr(); byId('m_amt').value=''; byId('m_to').value=''; byId('m_notes').value=''; byId('dlgMove').showModal()}
function saveMove(){const type=byId('m_type').value; const ids=(byId('m_ids').value||'').split(',').map(s=>s.trim()).filter(Boolean); const date=byId('m_date').value||dstr(); const amt=byId('m_amt').value?parseFloat(byId('m_amt').value):null; const to=byId('m_to').value||''; const notes=byId('m_notes').value||''; if(!ids.length) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ³ÙˆÙ…'); ids.forEach(id=>{const s=DB.sheep[id]; if(!s) return; if(type==='Ø¨ÙŠØ¹') s.status='Ù…Ø¨Ø§Ø¹Ø©'; else if(type==='Ø´Ø±Ø§Ø¡') s.status='Ø­ÙŠØ©'; else if(type==='Ù†ÙÙˆÙ‚') s.status='Ù†Ø§ÙÙ‚Ø©'; else if(type==='Ù†Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø©') s.group=to; s.updatedAt=new Date().toISOString();}); let det=type; if(amt!=null) det+=` â€” ${amt} Ø±ÙŠØ§Ù„`; if(type==='Ù†Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø©'&&to) det+=` â€” Ø¥Ù„Ù‰ ${to}`; if(notes) det+=` â€” ${notes}`; DB.events.push({type:'movement',ids,date,details:det,amount:(type==='Ø¨ÙŠØ¹'&&amt)?amt:0}); save(); renderAll(); byId('dlgMove').close()}
function openFeed(){show('finance')}
function saveFeed(){const t=byId('f_type').value, name=byId('f_name').value||'', date=byId('f_date').value||dstr(), qty=byId('f_qty').value?parseFloat(byId('f_qty').value):0, cost=byId('f_cost').value?parseFloat(byId('f_cost').value):0, notes=byId('f_notes').value||''; DB.finance.push({type:t,name,date,qty,cost,notes}); DB.events.push({type:'feed',ids:[],date,details:`${t} â€” ${name} â€” ${qty||0} ÙƒØ¬Ù… â€” ${cost||0} Ø±ÙŠØ§Ù„ ${notes? ' â€” '+notes:''}`}); save(); renderAll(); byId('f_name').value=''; byId('f_qty').value=''; byId('f_cost').value=''; byId('f_notes').value=''}

/* ========= Ø§Ù„Ù…Ø§Ù„ÙŠØ© ========= */
function renderFinance(){
  const tb=byId('tblFEE').querySelector('tbody'); tb.innerHTML='';
  DB.finance.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.type}</td><td>${r.name||'â€”'}</td><td>${r.qty||0}</td><td>${r.cost||0}</td><td>${r.notes||''}</td>`; tb.appendChild(tr);});
  const since=new Date(); since.setDate(since.getDate()-30);
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const rev30=DB.events.filter(e=>e.type==='movement'&&e.details.startsWith('Ø¨ÙŠØ¹')&&new Date(e.date)>=since).reduce((a,b)=>{const m=/Ø¨ÙŠØ¹ â€” ([0-9.]+)/.exec(b.details||''); return a+(m?parseFloat(m[1]):(b.amount||0));},0);
  const net30=rev30-feed30; const alive=Object.values(DB.sheep).filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©').length||1;
  byId('m_feed30').textContent=feed30.toFixed(0); byId('m_rev30').textContent=rev30.toFixed(0); byId('m_net30').textContent=net30.toFixed(0); byId('m_perhead').textContent=(feed30/alive).toFixed(1);
  byId('s_feed30').textContent=feed30.toFixed(0);
}

/* ========= Ø§Ù„Ø£Ù†Ø³Ø§Ø¨ ========= */
function lineage(){const kids={}; for(const s of Object.values(DB.sheep)){const m=(s.motherId||'').trim(); if(!m) continue; (kids[m]=kids[m]||[]).push(s.id)} const births={}; for(const e of DB.events){if(e.type!=='birth') continue; const mom=(e.ids&&e.ids[0])||''; const cnt=parseInt((e.details||'').split(' ')[0],10); births[mom]=births[mom]||{singles:0,multiples:0,total:0}; births[mom].total++; if(cnt===1) births[mom].singles++; else if(cnt>=2) births[mom].multiples++;} const ewes=Object.values(DB.sheep).filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'); const list=ewes.map(e=>{const c=(kids[e.id]||[]); let g=0; c.forEach(x=>{if(kids[x]) g+=kids[x].length}); const b=births[e.id]||{singles:0,multiples:0,total:0}; return {id:e.id,group:e.group,dob:e.dob,children:c,cc:c.length,s:b.singles,m:b.multiples,gc:g}}).sort((a,b)=>b.cc-a.cc); return {kids,list}}
function renderLineage(){const {kids,list}=lineage(); const filter=(byId('motherFilter').value||'').trim(); const rows=list.filter(r=>!filter||(r.id||'').includes(filter)); const view=byId('linView').value; const wrap=byId('linWrap'); wrap.innerHTML=''; if(view==='table'){const t=document.createElement('table'); t.className='table'; t.innerHTML=`<thead><tr><th>Ø§Ù„Ø£Ù…</th><th>Ù…ÙˆØ§Ù„ÙŠØ¯Ù‡Ø§</th><th>Ø¹Ø¯Ø¯</th><th>Ù…ÙØ±Ø¯</th><th>ØªÙˆØ§Ø¦Ù…+</th><th>Ø£Ø­ÙØ§Ø¯</th></tr></thead><tbody></tbody>`; const tb=t.querySelector('tbody'); rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td><b>${r.id}</b><div class="mini">${r.group||''} â€¢ ${fmt(r.dob)}</div></td><td>${r.children.join(', ')||'â€”'}</td><td>${r.cc}</td><td>${r.s}</td><td>${r.m}</td><td>${r.gc}</td>`; tb.appendChild(tr)}); wrap.appendChild(t)} else {rows.forEach(r=>{const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 style="margin:0 0 6px 0">Ø§Ù„Ø£Ù…: ${r.id}</h3>`; const box=document.createElement('div'); function node(id){const div=document.createElement('div'); const ch=(kids[id]||[]); div.innerHTML=`â€¢ <b>${id}</b>${ch.length?' â€” Ø£Ø¨Ù†Ø§Ø¡: '+ch.join(', '):''}`; if(ch.length){const kid=document.createElement('div'); kid.style.marginInlineStart='18px'; kid.style.borderInlineStart='2px dashed #e5e7eb'; kid.style.paddingInlineStart='10px'; ch.forEach(c=>kid.appendChild(node(c))); div.appendChild(kid)} return div} box.appendChild(node(r.id)); card.appendChild(box); wrap.appendChild(card)})}}

/* ========= ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ========= */
function exportData(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sheep-data.json'; a.click()}
function importData(ev){const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{DB=JSON.parse(r.result); save(); renderAll(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…')}catch{alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­')}}; r.readAsText(f)}

/* ========= Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ========= */
function openWeightQuick(){const id=prompt('ÙˆØ³Ù… Ø§Ù„Ø±Ø£Ø³ Ù„ÙˆØ²Ù†Ù‡:'); if(!id) return; quickW(id.trim())}
function renderAll(){renderDash(); renderFlock(); renderEvents(); renderSettings(); if(byId('finance').classList.contains('active')) renderFinance(); if(byId('lineage').classList.contains('active')) renderLineage();}
renderAll();
</script>
</body>
</html>
