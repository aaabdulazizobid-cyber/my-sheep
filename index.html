<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„ (Ø¹Ù„Ø§Ø¬/Ù†ÙÙˆÙ‚/Ù„Ù‚Ø§Ø­Ø§Øª)</title>
<meta name="theme-color" content="#10b981">
<style>
:root{--brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px}
.top h1{margin:0;font-size:18px;font-weight:800}
.wrap{max-width:1000px;margin:auto;padding:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
.kpi b{display:block;font-size:20px}
.kpi span{font-size:12px;color:var(--muted)}
.kpi.click{cursor:pointer;transition:.15s transform}.kpi.click:active{transform:scale(.98)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.section{padding:10px}
.searchbar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.searchbar input,.searchbar select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:13px}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.gray{background:#f3f4f6}
.list .item{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75;margin-inline-start:6px}
.badge.sold{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.badge.np{background:#e5e7eb;border-color:#d1d5db;color:#374151}
.controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.children{margin-top:10px;background:#f9fafb;border:1px dashed var(--line);border-radius:12px;padding:8px}
.children h4{margin:0 0 6px 0;font-size:13px;color:#0f766e}
.kids{display:flex;flex-wrap:wrap;gap:6px}.kid{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:flex-end;justify-content:center;z-index:50}
.modal.open{display:flex}.sheet{background:#fff;width:min(720px,100%);border-radius:16px 16px 0 0;padding:14px;border:1px solid var(--line)}
.sheet h3{margin:0 0 8px 0}.form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.row{display:flex;flex-direction:column}.row label{font-size:12px;color:var(--muted);margin-bottom:4px}
.form input,.form select,.form textarea{padding:10px;border:1px solid var(--line);border-radius:10px}
.form textarea{grid-column:1 / span 2;min-height:70px}.sheet .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
@media(max-width:640px){.form{grid-template-columns:1fr}}
.badge.dead{background:#fde68a;border-color:#fcd34d;color:#92400e}
</style>
</head>
<body>
<div class="top"><h1>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„</h1>
<small>Ø§ÙØªØ­ Ù…Ù† Safari â†’ Ù…Ø´Ø§Ø±ÙƒØ© â†’ Ø£Ø¶ÙÙ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</small></div>

<div class="wrap">
  <!-- KPIs -->
  <div class="grid4">
    <div class="kpi"><b id="s_total">0</b><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</span></div>
    <div class="kpi click" id="kpi_ewes"><b id="s_ewes">0</b><span>Ø£Ù…Ù‡Ø§Øª</span></div>
    <div class="kpi click" id="kpi_birthYear"><b id="s_birthYear">0</b><span>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø³Ù†Ø©</span></div>
    <div class="kpi"><b id="s_feedYear">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø³Ù†Ø©</span></div>
  </div>
  <div class="grid4" style="margin-top:8px">
    <div class="kpi"><b id="s_soldYear">0</b><span>Ù…Ø¨Ø§Ø¹Ø© Ø³Ù†Ø©</span></div>
    <div class="kpi"><b id="s_revYear">0</b><span>Ø¥ÙŠØ±Ø§Ø¯ Ø³Ù†Ø©</span></div>
    <div class="kpi"><b id="s_treatYear">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø³Ù†Ø©</span></div>
    <div class="kpi"><b id="s_deathYear">0</b><span>Ø§Ù„Ù†ÙÙˆÙ‚ Ø³Ù†Ø©</span></div>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª -->
  <div class="card section" style="margin:12px 0;">
    <div class="searchbar">
      <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©â€¦" oninput="renderList()">
      <select id="viewMode" onchange="renderList()">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="ewes">Ø§Ù„Ø£Ù…Ù‡Ø§Øª ÙÙ‚Ø·</option>
        <option value="newborns">Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ÙÙ‚Ø·</option>
        <option value="np">ØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙØ¬Ø©</option>
      </select>
      <select id="fltStatus" onchange="renderList()">
        <option value="alive">Ø§Ù„Ø­ÙŠØ© ÙÙ‚Ø·</option>
        <option value="sold">Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</option>
        <option value="all">Ø§Ù„ÙƒÙ„</option>
      </select>
      <button class="btn solid" onclick="openForm()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³</button>
      <button class="btn" onclick="addFeed()">ğŸ’¸ Ø¹Ù„Ù</button>
      <button class="btn" onclick="exportDB()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
      <label class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept="application/json" style="display:none" onchange="importDB(event)"></label>
      <button class="btn gray" onclick="quickDemo()">ÙˆØ¶Ø¹ ØªØ¬Ø±Ø¨Ø©</button>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div class="card list" id="list"></div>

  <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
  <div class="card section" style="margin-top:12px">
    <h3>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>

    <div style="overflow:auto;margin-top:6px">
      <table class="table" id="tblBirths">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø£Ù…</th><th>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblSales">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„ØªÙØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblFeed">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th></th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblTreat">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø¹Ù„Ø§Ø¬/Ø§Ù„ØªØ´Ø®ÙŠØµ</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th></th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblVacc">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ù„Ù‚Ø§Ø­</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="tblDeath">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead><tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³</h3>
    <div class="form">
      <div class="row"><label>Ø§Ù„ÙˆØ³Ù…</label><input id="f_id" placeholder="Ù…Ø«Ø§Ù„: 406"></div>
      <div class="row"><label>Ø§Ù„Ø¬Ù†Ø³</label>
        <select id="f_sex"><option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option></select></div>
      <div class="row"><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><input id="f_group" placeholder="Ø­Ø±ÙŠ/Ù†Ø¹ÙŠÙ…ÙŠâ€¦"></div>
      <div class="row"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="f_dob" type="date"></div>
      <div class="row"><label>Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="f_mother"></div>
      <div class="row"><label>Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)</label><input id="f_father"></div>
      <div class="row"><label>Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="f_weight" type="number" step="0.1"></div>
      <div class="row"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="f_status"><option>Ø­ÙŠØ©</option><option>Ù…Ø¨Ø§Ø¹Ø©</option><option>Ù†Ø§ÙÙ‚Ø©</option></select></div>
      <div class="row" style="grid-column:1 / span 2">
        <label><input type="checkbox" id="f_np"> Ø£Ù… ØºÙŠØ± Ù…Ù†ØªØ¬Ø©</label>
      </div>
      <div class="row" style="grid-column:1 / span 2">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦"></textarea>
      </div>
    </div>
    <div class="bar">
      <button class="btn" onclick="closeForm()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn solid" onclick="submitForm()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
/*** Ø§Ù„ØªØ®Ø²ÙŠÙ† ***/
const KEY='sheep-db-v10';
let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(KEY))||seed()}catch(e){return seed()}}
function save(){localStorage.setItem(KEY,JSON.stringify(DB))}
function seed(){return{sheep:{},events:[],finance:[],medicals:[],vaccines:[],deaths:[]}}
// Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
// finance: [{id,type:'feed',date,desc,qty,cost}]
// medicals: [{id,date,sheepId,drug,diagnosis,dose,cost}]
// vaccines: [{id,date,sheepId,vaccine,dose,notes}]
// deaths: [{id,date,sheepId,cause}]

const byId=id=>document.getElementById(id);
const dstr=(d=new Date())=>new Date(d).toISOString().slice(0,10);
const money=n=>(+n||0).toLocaleString('ar-SA');
const fmt=d=>!d?'â€”':new Date(d).toLocaleDateString('ar');

/*** Ø£Ø·ÙØ§Ù„ Ø§Ù„Ø£Ù… ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙÙØ¹Ø§Øª ***/
function getChildren(m){return Object.values(DB.sheep).filter(s=>s.motherId===m).sort((a,b)=>a.id>b.id?1:-1)}
function groupByBirthDate(m){const map={};getChildren(m).forEach(k=>{const d=k.dob||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';(map[d]??=[]).push(k)});return Object.entries(map).sort((a,b)=>a[0]>b[0]?-1:1)}

/*** Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ***/
let editingId=null;
function openForm(id=null){
  editingId=id||null;
  if(id){
    const s=DB.sheep[id]; if(!s) return;
    byId('formTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³';
    byId('f_id').value=s.id; byId('f_id').disabled=true;
    byId('f_sex').value=s.sex||'Ø£Ù†Ø«Ù‰';
    byId('f_group').value=s.group||'';
    byId('f_dob').value=s.dob||'';
    byId('f_mother').value=s.motherId||'';
    byId('f_father').value=s.fatherId||'';
    byId('f_weight').value=s.lastWeight??'';
    byId('f_status').value=s.status||'Ø­ÙŠØ©';
    byId('f_notes').value=s.notes||'';
    byId('f_np').checked=!!s.nonProductive;
  }else{
    ['f_id','f_group','f_dob','f_mother','f_father','f_weight','f_notes'].forEach(k=>byId(k).value='');
    byId('f_id').disabled=false; byId('f_sex').value='Ø£Ù†Ø«Ù‰'; byId('f_status').value='Ø­ÙŠØ©'; byId('f_np').checked=false;
    byId('formTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³';
  }
  byId('modal').classList.add('open');
}
function closeForm(){byId('modal').classList.remove('open')}
function submitForm(){
  const rec={
    id:byId('f_id').value.trim(),
    sex:byId('f_sex').value, group:byId('f_group').value.trim(),
    dob:byId('f_dob').value||'', motherId:byId('f_mother').value.trim(),
    fatherId:byId('f_father').value.trim(),
    lastWeight:byId('f_weight').value?+byId('f_weight').value:null,
    status:byId('f_status').value, notes:byId('f_notes').value.trim(),
    nonProductive: byId('f_np').checked
  };
  if(!rec.id){alert('Ø§Ù„ÙˆØ³Ù… Ù…Ø·Ù„ÙˆØ¨');return}
  if(editingId){Object.assign(DB.sheep[editingId],rec,{updatedAt:new Date().toISOString()})}
  else{
    if(DB.sheep[rec.id]){alert('Ø§Ù„ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯');return}
    DB.sheep[rec.id]=Object.assign(rec,{soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})
  }
  save(); closeForm(); renderList(); statsToUI();
}

/*** Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¤ÙˆØ³ ***/
function setWeight(id){const s=DB.sheep[id];if(!s)return;const v=prompt('Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):',s.lastWeight??'');if(v===null)return;const w=parseFloat(v);if(!isFinite(w))return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­');s.lastWeight=w;s.updatedAt=new Date().toISOString();DB.events.push({type:'weight',ids:[id],date:dstr(),details:w+' ÙƒØ¬Ù…'});save();renderList();renderLogs()}
function editSheep(id){openForm(id)}
function removeSheep(id){if(!confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø£Ø³ '+id+'ØŸ'))return;delete DB.sheep[id];DB.events=DB.events.filter(e=>!(e.ids||[]).includes(id));DB.medicals=DB.medicals.filter(x=>x.sheepId!==id);DB.vaccines=DB.vaccines.filter(x=>x.sheepId!==id);DB.deaths=DB.deaths.filter(x=>x.sheepId!==id);save();renderList();statsToUI();renderLogs()}

/*** Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ***/
function addChild(m){const mom=DB.sheep[m];if(!mom)return alert('Ø§Ù„Ø£Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');const i=getChildren(m).length+1;const id=m+'-'+String(i).padStart(2,'0');const date=dstr();DB.sheep[id]={id,sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'Ù…ÙˆÙ„ÙˆØ¯',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.events.push({type:'birth',ids:[m,id],date,details:'1 Ù…ÙˆÙ„ÙˆØ¯'});save();renderList();statsToUI();renderLogs()}
function addTwin(m){const mom=DB.sheep[m];if(!mom)return;const base=getChildren(m).length;const date=dstr();const mk=i=>m+'-'+String(base+i).padStart(2,'0');const a=mk(1),b=mk(2);DB.sheep[a]={id:a,sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.sheep[b]={id:b,sex:'Ø°ÙƒØ±',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};DB.events.push({type:'birth',ids:[m,a,b],date,details:'2 Ù…ÙˆÙ„ÙˆØ¯ (ØªÙˆØ£Ù…)'});save();renderList();statsToUI();renderLogs()}
function addMany(m){const n=+prompt('ÙƒÙ… Ù…ÙˆÙ„ÙˆØ¯ØŸ','3');if(!n||n<=0)return;for(let i=0;i<n;i++)addChild(m)}

/*** Ø§Ù„Ø¨ÙŠØ¹ ***/
function sellSheep(id){const s=DB.sheep[id];if(!s)return;const price=+prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø±ÙŠØ§Ù„):','0');if(isNaN(price))return;const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹ (YYYY-MM-DD):',dstr());if(date===null)return;s.status='Ù…Ø¨Ø§Ø¹Ø©';s.soldPrice=price;s.soldDate=date;s.updatedAt=new Date().toISOString();DB.events.push({type:'movement',ids:[id],date,details:'Ø¨ÙŠØ¹',amount:price});save();renderList();statsToUI();renderLogs()}

/*** Ø¹Ù„Ù ***/
function addFeed(){
  const date=prompt('ØªØ§Ø±ÙŠØ® (YYYY-MM-DD):',dstr());if(date===null)return;
  const desc=prompt('Ø§Ù„ÙˆØµÙ:','Ø¹Ù„Ù');if(desc===null)return;
  const qv=prompt('Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):','');const qty=qv===''?null:+qv;if(qv!==''&&!isFinite(qty))return alert('ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
  const cv=prompt('Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„):','0');if(cv===null)return;const cost=+cv;if(!isFinite(cost))return alert('ØªÙƒÙ„ÙØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date,desc,qty,cost});
  save();statsToUI();renderLogs();alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù âœ…')
}
function deleteFeed(fid){if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù„ÙØŸ'))return;DB.finance=DB.finance.filter(r=>!(r.type==='feed'&&r.id===fid));save();statsToUI();renderLogs()}

/*** Ø¹Ù„Ø§Ø¬ (Ø·Ø¨ÙŠ) ***/
function addTreatment(id){
  if(!DB.sheep[id]) return alert('Ø§Ù„Ø±Ø£Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù„Ø§Ø¬ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const diagnosis=prompt('Ø§Ù„ØªØ´Ø®ÙŠØµ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:',''); if(diagnosis===null) return;
  const drug=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ø¬/Ø§Ù„Ø¯ÙˆØ§Ø¡:',''); if(drug===null) return;
  const dose=prompt('Ø§Ù„Ø¬Ø±Ø¹Ø© (Ù…Ø«Ø§Ù„: 5Ù…Ù„ Ù…Ø±ØªÙŠÙ†):',''); if(dose===null) return;
  const costV=prompt('ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ø§Ø¬ (Ø±ÙŠØ§Ù„) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ:',''); if(costV===null) return;
  const cost= costV===''? null : +costV; if(costV!=='' && !isFinite(cost)) return alert('ØªÙƒÙ„ÙØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
  DB.medicals.push({id:'med_'+Date.now(), date, sheepId:id, drug, diagnosis, dose, cost});
  save(); renderLogs(); statsToUI(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ø¬ âœ…');
}
function deleteTreatment(mid){
  if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù„Ø§Ø¬ØŸ')) return;
  DB.medicals = DB.medicals.filter(m=>m.id!==mid);
  save(); renderLogs(); statsToUI();
}

/*** Ù„Ù‚Ø§Ø­Ø§Øª ***/
function addVaccine(id){
  if(!DB.sheep[id]) return alert('Ø§Ù„Ø±Ø£Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ù‚Ø§Ø­ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const vaccine=prompt('Ø§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­:','Ù„Ù‚Ø§Ø­ Ø·Ø§Ø¹ÙˆÙ†/Ø¬Ø¯Ø±ÙŠâ€¦'); if(vaccine===null) return;
  const dose=prompt('Ø§Ù„Ø¬Ø±Ø¹Ø©:','Ù…Ø«Ø§Ù„: 2 Ù…Ù„'); if(dose===null) return;
  const notes=prompt('Ù…Ù„Ø§Ø­Ø¸Ø§Øª â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ:',''); if(notes===null) return;
  DB.vaccines.push({id:'vac_'+Date.now(), date, sheepId:id, vaccine, dose, notes});
  save(); renderLogs(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ù‚Ø§Ø­ âœ…');
}

/*** Ù†ÙÙˆÙ‚ ***/
function markDead(id){
  const s=DB.sheep[id]; if(!s) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙÙˆÙ‚ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const cause=prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù†ÙÙˆÙ‚ â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ:',''); if(cause===null) return;
  s.status='Ù†Ø§ÙÙ‚Ø©'; s.updatedAt=new Date().toISOString();
  DB.deaths.push({id:'die_'+Date.now(), date, sheepId:id, cause});
  DB.events.push({type:'movement', ids:[id], date, details:'Ù†ÙÙˆÙ‚', amount:0});
  save(); renderList(); renderLogs(); statsToUI();
}

/*** Ø¥Ø­ØµØ§Ø¡Ø§Øª ***/
function getStats(){
  const since=new Date();since.setDate(since.getDate()-365);
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  const ewes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰').length;
  const birthYear=Object.values(DB.sheep).filter(s=>s.dob&&new Date(s.dob)>=since).length;

  const feedYear=DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const feedAll=DB.finance.filter(f=>f.type==='feed').reduce((a,b)=>a+(+b.cost||0),0);

  const soldYearEv=DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')&&new Date(e.date)>=since);
  const soldYear=soldYearEv.length; const revYear=soldYearEv.reduce((a,e)=>a+(+e.amount||0),0);
  const revAll=DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')).reduce((a,e)=>a+(+e.amount||0),0);

  const treatYear=DB.medicals.filter(m=>new Date(m.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const deathYear=DB.deaths.filter(d=>new Date(d.date)>=since).length;

  return{total:alive.length,ewes,birthYear,feedYear,feedAll,soldYear,revYear,revAll,treatYear,deathYear}
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birthYear').textContent=s.birthYear;
  byId('s_feedYear').textContent=money(s.feedYear);
  byId('s_soldYear').textContent=s.soldYear;
  byId('s_revYear').textContent=money(s.revYear);
  byId('s_feedAll').textContent=money(s.feedAll);
  byId('s_revAll').textContent=money(s.revAll);
  byId('s_treatYear').textContent=money(s.treatYear);
  byId('s_deathYear').textContent=s.deathYear;
}

/*** Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ù€ KPI ***/
function setView(m){byId('viewMode').value=m;renderList();window.scrollTo({top:document.querySelector('.wrap').offsetTop,behavior:'smooth'})}
document.addEventListener('DOMContentLoaded',()=>{
  byId('kpi_birthYear').onclick=()=>setView('newborns');
  byId('kpi_ewes').onclick=()=>setView('ewes')
})

/*** Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ***/
function renderList(){
  const q=(byId('q').value||'').trim().toLowerCase();
  const mode=byId('viewMode').value, flt=byId('fltStatus').value;
  let arr=Object.values(DB.sheep);

  if(q){arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q))}

  if(mode==='ewes'){arr=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰')}
  else if(mode==='newborns'){arr=arr.filter(s=>s.motherId&&s.motherId!=='')}
  else if(mode==='np'){arr=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'&&!!s.nonProductive)}

  if(flt==='alive')arr=arr.filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  else if(flt==='sold')arr=arr.filter(s=>s.status==='Ù…Ø¨Ø§Ø¹Ø©');

  arr.sort((a,b)=>{if(a.sex!==b.sex)return a.sex==='Ø£Ù†Ø«Ù‰'?-1:1;return a.id>b.id?1:-1});

  const box=byId('list'); box.innerHTML='';
  if(!arr.length){box.innerHTML='<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª..</div>';return}

  arr.forEach(s=>{
    const row=document.createElement('div');row.className='item';
    const info=document.createElement('div');info.style.flex='1';

    const title=document.createElement('div');
    title.innerHTML=`<span class="name">${s.id}</span>
      ${s.sex==='Ø£Ù†Ø«Ù‰'?'<span class="badge">Ø£Ù…</span>':''}
      ${s.nonProductive?'<span class="badge np">ğŸ›‘ ØºÙŠØ± Ù…Ù†ØªØ¬Ø©</span>':''}
      ${s.status==='Ù†Ø§ÙÙ‚Ø©'?'<span class="badge dead">Ù†Ø§ÙÙ‚Ø©</span>':''}
      ${s.status!=='Ø­ÙŠØ©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©'?`<span class="badge sold">${s.status}${s.soldPrice!=null?' â€¢ '+s.soldPrice+' Ø±.Ø³':''}</span>`:''}`;
    info.appendChild(title);

    const meta=document.createElement('div');meta.className='meta';
    meta.textContent=`${s.group||'â€“'} â€¢ ${s.sex||'â€“'} â€¢ ${fmt(s.dob)}${s.lastWeight!=null?' â€¢ '+s.lastWeight+' ÙƒØ¬Ù…':''}`;
    info.appendChild(meta);

    if(s.sex==='Ø£Ù†Ø«Ù‰'){
      const packs=groupByBirthDate(s.id);const wrap=document.createElement('div');wrap.className='children';
      wrap.innerHTML=`<h4>Ù…ÙˆØ§Ù„ÙŠØ¯ ${packs.length?'':'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</h4>`;
      packs.forEach(([date,kids])=>{
        const line=document.createElement('div');line.style.margin='6px 0';
        line.innerHTML=`<div class="meta">Ø¯ÙØ¹Ø© ${fmt(date)} (${kids.length})</div>`;
        const rowKids=document.createElement('div');rowKids.className='kids';
        kids.forEach(k=>{const b=document.createElement('span');b.className='kid';b.textContent=`${k.id} â€¢ ${k.sex||'â€”'}`;rowKids.appendChild(b)})
        line.appendChild(rowKids);wrap.appendChild(line);
      });
      info.appendChild(wrap);
    }

    const ctr=document.createElement('div');ctr.className='controls';
    if(s.sex==='Ø£Ù†Ø«Ù‰'&&s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©'){
      const b1=btn('+ Ù…ÙˆÙ„ÙˆØ¯',()=>addChild(s.id));
      const b2=btn('ØªÙˆØ£Ù… +',()=>addTwin(s.id));
      const b3=btn('+ Ù…ØªØ¹Ø¯Ø¯',()=>addMany(s.id));
      ctr.append(b1,b2,b3);
    }
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('âš–ï¸ ÙˆØ²Ù†',()=>setWeight(s.id)));
    ctr.append(
      btn('Ø¹Ù„Ø§Ø¬ ğŸ’Š',()=>addTreatment(s.id)),
      btn('Ù„Ù‚Ø§Ø­ ğŸ’‰',()=>addVaccine(s.id))
    );
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('Ø¨ÙŠØ¹ ğŸ’°',()=>sellSheep(s.id),'warn'));
    ctr.append(btn('ØªØ¹Ø¯ÙŠÙ„',()=>editSheep(s.id)));
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('Ù†ÙÙˆÙ‚ â˜ ï¸',()=>markDead(s.id),'danger'));
    ctr.append(btn('Ø­Ø°Ù ğŸ—‘',()=>removeSheep(s.id),'danger'));
    info.appendChild(ctr);

    row.appendChild(info); box.appendChild(row);
  });

  function btn(t,fn,cls=''){const b=document.createElement('button');b.className='btn'+(cls?' '+cls:'');b.textContent=t;b.onclick=fn;return b}
}

/*** Ø§Ù„Ø³Ø¬Ù„Ø§Øª ***/
function renderLogs(){
  // ÙˆÙ„Ø§Ø¯Ø§Øª
  const tbB=byId('tblBirths').querySelector('tbody');tbB.innerHTML='';
  DB.events.filter(e=>e.type==='birth').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(e=>{
    const mom=(e.ids||[])[0]||'â€”';const kids=(e.ids||[]).slice(1).join('ØŒ ');
    tbB.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${mom}</td><td>${kids||'â€”'}</td><td>${e.details||''}</td></tr>`)
  });

  // Ù…Ø¨ÙŠØ¹Ø§Øª
  const tbS=byId('tblSales').querySelector('tbody');tbS.innerHTML='';
  DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')).sort((a,b)=>(b.date||'').localeCompare(a.date||''))
    .forEach(e=>tbS.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${(e.ids||[])[0]||'â€”'}</td><td>Ø¨ÙŠØ¹</td><td>${money(+e.amount||0)}</td></tr>`));

  // Ø¹Ù„Ù
  const tbF=byId('tblFeed').querySelector('tbody');tbF.innerHTML='';
  DB.finance.filter(f=>f.type==='feed').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const qty=(r.qty==null||r.qty==='')?'â€”':r.qty;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.desc||'â€”'}</td><td>${qty}</td><td>${money(r.cost||0)}</td>`;
    const td=document.createElement('td');const b=document.createElement('button');b.className='btn danger';b.textContent='ğŸ—‘ Ø­Ø°Ù';b.onclick=()=>deleteFeed(r.id);td.appendChild(b);tr.appendChild(td);
    tbF.appendChild(tr);
  });

  // Ø¹Ù„Ø§Ø¬
  const tbT=byId('tblTreat').querySelector('tbody');tbT.innerHTML='';
  DB.medicals.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(m.date)}</td><td>${m.sheepId}</td><td>${(m.drug||'')+(m.diagnosis?(' â€” '+m.diagnosis):'')}</td><td>${m.dose||'â€”'}</td><td>${m.cost==null?'â€”':money(m.cost)}</td>`;
    const td=document.createElement('td');const b=document.createElement('button');b.className='btn danger';b.textContent='ğŸ—‘';b.onclick=()=>deleteTreatment(m.id);td.appendChild(b);tr.appendChild(td);
    tbT.appendChild(tr);
  });

  // Ù„Ù‚Ø§Ø­Ø§Øª
  const tbV=byId('tblVacc').querySelector('tbody');tbV.innerHTML='';
  DB.vaccines.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(v.date)}</td><td>${v.sheepId}</td><td>${v.vaccine||''}</td><td>${v.dose||'â€”'}</td><td>${v.notes||'â€”'}</td>`;
    tbV.appendChild(tr);
  });

  // Ù†ÙÙˆÙ‚
  const tbD=byId('tblDeath').querySelector('tbody');tbD.innerHTML='';
  DB.deaths.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(d.date)}</td><td>${d.sheepId}</td><td>${d.cause||'â€”'}</td>`;
    tbD.appendChild(tr);
  });
}

/*** ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ¬Ø±Ø¨Ø© ***/
function exportDB(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sheep-backup-'+dstr()+'.json';a.click();URL.revokeObjectURL(a.href)}
function importDB(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{DB=JSON.parse(r.result);save();renderList();statsToUI();renderLogs();alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…')}catch{alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­')}};r.readAsText(f)}
function quickDemo(){
  if(!confirm('ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±Ø¨Ø©ØŸ'))return;
  DB=seed();
  DB.sheep['500']={id:'500',sex:'Ø£Ù†Ø«Ù‰',group:'Ø­Ø±ÙŠ',dob:'2024-12-01',status:'Ø­ÙŠØ©',nonProductive:false};
  DB.sheep['500-01']={id:'500-01',sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:dstr(),motherId:'500',status:'Ø­ÙŠØ©'};
  DB.events.push({type:'birth',ids:['500','500-01'],date:dstr(),details:'1 Ù…ÙˆÙ„ÙˆØ¯'});
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date:dstr(),desc:'Ø´Ø¹ÙŠØ±',qty:150,cost:180});
  DB.medicals.push({id:'med_'+Date.now(),date:dstr(),sheepId:'500',drug:'Ø£ÙˆÙƒØ³ÙŠØªetracycline',diagnosis:'Ø­Ù…Ù‰',dose:'5 Ù…Ù„ / Ù…Ø±ØªÙŠÙ†',cost:30});
  DB.vaccines.push({id:'vac_'+Date.now(),date:dstr(),sheepId:'500',vaccine:'Ø·Ø§Ø¹ÙˆÙ†',dose:'2 Ù…Ù„',notes:'ÙˆÙ‚Ø§Ø¦ÙŠ'});
  DB.deaths.push({id:'die_'+(Date.now()+1),date:dstr(),sheepId:'500-01',cause:'Ø­Ø§Ø¯Ø«'});
  DB.sheep['500-01'].status='Ù†Ø§ÙÙ‚Ø©';
  save(); renderList(); statsToUI(); renderLogs();
}

/*** Ù‡Ø¬Ø±Ø© ÙˆÙ„Ø§Ø¯Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ***/
(function migrateBirths(){const FLAG=KEY+'-migrated';if(localStorage.getItem(FLAG))return;const seen=new Set(DB.events.filter(e=>e.type==='birth').map(e=>(e.ids||[]).join('|')+'@'+e.date));const buckets={};Object.values(DB.sheep).forEach(s=>{if(s.motherId&&s.dob){const k=s.motherId+'@'+s.dob;(buckets[k]??={mom:s.motherId,date:s.dob,kids:[]}).kids.push(s.id)}});let add=0;Object.values(buckets).forEach(b=>{const key=[b.mom].concat(b.kids).join('|')+'@'+b.date;if(!seen.has(key)){DB.events.push({type:'birth',ids:[b.mom].concat(b.kids),date:b.date,details:`${b.kids.length} Ù…ÙˆÙ„ÙˆØ¯ (Ù…Ù‡Ø§Ø¬Ø±Ø©)`});add++}});save();localStorage.setItem(FLAG,'1')})();

/*** ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ***/
renderList();statsToUI();renderLogs();
</script>
</body>
</html>
