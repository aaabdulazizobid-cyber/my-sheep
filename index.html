<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„</title>
<meta name="theme-color" content="#10b981">
<style>
:root{
  --brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px}
.top h1{margin:0;font-size:18px;font-weight:800}
.top small{opacity:.95;font-size:12px}
.wrap{max-width:980px;margin:auto;padding:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
.kpi b{display:block;font-size:20px}
.kpi span{font-size:12px;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.list .item{display:flex;align-items:flex-start;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75;margin-inline-start:6px}
.badge.sold{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;font-size:13px}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.gray{background:#f3f4f6}
.controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.children{margin-top:10px;background:#f9fafb;border:1px dashed var(--line);border-radius:12px;padding:8px}
.children h4{margin:0 0 6px 0;font-size:13px;color:#0f766e}
.kids{display:flex;flex-wrap:wrap;gap:6px}
.kid{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
.footer{height:56px}
.searchbar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.searchbar input, .searchbar select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.collapsable h3{margin:0;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.section{padding:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
@media(max-width:720px){.grid4{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="top">
    <h1>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„</h1>
    <small>Tip: Ø§ÙØªØ­ Ù…Ù† Safari â† Ù…Ø´Ø§Ø±ÙƒØ© â† Ø£Ø¶ÙÙ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© âœ…</small>
  </div>

  <div class="wrap">
    <!-- KPIs Ø§Ù„ØµÙ 1 -->
    <div class="grid4">
      <div class="kpi"><b id="s_total">0</b><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</span></div>
      <div class="kpi"><b id="s_ewes">0</b><span>Ø£Ù…Ù‘Ù‡Ø§Øª</span></div>
      <div class="kpi"><b id="s_birthYear">0</b><span>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø³Ù†Ø©</span></div>
      <div class="kpi"><b id="s_feedYear">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø³Ù†Ø©</span></div>
    </div>
    <!-- KPIs Ø§Ù„ØµÙ 2 -->
    <div class="grid4" style="margin-top:8px">
      <div class="kpi"><b id="s_soldYear">0</b><span>Ù…Ø¨Ø§Ø¹Ø© Ø³Ù†Ø©</span></div>
      <div class="kpi"><b id="s_revYear">0</b><span>Ø¥ÙŠØ±Ø§Ø¯ Ø³Ù†Ø©</span></div>
      <div class="kpi"><b id="s_feedAll">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></div>
      <div class="kpi"><b id="s_revAll">0</b><span>Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></div>
    </div>

    <!-- Ø¨Ø­Ø« / ÙÙ„Ø§ØªØ± + Ø£Ø²Ø±Ø§Ø± -->
    <div class="card section" style="margin:12px 0;">
      <div class="searchbar">
        <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©â€¦" oninput="renderList()">
        <select id="onlyEwes" onchange="renderList()">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="1">Ø§Ù„Ø£Ù…Ù‡Ø§Øª ÙÙ‚Ø·</option>
        </select>
        <select id="fltStatus" onchange="renderList()">
          <option value="alive">Ø§Ù„Ø­ÙŠØ© ÙÙ‚Ø·</option>
          <option value="sold">Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>
        <button class="btn solid" onclick="addSheep()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³</button>
        <button class="btn" onclick="addFeed()">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ù</button>
        <button class="btn" onclick="exportDB()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <label class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept="application/json" style="display:none" onchange="importDB(event)"></label>
        <button class="btn gray" onclick="quickDemo()">ÙˆØ¶Ø¹ ØªØ¬Ø±Ø¨Ø©</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <div class="card list" id="list"></div>

    <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
    <div class="card section collapsable" style="margin-top:12px">
      <h3 onclick="toggleLogs()">
        Ø§Ù„Ø³Ø¬Ù„Ø§Øª (ÙˆÙ„Ø§Ø¯Ø§Øª / Ù…Ø¨ÙŠØ¹Ø§Øª / Ø¹Ù„Ù)
        <span id="logsChevron">â–¼</span>
      </h3>
      <div id="logs" style="margin-top:8px">
        <div style="overflow:auto;margin-top:6px">
          <table class="table" id="tblBirths">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø£Ù…</th><th>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="overflow:auto;margin-top:12px">
          <table class="table" id="tblSales">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„ØªÙØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="overflow:auto;margin-top:12px">
          <table class="table" id="tblFeed">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±.Ø³)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer"></div>
  </div>

<script>
/* ========= Ø§Ù„ØªØ®Ø²ÙŠÙ† ========= */
const KEY='sheep-db-v5';
let DB = load();

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || seed() }catch(e){ return seed() }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(DB)) }
function seed(){ return { sheep:{}, events:[], finance:[] } }

/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
const dstr = (d=new Date()) => new Date(d).toISOString().slice(0,10);
const money = n => (+n||0).toLocaleString('ar-SA');
const byId = id => document.getElementById(id);
function fmt(d){ if(!d) return 'â€”'; try{ return new Date(d).toLocaleDateString('ar') }catch{ return d } }
function promptNum(msg, def=''){ const v=prompt(msg, def); return v===null?null:+v }
function getChildren(momId){
  return Object.values(DB.sheep).filter(s=>s.motherId===momId).sort((a,b)=> (a.id>b.id?1:-1));
}
function groupByBirthDate(momId){
  const kids = getChildren(momId);
  const map = {};
  kids.forEach(k=>{
    const d = k.dob || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    (map[d] ||= []).push(k);
  });
  return Object.entries(map).sort((a,b)=>a[0]>b[0]? -1 : 1); // Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
}

/* ========= Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/ÙˆØ²Ù†/Ø­Ø°Ù ========= */
function addSheep(){
  const id = prompt('ÙˆØ³Ù… Ø§Ù„Ø±Ø£Ø³ (Ù…Ø«Ø§Ù„ 406):'); if(!id) return;
  if(DB.sheep[id]){ alert('Ø§Ù„ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯'); return }
  const sex = prompt('Ø§Ù„Ø¬Ù†Ø³: Ø£Ù†Ø«Ù‰/Ø°ÙƒØ±','Ø£Ù†Ø«Ù‰')||'Ø£Ù†Ø«Ù‰';
  const group = prompt('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©','')||'';
  const dob = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (YYYY-MM-DD)', dstr())||'';
  DB.sheep[id] = {
    id, sex, group, dob, lastWeight:null,
    motherId:'', fatherId:'', notes:'',
    status:'Ø­ÙŠØ©', soldPrice:null, soldDate:'',
    createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
  };
  save(); renderList(); statsToUI(); renderLogs();
}

function editSheep(id){
  const s = DB.sheep[id]; if(!s) return;
  const sex = prompt('Ø§Ù„Ø¬Ù†Ø³', s.sex)||s.sex;
  const group = prompt('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', s.group||'')||'';
  const dob = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (YYYY-MM-DD)', s.dob||'')||'';
  const notes = prompt('Ù…Ù„Ø§Ø­Ø¸Ø§Øª', s.notes||'')||'';
  Object.assign(s,{sex,group,dob,notes,updatedAt:new Date().toISOString()});
  save(); renderList(); statsToUI();
}

function setWeight(id){
  const s=DB.sheep[id]; if(!s) return;
  const v=prompt('Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):', s.lastWeight??''); if(v===null) return;
  const w=parseFloat(v); if(!isFinite(w)) return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight', ids:[id], date:dstr(), details:`${w} ÙƒØ¬Ù…`});
  save(); renderList(); renderLogs();
}

function removeSheep(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø£Ø³ '+id+'ØŸ')) return;
  delete DB.sheep[id];
  DB.events = DB.events.filter(e => !(e.ids||[]).includes(id));
  save(); renderList(); statsToUI(); renderLogs();
}

/* ========= Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ========= */
function addChild(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…'); return; }
  const next = getChildren(momId).length + 1;
  const id   = momId + '-' + String(next).padStart(2,'0');
  const date = dstr();

  DB.sheep[id] = {
    id, sex:'Ø£Ù†Ø«Ù‰', group:'Ù…ÙˆØ§Ù„ÙŠØ¯', dob:date, lastWeight:null,
    motherId:momId, fatherId:mom.fatherId||'', notes:'Ù…ÙˆÙ„ÙˆØ¯ Ù…Ù† Ø§Ù„Ø£Ù… '+momId,
    status:'Ø­ÙŠØ©', soldPrice:null, soldDate:'',
    createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
  };
  DB.events.push({type:'birth', ids:[momId,id], date, details:'1 Ù…ÙˆÙ„ÙˆØ¯'});
  save(); renderList(); statsToUI(); renderLogs();
}

function addTwin(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…'); return; }
  const base = getChildren(momId).length;
  const date = dstr();
  const makeId = i => momId + '-' + String(base + i).padStart(2,'0');

  const a = makeId(1), b = makeId(2);
  DB.sheep[a] = {id:a,sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,lastWeight:null,motherId:momId,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.sheep[b] = {id:b,sex:'Ø°ÙƒØ±', group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,lastWeight:null,motherId:momId,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.events.push({type:'birth', ids:[momId,a,b], date, details:'2 Ù…ÙˆÙ„ÙˆØ¯ (ØªÙˆØ£Ù…)'});
  save(); renderList(); statsToUI(); renderLogs();
}

function addMany(momId){
  const n = promptNum('ÙƒÙ… Ù…ÙˆÙ„ÙˆØ¯ ØªÙØ¶ÙŠÙØŸ','3'); if(n==null || n<=0) return;
  for(let i=0;i<n;i++) addChild(momId);
}

/* ========= Ø§Ù„Ø¨ÙŠØ¹ ========= */
function sellSheep(id){
  const s = DB.sheep[id]; if(!s){ alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  const price = promptNum('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø±ÙŠØ§Ù„):','0'); if(price==null) return;
  const date = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹ (YYYY-MM-DD):', dstr()); if(date===null) return;
  s.status='Ù…Ø¨Ø§Ø¹Ø©'; s.soldPrice=+price; s.soldDate=date; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'movement', ids:[id], date, details:'Ø¨ÙŠØ¹', amount:+price});
  save(); renderList(); statsToUI(); renderLogs();
}

/* ========= Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¹Ù„Ù ========= */
function addFeed(){
  const date = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (YYYY-MM-DD):', dstr()); if(date===null) return;
  const desc = prompt('Ø§Ù„ÙˆØµÙ (Ù…Ø«Ø§Ù„: Ø´Ø¹ÙŠØ±/ØªØ¨Ù†/Ø¨Ø±Ø³ÙŠÙ…):','Ø¹Ù„Ù'); if(desc===null) return;
  const qty  = promptNum('Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ:',''); // Ù‚Ø¯ ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©
  const cost = promptNum('Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„:','0'); if(cost==null) return;
  DB.finance.push({type:'feed',date,desc,qty: isNaN(qty)? null : +qty, cost:+cost});
  save(); statsToUI(); renderLogs();
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¹Ù„Ù âœ…');
}

/* ========= Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (Ø³Ù†Ø© + Ø¥Ø¬Ù…Ø§Ù„ÙŠ) ========= */
function getStats(){
  const DAYS = 365;
  const since = new Date(); since.setDate(since.getDate() - DAYS);

  // Ø±Ø¤ÙˆØ³ Ø­ÙŠÙ‘Ø©
  const alive = Object.values(DB.sheep)
    .filter(s => s.status!=='Ù…Ø¨Ø§Ø¹Ø©' && s.status!=='Ù†Ø§ÙÙ‚Ø©');

  const ewes = alive.filter(s => s.sex==='Ø£Ù†Ø«Ù‰').length;

  // Ù…ÙˆØ§Ù„ÙŠØ¯ Ø®Ù„Ø§Ù„ Ø³Ù†Ø© (Ù…Ù† DOB)
  const birthYear = Object.values(DB.sheep).filter(s=>{
    if(!s.dob) return false;
    try{ return new Date(s.dob) >= since }catch(e){ return false }
  }).length;

  // ØªØºØ°ÙŠØ©: Ø³Ù†Ø© + Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const feedYear = DB.finance
    .filter(f => f.type==='feed' && (()=>{ try{ return new Date(f.date) >= since }catch(e){ return false } })())
    .reduce((a,b)=>a+(+b.cost||0),0);
  const feedAll  = DB.finance
    .filter(f => f.type==='feed')
    .reduce((a,b)=>a+(+b.cost||0),0);

  // Ù…Ø¨ÙŠØ¹Ø§Øª: Ø³Ù†Ø© + Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const soldYearEvents = DB.events.filter(e=>{
    if(e.type!=='movement' || !/Ø¨ÙŠØ¹/.test(e.details||'')) return false;
    try{ return new Date(e.date) >= since }catch(e){ return false }
  });
  const soldYear = soldYearEvents.length;
  const revYear  = soldYearEvents.reduce((a,e)=>a+(+e.amount||0),0);

  const soldAllEvents = DB.events.filter(e => e.type==='movement' && /Ø¨ÙŠØ¹/.test(e.details||''));
  const revAll   = soldAllEvents.reduce((a,e)=>a+(+e.amount||0),0);

  return { total: alive.length, ewes, birthYear, feedYear, feedAll, soldYear, revYear, revAll };
}
function statsToUI(){
  const s = getStats();
  byId('s_total').textContent     = s.total;
  byId('s_ewes').textContent      = s.ewes;
  byId('s_birthYear').textContent = s.birthYear;
  byId('s_feedYear').textContent  = money(s.feedYear);
  byId('s_soldYear').textContent  = s.soldYear;
  byId('s_revYear').textContent   = money(s.revYear);
  byId('s_feedAll').textContent   = money(s.feedAll);
  byId('s_revAll').textContent    = money(s.revAll);
}

/* ========= Ø§Ù„Ø¹Ø±Ø¶ ========= */
function renderList(){
  const q = (byId('q').value||'').trim().toLowerCase();
  const onlyEwes = !!byId('onlyEwes').value;
  const flt = byId('fltStatus').value;

  let arr = Object.values(DB.sheep);

  if(q){
    arr = arr.filter(s =>
      (s.id||'').toLowerCase().includes(q) ||
      (s.group||'').toLowerCase().includes(q) ||
      (s.status||'').toLowerCase().includes(q)
    );
  }
  if(onlyEwes) arr = arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰');
  if(flt==='alive') arr = arr.filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  else if(flt==='sold') arr = arr.filter(s=>s.status==='Ù…Ø¨Ø§Ø¹Ø©');

  // Ø§Ù„Ø£Ù…Ù‡Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø­Ø³Ø¨ Ø§Ù„ÙˆØ³Ù…
  arr.sort((a,b)=>{
    if(a.sex!==b.sex) return a.sex==='Ø£Ù†Ø«Ù‰' ? -1 : 1;
    return (a.id>b.id?1:-1);
  });

  const box = byId('list'); box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.. Ø£Ø¶ÙÙ Ø£ÙˆÙ„ Ø±Ø£Ø³</div>'; return; }

  arr.forEach(s=>{
    const div = document.createElement('div'); div.className='item';
    const info = document.createElement('div'); info.style.flex='1';

    const title = document.createElement('div');
    title.innerHTML = `<span class="name">${s.id}</span>
      ${s.sex==='Ø£Ù†Ø«Ù‰'?'<span class="badge">Ø£Ù…</span>':''}
      ${s.status!=='Ø­ÙŠØ©'?`<span class="badge sold">${s.status}${s.soldPrice!=null? ' â€¢ '+s.soldPrice+' Ø±.Ø³':''}</span>`:''}
    `;
    info.appendChild(title);

    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = `${s.group||'â€“'} â€¢ ${s.sex||'â€“'} â€¢ ${fmt(s.dob)}${s.lastWeight!=null?(' â€¢ '+s.lastWeight+' ÙƒØ¬Ù…'):''}`;
    info.appendChild(meta);

    // Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù…
    if(s.sex==='Ø£Ù†Ø«Ù‰'){
      const groups = groupByBirthDate(s.id);
      const wrap = document.createElement('div'); wrap.className='children';
      wrap.innerHTML = `<h4>Ù…ÙˆØ§Ù„ÙŠØ¯ ${groups.length? '' : 'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</h4>`;
      groups.forEach(([date,kids])=>{
        const line = document.createElement('div'); line.style.margin='6px 0';
        const label = document.createElement('div'); label.className='meta';
        label.textContent = `Ø¯ÙØ¹Ø© ${fmt(date)} (${kids.length})`;
        const row = document.createElement('div'); row.className='kids';
        kids.forEach(k=>{
          const b = document.createElement('span'); b.className='kid';
          b.textContent = `${k.id} â€¢ ${k.sex || 'â€”'}`;
          row.appendChild(b);
        });
        line.appendChild(label); line.appendChild(row); wrap.appendChild(line);
      });
      info.appendChild(wrap);
    }

    const ctr = document.createElement('div'); ctr.className='controls';
    if(s.sex==='Ø£Ù†Ø«Ù‰' && s.status!=='Ù…Ø¨Ø§Ø¹Ø©'){
      const b1=document.createElement('button'); b1.className='btn'; b1.textContent='+ Ù…ÙˆÙ„ÙˆØ¯'; b1.onclick=()=>addChild(s.id);
      const b2=document.createElement('button'); b2.className='btn'; b2.textContent='ØªÙˆØ£Ù… +'; b2.onclick=()=>addTwin(s.id);
      const b3=document.createElement('button'); b3.className='btn'; b3.textContent='+ Ù…ØªØ¹Ø¯Ø¯'; b3.onclick=()=>addMany(s.id);
      ctr.append(b1,b2,b3);
    }
    const bw=document.createElement('button'); bw.className='btn'; bw.textContent='âš–ï¸ ÙˆØ²Ù†'; bw.onclick=()=>setWeight(s.id);
    const bs=document.createElement('button'); bs.className='btn warn'; bs.textContent='Ø¨ÙŠØ¹ ğŸ’°'; bs.onclick=()=>sellSheep(s.id);
    const be=document.createElement('button'); be.className='btn'; be.textContent='ØªØ¹Ø¯ÙŠÙ„'; be.onclick=()=>editSheep(s.id);
    const bd=document.createElement('button'); bd.className='btn danger'; bd.textContent='Ø­Ø°Ù ğŸ—‘'; bd.onclick=()=>removeSheep(s.id);
    ctr.append(bw,bs,be,bd);
    info.appendChild(ctr);

    div.appendChild(info);
    box.appendChild(div);
  });
}

/* ========= Ø§Ù„Ø³Ø¬Ù„Ø§Øª ========= */
function toggleLogs(){
  const el=byId('logs'); const ch=byId('logsChevron');
  if(el.style.display==='none'){ el.style.display=''; ch.textContent='â–¼' } else { el.style.display='none'; ch.textContent='â–²' }
}
function renderLogs(){
  // ÙˆÙ„Ø§Ø¯Ø§Øª
  const tbB=byId('tblBirths').querySelector('tbody'); tbB.innerHTML='';
  DB.events.filter(e=>e.type==='birth').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(e=>{
    const tr=document.createElement('tr');
    const mom=(e.ids||[])[0]||'â€”';
    const kids=(e.ids||[]).slice(1).join('ØŒ ');
    tr.innerHTML=`<td>${fmt(e.date)}</td><td>${mom}</td><td>${kids||'â€”'}</td><td>${e.details||''}</td>`;
    tbB.appendChild(tr);
  });
  // Ù…Ø¨ÙŠØ¹Ø§Øª
  const tbS=byId('tblSales').querySelector('tbody'); tbS.innerHTML='';
  DB.events.filter(e=>e.type==='movement' && /Ø¨ÙŠØ¹/.test(e.details||''))
    .sort((a,b)=>(b.date||'').localeCompare(a.date||''))
    .forEach(e=>{
      const id=(e.ids||[])[0]||'â€”';
      const amt=(+e.amount||0);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(e.date)}</td><td>${id}</td><td>Ø¨ÙŠØ¹</td><td>${money(amt)}</td>`;
      tbS.appendChild(tr);
    });
  // Ø¹Ù„Ù
  const tbF=byId('tblFeed').querySelector('tbody'); tbF.innerHTML='';
  DB.finance.filter(f=>f.type==='feed').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.desc||'â€”'}</td><td>${r.qty??'â€”'}</td><td>${money(r.cost||0)}</td>`;
    tbF.appendChild(tr);
  });
}

/* ========= Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± ========= */
function exportDB(){
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='sheep-backup-'+dstr()+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importDB(ev){
  const f=ev.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); renderList(); statsToUI(); renderLogs(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…') }catch(e){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­') } };
  r.readAsText(f);
}

/* ========= ÙˆØ¶Ø¹ ØªØ¬Ø±Ø¨Ø© ========= */
function quickDemo(){
  if(!confirm('ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±Ø¨Ø©ØŸ')) return;
  DB = seed();
  // Ø£Ù… + ØªÙˆØ£Ù… Ø­Ø¯ÙŠØ«
  DB.sheep['406']={id:'406',sex:'Ø£Ù†Ø«Ù‰',group:'Ø­Ø±ÙŠ',dob:'2024-04-10',status:'Ø­ÙŠØ©',motherId:'',fatherId:'',notes:'',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.sheep['406-01']={id:'406-01',sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:dstr(),motherId:'406',fatherId:'',status:'Ø­ÙŠØ©'};
  DB.sheep['406-02']={id:'406-02',sex:'Ø°ÙƒØ±', group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:dstr(),motherId:'406',fatherId:'',status:'Ø­ÙŠØ©'};
  DB.events.push({type:'birth',ids:['406','406-01','406-02'],date:dstr(),details:'2 Ù…ÙˆÙ„ÙˆØ¯ (ØªÙˆØ£Ù…)'});
  // Ø±Ø£Ø³ Ø£Ø®Ø±Ù‰
  DB.sheep['202']={id:'202',sex:'Ø£Ù†Ø«Ù‰',group:'Ù†Ø¹ÙŠÙ…',dob:'2025-05-12',status:'Ø­ÙŠØ©'};
  // Ø¹Ù„Ù ÙˆÙ…Ø¨ÙŠØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ
  DB.finance.push({type:'feed',date:dstr(),desc:'Ø´Ø¹ÙŠØ±',qty:200,cost:250});
  DB.events.push({type:'movement',ids:['202'],date:dstr(),details:'Ø¨ÙŠØ¹',amount:800});
  save(); renderList(); statsToUI(); renderLogs();
}

/* ========= Ù‡Ø¬Ø±Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ========= */
(function migrateBirthEvents(){
  if(localStorage.getItem(KEY+'-migrated')) return;
  const already = new Set(DB.events.filter(e=>e.type==='birth')
                   .map(e=>(e.ids||[]).join('|')+'@'+e.date));
  const buckets = {};
  Object.values(DB.sheep).forEach(s=>{
    if(s.motherId && s.dob){
      const key = s.motherId+'@'+s.dob;
      (buckets[key] ||= {mom:s.motherId,date:s.dob,kids:[]}).kids.push(s.id);
    }
  });
  let added=0;
  Object.values(buckets).forEach(b=>{
    const key = [b.mom].concat(b.kids).join('|')+'@'+b.date;
    if(!already.has(key)){
      DB.events.push({type:'birth', ids:[b.mom].concat(b.kids),
                      date:b.date, details:`${b.kids.length} Ù…ÙˆÙ„ÙˆØ¯ (Ù…Ù‡Ø§Ø¬Ø±Ø©)`});
      added++;
    }
  });
  save(); localStorage.setItem(KEY+'-migrated','1');
})();

/* ========= ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ========= */
renderList(); statsToUI(); renderLogs();
</script>
</body>
</html>
