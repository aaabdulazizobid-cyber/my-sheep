<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„</title>
<meta name="theme-color" content="#10b981">
<style>
:root{
  --brand:#10b981; --brand2:#34d399;
  --ink:#0f172a; --muted:#6b7280;
  --bg:#f6f7fb; --card:#ffffff; --line:#e5e7eb;
  --warn:#f59e0b; --danger:#ef4444;
  --chip:#ecfeff; --chipb:#a5f3fc; --chips:#155e75;
  --thead:#dcfce7; --row:#f8fffc; --row2:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic","Noto Sans Arabic",Tahoma,sans-serif}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px}
.top h1{margin:0;font-size:18px;font-weight:800}
.wrap{max-width:1040px;margin:auto;padding:12px}

/* KPIs */
.grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:640px){.grid4{grid-template-columns:repeat(2,1fr)}}
.kpi{border:1px solid #d9f5ea;border-radius:12px;padding:10px;text-align:center;cursor:pointer;background:#fff}
.kpi b{display:block;font-size:18px;line-height:1}
.kpi span{font-size:12px;color:var(--muted);line-height:1.2;margin-top:4px;display:block}
.kpi.click{transition:.15s transform,.15s box-shadow}
.kpi.click:hover{box-shadow:0 8px 18px #00000010}
.kpi.click:active{transform:scale(.98)}

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒØ±ÙˆØª (Ù†ÙØ³ Ø±ÙˆØ­ Ø¨ÙˆÙ†ÙŠÙƒØ§Ù…) */
.kpi.col{color:#fff;border:0}
.kpi.col b,.kpi.col span{color:#fff}
.kpi.c1{background:linear-gradient(180deg,#ff8bd1,#ff78a7)}
.kpi.c2{background:linear-gradient(180deg,#ffb84d,#ff9a00)}
.kpi.c3{background:linear-gradient(180deg,#5da8ff,#2f6fff)}
.kpi.c4{background:linear-gradient(180deg,#4ed69e,#1fb97e)}
.kpi.c5{background:linear-gradient(180deg,#9c6bff,#7a44e6)}
.kpi.c6{background:linear-gradient(180deg,#ff6b6b,#ff3e3e)}
.kpi.c7{background:linear-gradient(180deg,#3cb5ff,#2578ff)}
.kpi.c8{background:linear-gradient(180deg,#ffb659,#ffa12e)}
.kpi.c9{background:linear-gradient(180deg,#3aa4ff,#2f6fff)}
.kpi.c10{background:linear-gradient(180deg,#43d39e,#19b87b)}
.kpi.c11{background:linear-gradient(180deg,#66c7ff,#2f7dff)}
.kpi.c12{background:linear-gradient(180deg,#47d9b3,#1ebf95)}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #00000008}
.section{padding:10px}

.searchbar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.searchbar input,.searchbar select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:13px}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
.btn.gray{background:#f3f4f6}

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.list .item{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff 0%,#f6fffb 100%)}
.item:last-child{border-bottom:0}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:var(--chip);border:1px solid var(--chipb);padding:2px 8px;border-radius:999px;color:var(--chips);margin-inline-start:6px}
.badge.sold{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.badge.np{background:#fef9c3;border-color:#fde68a;color:#7a5b00}
.badge.dead{background:#fde68a;border-color:#fcd34d;color:#92400e}
.controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}

/* Ø£ÙˆÙ„Ø§Ø¯ Ø§Ù„Ø£Ù… */
.children{margin-top:10px;background:#f0fdf4;border:1px dashed var(--line);border-radius:12px;padding:8px}
.children h4{margin:0 0 6px 0;font-size:13px;color:#065f46}
.kids{display:flex;flex-wrap:wrap;gap:6px}
.kid{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}

/* Ø¬Ø¯Ø§ÙˆÙ„ */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
.table thead th{background:var(--thead)}
.table tbody tr:nth-child(odd){background:var(--row)}
.table tbody tr:nth-child(even){background:var(--row2)}

/* Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:flex-end;justify-content:center;z-index:50}
.modal.open{display:flex}
.sheet{background:#fff;width:min(760px,100%);border-radius:16px 16px 0 0;padding:14px;border:1px solid var(--line)}
.sheet h3{margin:0 0 8px 0}
.form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.row{display:flex;flex-direction:column}
.row label{font-size:12px;color:var(--muted);margin-bottom:4px}
.form input,.form select,.form textarea{padding:10px;border:1px solid var(--line);border-radius:10px}
.form textarea{grid-column:1 / span 2;min-height:70px}
.sheet .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
@media(max-width:640px){.form{grid-template-columns:1fr}}

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ø±Ø¬ÙˆØ¹ */
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.tab{padding:6px 10px;border-radius:999px;border:1px solid var(--line);cursor:pointer;background:#fff}
.tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
.backbar{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.backbar .btn{padding:6px 10px}

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ */
.subtabs{display:flex;gap:6px;margin:6px 0}
.subtabs .tab{padding:4px 10px}
</style>
</head>
<body>
<div class="top">
  <h1>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„</h1>
  <small>Ø§ÙØªØ­ Ù…Ù† Safari â†’ Ù…Ø´Ø§Ø±ÙƒØ© â†’ Ø£Ø¶ÙÙ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (PWA)</small>
</div>

<div class="wrap">
  <!-- KPIs Ù…Ù„ÙˆÙ†Ø© -->
  <div class="grid4">
    <div class="kpi click col c4"  id="kpi_totalAll"><b id="s_totalAll">0</b><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„ÙƒÙ„)</span></div>
    <div class="kpi click col c3"  id="kpi_total"><b id="s_total">0</b><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</span></div>
    <div class="kpi click col c2"  id="kpi_ewes"><b id="s_ewes">0</b><span>Ø£Ù…Ù‡Ø§Øª</span></div>
    <div class="kpi click col c1"  id="kpi_prodEwes"><b id="s_prodEwes">0</b><span>Ø£Ù…Ù‡Ø§Øª Ù…ÙÙ†ØªÙØ¬Ø©</span></div>
  </div>
  <div class="grid4" style="margin-top:6px">
    <div class="kpi click col c6"  id="kpi_npEwes"><b id="s_npEwes">0</b><span>Ø£Ù…Ù‡Ø§Øª ØºÙŠØ± Ù…ÙÙ†ØªÙØ¬Ø©</span></div>
    <div class="kpi click col c8"  id="kpi_birthYear"><b id="s_birthYear">0</b><span>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø³Ù†Ø©</span></div>
    <div class="kpi click col c5"  id="kpi_soldYear"><b id="s_soldYear">0</b><span>Ù…Ø¨Ø§Ø¹Ø© Ø³Ù†Ø©</span></div>
    <div class="kpi click col c7"  id="kpi_deathYear"><b id="s_deathYear">0</b><span>Ø§Ù„Ù†ÙÙˆÙ‚ Ø³Ù†Ø©</span></div>
  </div>
  <div class="grid4" style="margin-top:6px">
    <div class="kpi click col c12" id="kpi_feedYear"><b id="s_feedYear">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù Ø³Ù†Ø©</span></div>
    <div class="kpi click col c10" id="kpi_treatYear"><b id="s_treatYear">0</b><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª Ø³Ù†Ø©</span></div>
    <div class="kpi click col c9"  id="kpi_vaccYear"><b id="s_vaccYear">0</b><span>Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª Ø³Ù†Ø©</span></div>
    <div class="kpi click col c11" id="kpi_summary"><b>ğŸ“Š</b><span>Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø©</span></div>
  </div>

  <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
  <div class="card section" style="margin:12px 0;">
    <div class="searchbar">
      <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©â€¦" oninput="renderList()">
      <select id="viewMode" onchange="renderList()">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="ewes">Ø§Ù„Ø£Ù…Ù‡Ø§Øª ÙÙ‚Ø·</option>
        <option value="productive">Ø§Ù„Ø£Ù…Ù‡Ø§Øª Ø§Ù„Ù…ÙÙ†ØªÙØ¬Ø©</option>
        <option value="np">ØºÙŠØ± Ø§Ù„Ù…ÙÙ†ØªÙØ¬Ø©</option>
        <option value="newborns">Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ÙÙ‚Ø·</option>
      </select>
      <select id="fltStatus" onchange="renderList()">
        <option value="alive">Ø§Ù„Ø­ÙŠØ© ÙÙ‚Ø·</option>
        <option value="sold">Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</option>
        <option value="all">Ø§Ù„ÙƒÙ„</option>
      </select>
      <button class="btn solid" onclick="openForm()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³</button>
      <button class="btn" onclick="addFeed()">ğŸŒ¾ Ø¹Ù„Ù</button>
      <button class="btn" onclick="exportDB()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
      <label class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept="application/json" style="display:none" onchange="importDB(event)"></label>
      <button class="btn gray" onclick="openRestore()">âª Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
      <button class="btn gray" onclick="quickDemo()">ÙˆØ¶Ø¹ ØªØ¬Ø±Ø¨Ø©</button>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div class="card list" id="list"></div>

  <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
  <div class="card section" style="margin-top:12px">
    <div class="backbar">
      <button class="btn gray" onclick="goHome()">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©</button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="births" onclick="setTab(this)">ğŸ‘¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª</div>
      <div class="tab" data-tab="newbornList" onclick="setTab(this)">ğŸ¼ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</div>
      <div class="tab" data-tab="sales" onclick="setTab(this)">ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      <div class="tab" data-tab="feed" onclick="setTab(this)">ğŸŒ¾ Ø§Ù„Ø¹Ù„Ù</div>
      <div class="tab" data-tab="treat" onclick="setTab(this)">ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª</div>
      <div class="tab" data-tab="vacc" onclick="setTab(this)">ğŸ’‰ Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª</div>
      <div class="tab" data-tab="death" onclick="setTab(this)">â˜ ï¸ Ø§Ù„Ù†ÙÙˆÙ‚</div>
      <div class="tab" data-tab="summary" onclick="setTab(this)">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø©</div>
    </div>

    <!-- Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª -->
    <div id="pane_births">
      <div style="overflow:auto;">
        <table class="table" id="tblBirths">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø£Ù…</th><th>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ (Ø¥Ù†Ø§Ø«/Ø°ÙƒÙˆØ±) -->
    <div id="pane_newbornList" style="display:none">
      <div class="subtabs">
        <div class="tab active" data-sub="f" onclick="setNewbornSub(this)">Ø¥Ù†Ø§Ø« (<span id="nb_f_count">0</span>)</div>
        <div class="tab" data-sub="m" onclick="setNewbornSub(this)">Ø°ÙƒÙˆØ± (<span id="nb_m_count">0</span>)</div>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="tblNewborns">
          <thead><tr><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø£Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <div id="pane_sales" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblSales">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„ØªÙØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ù„Ù -->
    <div id="pane_feed" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblFeed">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª -->
    <div id="pane_treat" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblTreat">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th></th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª -->
    <div id="pane_vacc" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblVacc">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ†</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ù†ÙÙˆÙ‚ -->
    <div id="pane_death" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblDeath">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ³Ù…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© -->
    <div id="pane_summary" style="display:none">
      <div style="overflow:auto;">
        <table class="table" id="tblSummary">
          <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø³Ù†Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³</h3>
    <div class="form">
      <div class="row"><label>Ø§Ù„ÙˆØ³Ù…</label><input id="f_id" placeholder="Ù…Ø«Ø§Ù„: 406"></div>
      <div class="row"><label>Ø§Ù„Ø¬Ù†Ø³</label><select id="f_sex"><option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option></select></div>
      <div class="row"><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><input id="f_group" placeholder="Ø­Ø±ÙŠ/Ù†Ø¹ÙŠÙ…ÙŠâ€¦"></div>
      <div class="row"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="f_dob" type="date"></div>
      <div class="row"><label>Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="f_mother"></div>
      <div class="row"><label>Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)</label><input id="f_father"></div>
      <div class="row"><label>Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="f_weight" type="number" step="0.1"></div>
      <div class="row"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="f_status"><option>Ø­ÙŠØ©</option><option>Ù…Ø¨Ø§Ø¹Ø©</option><option>Ù†Ø§ÙÙ‚Ø©</option></select></div>
      <div class="row" style="grid-column:1 / span 2"><label><input type="checkbox" id="f_np"> Ø£Ù… ØºÙŠØ± Ù…Ù†ØªØ¬Ø©</label></div>
      <div class="row" style="grid-column:1 / span 2"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦"></textarea></div>
    </div>
    <div class="bar">
      <button class="btn" onclick="closeForm()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn solid" onclick="submitForm()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ -->
<div class="modal" id="restoreModal">
  <div class="sheet">
    <h3>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>
    <div id="restoreList" class="section" style="max-height:50vh;overflow:auto;"></div>
    <div class="bar">
      <button class="btn" onclick="closeRestore()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
/*** Ø§Ù„ØªØ®Ø²ÙŠÙ† ***/
const KEY='sheep-db-v11';
const BKKEY=KEY+'-backups';
const BKMAX=12;
let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(KEY))||seed()}catch(e){return seed()}}
function save(){ localStorage.setItem(KEY,JSON.stringify(DB)); autoBackup(); }
function seed(){return{sheep:{},events:[],finance:[],treatments:[],vaccines:[],deaths:[]}}
/*
events: [{type:'birth'|'movement'|'weight', ids:[], date, details, amount?}]
finance: [{id,type:'feed',date,desc,qty,cost}]
treatments: [{id,date,sheepId,diagnosis,drug,dose,cost}]
*/

/*** Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ***/
const $=id=>document.getElementById(id);
const dstr=(d=new Date())=>new Date(d).toISOString().slice(0,10);
const money=n=>(+n||0).toLocaleString('ar-SA');
const fmt=d=>!d?'â€”':new Date(d).toLocaleDateString('ar');

/*** Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ***/
function autoBackup(){
  const list=JSON.parse(localStorage.getItem(BKKEY)||'[]');
  const last=(list[0]||{}).hash;
  const cur=JSON.stringify(DB);
  const hash=cur.length+':'+(cur.charCodeAt(0)||0);
  if(hash!==last){
    list.unshift({ts:Date.now(), date:dstr(), hash, size:cur.length, data:cur});
    while(list.length>BKMAX) list.pop();
    localStorage.setItem(BKKEY,JSON.stringify(list));
  }
}
function openRestore(){
  const list=JSON.parse(localStorage.getItem(BKKEY)||'[]');
  const box=$('restoreList'); box.innerHTML='';
  if(!list.length){box.innerHTML='<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</div>'}
  list.forEach((b,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div style="flex:1"><div class="name">${new Date(b.ts).toLocaleString('ar')}</div>
      <div class="meta">Ø§Ù„Ø­Ø¬Ù… ${b.size.toLocaleString()} Ø¨Ø§ÙŠØª</div></div>`;
    const btn=document.createElement('button'); btn.className='btn warn'; btn.textContent='Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ù‡';
    btn.onclick=()=>{ if(confirm('Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')){ DB=JSON.parse(b.data); save(); renderAll(); closeRestore(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ âœ…') } };
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©';
    del.onclick=()=>{ const arr=JSON.parse(localStorage.getItem(BKKEY)||'[]'); arr.splice(i,1); localStorage.setItem(BKKEY,JSON.stringify(arr)); openRestore(); };
    div.append(btn,del); box.appendChild(div);
  });
  $('restoreModal').classList.add('open');
}
function closeRestore(){$('restoreModal').classList.remove('open')}

/*** ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ***/
function setTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const map={'births':'pane_births','newbornList':'pane_newbornList','sales':'pane_sales','feed':'pane_feed','treat':'pane_treat','vacc':'pane_vacc','death':'pane_death','summary':'pane_summary'};
  Object.values(map).forEach(id=>$(id).style.display='none');
  $(map[el.dataset.tab]).style.display='';
}

/*** Ø£ÙˆÙ„Ø§Ø¯ Ø§Ù„Ø£Ù… ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙÙØ¹Ø§Øª ***/
function kidsOf(m){return Object.values(DB.sheep).filter(s=>s.motherId===m).sort((a,b)=>a.id>b.id?1:-1)}
function packByDate(m){const map={};kidsOf(m).forEach(k=>{const d=k.dob||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';(map[d]??=[]).push(k)});return Object.entries(map).sort((a,b)=>a[0]>b[0]?-1:1)}

/*** Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„ÙˆØ³Ù… ÙˆØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ (Ù„Ø³Ù…Ø§Ø­ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯) ***/
function renameSheepId(oldId,newId){
  if(!DB.sheep[oldId]) return true;
  if(newId!==oldId && DB.sheep[newId]){ alert('Ø§Ù„ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯'); return false; }
  const src=DB.sheep[oldId];
  DB.sheep[newId]=Object.assign({}, src, {id:newId, updatedAt:new Date().toISOString()});
  if(newId!==oldId) delete DB.sheep[oldId];
  // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ù…/Ø§Ù„Ø£Ø¨ ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ø¤ÙˆØ³
  Object.values(DB.sheep).forEach(s=>{
    if(s.motherId===oldId){ s.motherId=newId; s.updatedAt=new Date().toISOString(); }
    if(s.fatherId===oldId){ s.fatherId=newId; s.updatedAt=new Date().toISOString(); }
  });
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  DB.events.forEach(e=>{ if(e.ids) e.ids=e.ids.map(x=>x===oldId?newId:x); });
  // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ø®Ø±Ù‰
  DB.treatments.forEach(t=>{ if(t.sheepId===oldId) t.sheepId=newId; });
  DB.vaccines.forEach(v=>{ if(v.sheepId===oldId) v.sheepId=newId; });
  DB.deaths.forEach(d=>{ if(d.sheepId===oldId) d.sheepId=newId; });
  return true;
}

/*** Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø£Ø³ ***/
let editingId=null;
function openForm(id=null){
  editingId=id||null;
  if(id){
    const s=DB.sheep[id]; if(!s) return;
    $('formTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³';
    $('f_id').value=s.id; $('f_id').disabled=false; // â† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ³Ù…
    $('f_sex').value=s.sex||'Ø£Ù†Ø«Ù‰'; $('f_group').value=s.group||'';
    $('f_dob').value=s.dob||''; $('f_mother').value=s.motherId||''; $('f_father').value=s.fatherId||'';
    $('f_weight').value=s.lastWeight??''; $('f_status').value=s.status||'Ø­ÙŠØ©';
    $('f_notes').value=s.notes||''; $('f_np').checked=!!s.nonProductive;
  }else{
    ['f_id','f_group','f_dob','f_mother','f_father','f_weight','f_notes'].forEach(k=>$(k).value='');
    $('f_id').disabled=false; $('f_sex').value='Ø£Ù†Ø«Ù‰'; $('f_status').value='Ø­ÙŠØ©'; $('f_np').checked=false;
    $('formTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³';
  }
  $('modal').classList.add('open');
}
function closeForm(){$('modal').classList.remove('open')}
function submitForm(){
  const rec={
    id:$('f_id').value.trim(), sex:$('f_sex').value, group:$('f_group').value.trim(),
    dob:$('f_dob').value||'', motherId:$('f_mother').value.trim(), fatherId:$('f_father').value.trim(),
    lastWeight:$('f_weight').value?+$('f_weight').value:null, status:$('f_status').value,
    notes:$('f_notes').value.trim(), nonProductive:$('f_np').checked
  };
  if(!rec.id){alert('Ø§Ù„ÙˆØ³Ù… Ù…Ø·Ù„ÙˆØ¨');return}
  if(editingId){
    if(rec.id!==editingId){ if(!renameSheepId(editingId, rec.id)) return; }
    DB.sheep[rec.id]=Object.assign(DB.sheep[rec.id]||{}, rec, {updatedAt:new Date().toISOString()});
  }else{
    if(DB.sheep[rec.id]){alert('Ø§Ù„ÙˆØ³Ù… Ù…ÙˆØ¬ÙˆØ¯');return}
    DB.sheep[rec.id]=Object.assign(rec,{soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
  }
  save(); renderAll(); closeForm();
}

/*** Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¤ÙˆØ³ ***/
function setWeight(id){
  const s=DB.sheep[id]; if(!s)return;
  const v=prompt('Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):',s.lastWeight??''); if(v===null)return;
  const w=parseFloat(v); if(!isFinite(w))return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:w+' ÙƒØ¬Ù…'});
  save(); renderAll();
}
function editSheep(id){openForm(id)}
function removeSheep(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø£Ø³ '+id+'ØŸ'))return;
  delete DB.sheep[id];
  DB.events=DB.events.filter(e=>!(e.ids||[]).includes(id));
  DB.treatments=DB.treatments.filter(x=>x.sheepId!==id);
  DB.vaccines=DB.vaccines.filter(x=>x.sheepId!==id);
  DB.deaths=DB.deaths.filter(x=>x.sheepId!==id);
  save(); renderAll();
}

/*** Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ***/
function addChild(m){
  const mom=DB.sheep[m]; if(!mom)return alert('Ø§Ù„Ø£Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  const i=kidsOf(m).length+1; const id=m+'-'+String(i).padStart(2,'0'); const date=dstr();
  DB.sheep[id]={id,sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'Ù…ÙˆÙ„ÙˆØ¯',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.events.push({type:'birth',ids:[m,id],date,details:'1 Ù…ÙˆÙ„ÙˆØ¯'});
  if(mom.nonProductive){ mom.nonProductive=false; mom.updatedAt=new Date().toISOString(); }
  save(); renderAll();
}
function addTwin(m){
  const mom=DB.sheep[m]; if(!mom)return;
  const base=kidsOf(m).length; const date=dstr();
  const mk=i=>m+'-'+String(base+i).padStart(2,'0');
  const a=mk(1), b=mk(2);
  DB.sheep[a]={id:a,sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.sheep[b]={id:b,sex:'Ø°ÙƒØ±', group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:date,motherId:m,fatherId:mom.fatherId||'',notes:'ØªÙˆØ£Ù…',status:'Ø­ÙŠØ©',soldPrice:null,soldDate:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  DB.events.push({type:'birth',ids:[m,a,b],date,details:'2 Ù…ÙˆÙ„ÙˆØ¯ (ØªÙˆØ£Ù…)'});
  if(mom.nonProductive){ mom.nonProductive=false; mom.updatedAt=new Date().toISOString(); }
  save(); renderAll();
}
function addMany(m){const n=+prompt('ÙƒÙ… Ù…ÙˆÙ„ÙˆØ¯ØŸ','3'); if(!n||n<=0)return; for(let i=0;i<n;i++) addChild(m)}

/*** Ø§Ù„Ø¨ÙŠØ¹ ***/
function sellSheep(id){
  const s=DB.sheep[id]; if(!s)return;
  const price=+prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø±ÙŠØ§Ù„):','0'); if(isNaN(price))return;
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹ (YYYY-MM-DD):',dstr()); if(date===null)return;
  s.status='Ù…Ø¨Ø§Ø¹Ø©'; s.soldPrice=price; s.soldDate=date; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'movement',ids:[id],date,details:'Ø¨ÙŠØ¹',amount:price});
  save(); renderAll();
}
function deleteSale(evId){
  if(!confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ØŸ'))return;
  DB.events=DB.events.filter(e=>e._id!==evId);
  const sale=SALE_CACHE[evId];
  if(sale && DB.sheep[sale.sid] && DB.sheep[sale.sid].status==='Ù…Ø¨Ø§Ø¹Ø©'){
    DB.sheep[sale.sid].status='Ø­ÙŠØ©'; DB.sheep[sale.sid].soldPrice=null; DB.sheep[sale.sid].soldDate='';
  }
  save(); renderAll();
}
let SALE_CACHE={};

/*** Ø§Ù„Ø¹Ù„Ù â€” ØªØ§Ø±ÙŠØ® + Ù‚ÙŠÙ…Ø© ÙÙ‚Ø· ***/
function addFeed(){
  const date=prompt('ØªØ§Ø±ÙŠØ® (YYYY-MM-DD):',dstr()); if(date===null)return;
  const cv=prompt('Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±ÙŠØ§Ù„):','0'); if(cv===null)return;
  const cost=+cv; if(!isFinite(cost))return alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date,desc:'',qty:null,cost});
  save(); renderAll(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù âœ…');
}
function deleteFeed(id){ if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù„ÙØŸ'))return; DB.finance=DB.finance.filter(r=>r.id!==id); save(); renderAll(); }

/*** Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª â€” ØªØ§Ø±ÙŠØ® + Ù‚ÙŠÙ…Ø© ÙÙ‚Ø· (Ù…Ø«Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚) ***/
function addTreatment(id){
  if(!DB.sheep[id]) return alert('Ø§Ù„Ø±Ø£Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù„Ø§Ø¬ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const costV=prompt('Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±ÙŠØ§Ù„):','0'); if(costV===null) return;
  const cost=+costV; if(!isFinite(cost)) return alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
  DB.treatments.push({id:'treat_'+Date.now(), date, sheepId:id, diagnosis:'', drug:'', dose:'', cost});
  save(); renderAll(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ø¬ âœ…');
}
function deleteTreatment(id){ if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù„Ø§Ø¬ØŸ'))return; DB.treatments=DB.treatments.filter(x=>x.id!==id); save(); renderAll(); }

/*** Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª â€” Ø§Ø³Ù… + ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· ***/
function addVaccine(id){
  if(!DB.sheep[id]) return alert('Ø§Ù„Ø±Ø£Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ† (YYYY-MM-DD):', dstr()); if(date===null) return;
  const vaccine=prompt('Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ†:',''); if(vaccine===null) return;
  DB.vaccines.push({id:'vac_'+Date.now(), date, sheepId:id, vaccine, dose:'', notes:''});
  save(); renderAll(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­ØµÙŠÙ† âœ…');
}

/*** Ù†ÙÙˆÙ‚ ***/
function markDead(id){
  const s=DB.sheep[id]; if(!s) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙÙˆÙ‚ (YYYY-MM-DD):', dstr()); if(date===null) return;
  const cause=prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù†ÙÙˆÙ‚ â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ:',''); if(cause===null) return;
  s.status='Ù†Ø§ÙÙ‚Ø©'; s.updatedAt=new Date().toISOString();
  DB.deaths.push({id:'die_'+Date.now(), date, sheepId:id, cause});
  DB.events.push({type:'movement', ids:[id], date, details:'Ù†ÙÙˆÙ‚', amount:0});
  save(); renderAll();
}

/*** Ø¥Ø­ØµØ§Ø¡Ø§Øª ***/
function getStats(){
  const since=new Date(); since.setDate(since.getDate()-365);
  const all=Object.values(DB.sheep);
  const alive=all.filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  const ewes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰').length;
  const prodEwes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'&&!s.nonProductive).length;
  const npEwes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'&&!!s.nonProductive).length;
  // â† ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª Ù…Ù† Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø®Ù„Ø§Ù„ Ø³Ù†Ø©
  const birthYear=DB.events.filter(e=>e.type==='birth'&&e.date&&new Date(e.date)>=since).length;
  const feedYear=DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const soldYearEv=DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')&&new Date(e.date)>=since);
  const soldYear=soldYearEv.length; const revYear=soldYearEv.reduce((a,e)=>a+(+e.amount||0),0);
  const treatYear=DB.treatments.filter(t=>new Date(t.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const deathYear=DB.deaths.filter(d=>new Date(d.date)>=since).length;
  const vaccYear=DB.vaccines.filter(v=>new Date(v.date)>=since).length;
  const totalAll = all.length;
  return {totalAlive:alive.length, totalAll, ewes, prodEwes, npEwes, birthYear, feedYear, soldYear, revYear, treatYear, deathYear, vaccYear};
}
function statsToUI(){
  const s=getStats();
  $('s_totalAll').textContent=s.totalAll;
  $('s_total').textContent=s.totalAlive;
  $('s_ewes').textContent=s.ewes;
  $('s_prodEwes').textContent=s.prodEwes;
  $('s_npEwes').textContent=s.npEwes;
  $('s_birthYear').textContent=s.birthYear;
  $('s_feedYear').textContent=money(s.feedYear);
  $('s_soldYear').textContent=s.soldYear;
  $('s_treatYear').textContent=money(s.treatYear);
  $('s_deathYear').textContent=s.deathYear;
  $('s_vaccYear').textContent=s.vaccYear;
}

/*** Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºÙ†Ù… Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© ***/
function showList(flag){ $('list').style.display = flag ? '' : 'none'; }
function goHome(){ showList(true); window.scrollTo({top:document.querySelector('.wrap').offsetTop,behavior:'smooth'}); }

/*** ÙØªØ­ ØµÙØ­Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ***/
function openSection(name, sub){
  const recordNames=['sales','death','feed','treat','vacc','summary','newborns'];
  if(recordNames.includes(name)){ showList(false); } else { showList(true); }
  const map={ sales:'sales', death:'death', feed:'feed', treat:'treat', vacc:'vacc', summary:'summary', newborns:'newbornList' };
  const tab=document.querySelector(`.tab[data-tab="${map[name]||'summary'}"]`);
  if(tab) setTab(tab);
  if(name==='newborns'){
    const target=sub==='m'
      ? document.querySelector('#pane_newbornList .tab[data-sub="m"]')
      : document.querySelector('#pane_newbornList .tab[data-sub="f"]');
    if(target) setNewbornSub(target);
  }
  document.querySelector('.tabs').scrollIntoView({behavior:'smooth'});
}

/*** Ø±Ø¨Ø· Ø§Ù„Ù€ KPIs ***/
document.addEventListener('DOMContentLoaded',()=>{
  $('kpi_totalAll').onclick =()=> openSection('summary');
  $('kpi_total').onclick   =()=>{ showList(true); $('fltStatus').value='alive'; $('viewMode').value='all'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_ewes').onclick    =()=>{ showList(true); $('viewMode').value='ewes'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_prodEwes').onclick=()=>{ showList(true); $('viewMode').value='productive'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_npEwes').onclick  =()=>{ showList(true); $('viewMode').value='np'; renderList(); document.getElementById('list').scrollIntoView({behavior:'smooth'}); };
  $('kpi_birthYear').onclick=()=> openSection('newborns','f');
  $('kpi_soldYear').onclick =()=> openSection('sales');
  $('kpi_deathYear').onclick=()=> openSection('death');
  $('kpi_feedYear').onclick =()=> openSection('feed');
  $('kpi_treatYear').onclick=()=> openSection('treat');
  $('kpi_vaccYear').onclick =()=> openSection('vacc');
  $('kpi_summary').onclick  =()=> openSection('summary');
});

/*** Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ***/
function renderList(){
  const q=($('q').value||'').trim().toLowerCase();
  const mode=$('viewMode').value, flt=$('fltStatus').value;
  let arr=Object.values(DB.sheep);

  if(q){
    arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q));
  }
  if(mode==='ewes'){arr=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰')}
  else if(mode==='productive'){arr=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'&&!s.nonProductive)}
  else if(mode==='np'){arr=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰'&&!!s.nonProductive)}
  else if(mode==='newborns'){arr=arr.filter(s=>s.motherId&&s.motherId!=='')}

  if(flt==='alive')arr=arr.filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  else if(flt==='sold')arr=arr.filter(s=>s.status==='Ù…Ø¨Ø§Ø¹Ø©');

  arr.sort((a,b)=>{if(a.sex!==b.sex)return a.sex==='Ø£Ù†Ø«Ù‰'?-1:1;return a.id>b.id?1:-1});

  const box=$('list'); box.innerHTML='';
  if(!arr.length){box.innerHTML='<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª..</div>';return}

  arr.forEach(s=>{
    const row=document.createElement('div'); row.className='item';
    const info=document.createElement('div'); info.style.flex='1';

    const title=document.createElement('div');
    title.innerHTML=`<span class="name">${s.id}</span>
      ${s.sex==='Ø£Ù†Ø«Ù‰'?'<span class="badge">Ø£Ù…</span>':''}
      ${s.nonProductive?'<span class="badge np">ğŸ›‘ ØºÙŠØ± Ù…Ù†ØªØ¬Ø©</span>':''}
      ${s.status==='Ù†Ø§ÙÙ‚Ø©'?'<span class="badge dead">Ù†Ø§ÙÙ‚Ø©</span>':''}
      ${(s.status!=='Ø­ÙŠØ©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©')?`<span class="badge sold">${s.status}${s.soldPrice!=null?' â€¢ '+s.soldPrice+' Ø±.Ø³':''}</span>`:''}`;
    info.appendChild(title);

    const meta=document.createElement('div'); meta.className='meta';
    meta.textContent=`${s.group||'â€“'} â€¢ ${s.sex||'â€“'} â€¢ ${fmt(s.dob)}${s.lastWeight!=null?' â€¢ '+s.lastWeight+' ÙƒØ¬Ù…':''}`;
    info.appendChild(meta);

    if(s.sex==='Ø£Ù†Ø«Ù‰'){
      const packs=packByDate(s.id); const wrap=document.createElement('div'); wrap.className='children';
      wrap.innerHTML=`<h4>Ù…ÙˆØ§Ù„ÙŠØ¯ ${packs.length?'':'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</h4>`;
      packs.forEach(([date,kids])=>{
        const line=document.createElement('div'); line.style.margin='6px 0';
        line.innerHTML=`<div class="meta">Ø¯ÙØ¹Ø© ${fmt(date)} (${kids.length})</div>`;
        const rowKids=document.createElement('div'); rowKids.className='kids';
        kids.forEach(k=>{const b=document.createElement('span'); b.className='kid'; b.textContent=`${k.id} â€¢ ${k.sex||'â€”'}`; rowKids.appendChild(b)});
        line.appendChild(rowKids); wrap.appendChild(line);
      });
      info.appendChild(wrap);
    }

    const ctr=document.createElement('div'); ctr.className='controls';
    if (s.sex==='Ø£Ù†Ø«Ù‰' && s.status!=='Ù…Ø¨Ø§Ø¹Ø©' && s.status!=='Ù†Ø§ÙÙ‚Ø©') {
      const b1=btn('+ Ù…ÙˆÙ„ÙˆØ¯',()=>addChild(s.id));
      const b2=btn('ØªÙˆØ£Ù… +',()=>addTwin(s.id));
      const b3=btn('+ Ù…ØªØ¹Ø¯Ø¯',()=>addMany(s.id));
      ctr.append(b1,b2,b3);
    }
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('âš–ï¸ ÙˆØ²Ù†',()=>setWeight(s.id)));
    ctr.append(btn('Ø¹Ù„Ø§Ø¬ ğŸ’Š',()=>addTreatment(s.id)), btn('Ù„Ù‚Ø§Ø­ ğŸ’‰',()=>addVaccine(s.id)));
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('Ø¨ÙŠØ¹ ğŸ’°',()=>sellSheep(s.id),'warn'));
    ctr.append(btn('ØªØ¹Ø¯ÙŠÙ„',()=>editSheep(s.id)));
    if(s.status!=='Ù†Ø§ÙÙ‚Ø©') ctr.append(btn('Ù†ÙÙˆÙ‚ â˜ ï¸',()=>markDead(s.id),'danger'));
    ctr.append(btn('Ø­Ø°Ù ğŸ—‘',()=>removeSheep(s.id),'danger'));

    info.appendChild(ctr);
    row.appendChild(info);
    box.appendChild(row);
  });

  function btn(t,fn,cls=''){const b=document.createElement('button'); b.className='btn'+(cls?' '+cls:''); b.textContent=t; b.onclick=fn; return b}
}

/*** Ø§Ù„Ø³Ø¬Ù„Ø§Øª ***/
function renderLogs(){
  // ÙˆÙ„Ø§Ø¯Ø§Øª
  const tbB=$('tblBirths').querySelector('tbody'); tbB.innerHTML='';
  DB.events.filter(e=>e.type==='birth').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(e=>{
    const mom=(e.ids||[])[0]||'â€”'; const kids=(e.ids||[]).slice(1).join('ØŒ ');
    tbB.insertAdjacentHTML('beforeend',`<tr><td>${fmt(e.date)}</td><td>${mom}</td><td>${kids||'â€”'}</td><td>${e.details||''}</td></tr>`);
  });

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯
  renderNewbornList();

  // Ù…Ø¨ÙŠØ¹Ø§Øª
  const tbS=$('tblSales').querySelector('tbody'); tbS.innerHTML=''; SALE_CACHE={};
  DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||''))
    .sort((a,b)=>(b.date||'').localeCompare(a.date||''))
    .forEach(e=>{
      const sid=(e.ids||[])[0]||'â€”'; const id='_sale_'+(e._id||(e._id=String(Math.random()).slice(2)));
      SALE_CACHE[id]={sid};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(e.date)}</td><td>${sid}</td><td>Ø¨ÙŠØ¹</td><td>${money(+e.amount||0)}</td>`;
      const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn danger'; b.textContent='ğŸ—‘'; b.onclick=()=>deleteSale(id);
      td.appendChild(b); tr.appendChild(td); tbS.appendChild(tr);
    });

  // Ø¹Ù„Ù
  const tbF=$('tblFeed').querySelector('tbody'); tbF.innerHTML='';
  DB.finance.filter(f=>f.type==='feed').sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${money(r.cost||0)}</td>`;
    const td=document.createElement('td'); const b=document.createElement('button'); b.className='btn danger'; b.textContent='ğŸ—‘'; b.onclick=()=>deleteFeed(r.id);
    td.appendChild(b); tr.appendChild(td); tbF.appendChild(tr);
  });

  // Ø¹Ù„Ø§Ø¬
  const tbT=$('tblTreat').querySelector('tbody'); tbT.innerHTML='';
  DB.treatments.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(t.date)}</td><td>${money(+t.cost||0)}</td>`;
    const td=document.createElement('td'); const bd=document.createElement('button'); bd.className='btn danger'; bd.textContent='ğŸ—‘'; bd.onclick=()=>deleteTreatment(t.id);
    td.appendChild(bd);
    tr.appendChild(td); tbT.appendChild(tr);
  });

  // Ø§Ù„ØªØ­ØµÙŠÙ†Ø§Øª
  const tbV=$('tblVacc').querySelector('tbody'); tbV.innerHTML='';
  DB.vaccines.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(v.date)}</td><td>${v.vaccine||''}</td>`;
    tbV.appendChild(tr);
  });

  // Ù†ÙÙˆÙ‚
  const tbD=$('tblDeath').querySelector('tbody'); tbD.innerHTML='';
  DB.deaths.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(d.date)}</td><td>${d.sheepId}</td><td>${d.cause||'â€”'}</td>`;
    tbD.appendChild(tr);
  });

  // Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø©
  renderSummary();
}

/*** Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ (Ø¥Ù†Ø§Ø«/Ø°ÙƒÙˆØ±) ***/
let NEWBORN_SUB='f';
function setNewbornSub(el){
  document.querySelectorAll('#pane_newbornList .subtabs .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  NEWBORN_SUB=el.dataset.sub;
  renderNewbornList();
}
function renderNewbornList(){
  const arr=Object.values(DB.sheep).filter(s=>s.motherId&&s.motherId!=='');
  const f=arr.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰');
  const m=arr.filter(s=>s.sex==='Ø°ÙƒØ±');
  $('nb_f_count').textContent=f.length;
  $('nb_m_count').textContent=m.length;
  const show=NEWBORN_SUB==='f'?f:m;
  const tb=$('tblNewborns').querySelector('tbody'); tb.innerHTML='';
  show.sort((a,b)=>a.id>b.id?1:-1).forEach(s=>{
    tb.insertAdjacentHTML('beforeend',`<tr><td>${s.id}</td><td>${s.sex||'â€”'}</td><td>${s.motherId||'â€”'}</td><td>${fmt(s.dob)}</td><td>${s.status||'â€”'}</td></tr>`);
  });
}

/*** Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© ***/
function renderSummary(){
  const since=new Date(); since.setDate(since.getDate()-365);
  const feedYear = DB.finance.filter(f=>f.type==='feed'&&new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const treatYear= DB.treatments.filter(t=>new Date(t.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const costYear = feedYear + treatYear;
  const revYear  = DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')&&new Date(e.date)>=since).reduce((a,e)=>a+(+e.amount||0),0);
  const netYear  = revYear - costYear;

  const feedAll  = DB.finance.filter(f=>f.type==='feed').reduce((a,b)=>a+(+b.cost||0),0);
  const treatAll = DB.treatments.reduce((a,b)=>a+(+b.cost||0),0);
  const costAll  = feedAll + treatAll;
  const revAll   = DB.events.filter(e=>e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')).reduce((a,e)=>a+(+e.amount||0),0);
  const netAll   = revAll - costAll;

  const rows = [
    ['ğŸŒ¾ Ø§Ù„Ø¹Ù„Ù', money(feedYear),  money(feedAll)],
    ['ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬Ø§Øª', money(treatYear), money(treatAll)],
    ['ğŸ“¦ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¹Ù„Ù+Ø¹Ù„Ø§Ø¬Ø§Øª)', money(costYear), money(costAll)],
    ['ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', money(revYear), money(revAll)],
    ['ğŸ“ˆ Ø§Ù„ØµØ§ÙÙŠ', money(netYear), money(netAll)],
  ];
  const tb=$('tblSummary').querySelector('tbody'); tb.innerHTML='';
  rows.forEach(r=> tb.insertAdjacentHTML('beforeend', `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`));
}

/*** ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ¬Ø±Ø¨Ø© ***/
function exportDB(){
  const blob=new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='sheep-backup-'+dstr()+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importDB(ev){
  const f=ev.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); renderAll(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…') }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­') } };
  r.readAsText(f);
}
function quickDemo(){
  if(!confirm('ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±Ø¨Ø©ØŸ'))return;
  DB=seed();
  DB.sheep['600']={id:'600',sex:'Ø£Ù†Ø«Ù‰',group:'Ø­Ø±ÙŠ',dob:'2024-10-10',status:'Ø­ÙŠØ©',nonProductive:true};
  DB.sheep['600-01']={id:'600-01',sex:'Ø£Ù†Ø«Ù‰',group:'Ù…ÙˆØ§Ù„ÙŠØ¯',dob:dstr(),motherId:'600',status:'Ø­ÙŠØ©'};
  DB.events.push({type:'birth',ids:['600','600-01'],date:dstr(),details:'1 Ù…ÙˆÙ„ÙˆØ¯'});
  DB.finance.push({id:'feed_'+Date.now(),type:'feed',date:dstr(),desc:'',qty:null,cost:160});
  DB.treatments.push({id:'treat_'+(Date.now()+1),date:dstr(),sheepId:'600',diagnosis:'',drug:'',dose:'',cost:25});
  DB.vaccines.push({id:'vac_'+(Date.now()+2),date:dstr(),sheepId:'600',vaccine:'Ø¬Ø±Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø±',dose:'',notes:''});
  save(); renderAll();
}

/*** Ù‡Ø¬Ø±Ø© ÙˆÙ„Ø§Ø¯Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ***/
(function migrateBirthsOnce(){
  const FLAG=KEY+'-migrated';
  if(localStorage.getItem(FLAG))return;
  const seen=new Set(DB.events.filter(e=>e.type==='birth').map(e=>(e.ids||[]).join('|')+'@'+e.date));
  const buckets={};
  Object.values(DB.sheep).forEach(s=>{
    if(s.motherId&&s.dob){
      const k=s.motherId+'@'+s.dob; (buckets[k]??={mom:s.motherId,date:s.dob,kids:[]}).kids.push(s.id)
    }
  });
  Object.values(buckets).forEach(b=>{
    const key=[b.mom].concat(b.kids).join('|')+'@'+b.date;
    if(!seen.has(key)){ DB.events.push({type:'birth',ids:[b.mom].concat(b.kids),date:b.date,details:`${b.kids.length} Ù…ÙˆÙ„ÙˆØ¯ (Ù…Ù‡Ø§Ø¬Ø±Ø©)`}); }
  });
  save(); localStorage.setItem(FLAG,'1');
})();

/*** ØªØ´ØºÙŠÙ„ Ø´Ø§Ù…Ù„ ***/
function renderAll(){ renderList(); statsToUI(); renderLogs(); }
renderAll();

/*** PWA ***/
(function injectPWA(){
  const manifest = {
    "name":"Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø´Ø§Ù…Ù„","short_name":"Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù…","start_url":"./","display":"standalone",
    "background_color":"#10b981","theme_color":"#10b981",
    "icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%2310b981'/%3E%3Ctext x='50%25' y='57%25' text-anchor='middle' font-size='120' fill='white'%3E%F0%9F%90%91%3C/text%3E%3C/svg%3E","sizes":"256x256","type":"image/svg+xml"}]
  };
  const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const mUrl=URL.createObjectURL(mBlob); const link=document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

  if('serviceWorker' in navigator){
    const swCode=`
      const CACHE='sheep-cache-v2';
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim(); });
      self.addEventListener('fetch',e=>{
        e.respondWith(
          caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{ const cp=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,cp)); return res; }).catch(()=>r))
        );
      });
    `;
    const swBlob=new Blob([swCode],{type:'text/javascript'});
    const swUrl=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();
</script>
</body>
</html>
