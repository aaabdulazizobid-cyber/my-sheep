<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>دفتر الغنم — المبسّط (PWA)</title>
<link rel="manifest" href="manifest.webmanifest?v=2">
<meta name="theme-color" content="#10b981">
<link rel="apple-touch-icon" href="icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b;
}
*{box-sizing:border-box} html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px}
.top h1{margin:0;font-size:18px;font-weight:800}
.top small{opacity:.9;font-size:12px}
.wrap{max-width:900px;margin:auto;padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.list{overflow:auto}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75}
.row{display:flex;justify-content:space-between;align-items:center}
.k{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#f9fafb}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.nav{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr)}
.nav button{padding:10px 6px;background:#fff;border:0}
.nav button.active{color:var(--brand);font-weight:700}
.fab{position:fixed;right:16px;bottom:74px;background:var(--brand);color:#fff;border:none;width:58px;height:58px;border-radius:50%;font-size:26px;box-shadow:0 10px 30px #10b98155;cursor:pointer}
.hidden{display:none}
.mini{font-size:12px;color:var(--muted)}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.stat{padding:12px;border-radius:12px;color:#064e3b;background:linear-gradient(135deg,#d1fae5,#ecfdf5)}
@media(min-width:720px){.stats{grid-template-columns:repeat(4,1fr)}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:center;font-size:14px}
</style>
</head>
<body>

<div class="top">
  <div class="row">
    <h1>🐑 دفتر الغنم <small>الإصدار المبسّط (PWA)</small></h1>
    <button class="btn" onclick="exportData()">تصدير</button>
  </div>
  <div class="mini">لأفضل تجربة: افتح بـ Safari ← مشاركة ← إضافة إلى الشاشة الرئيسية.</div>
</div>

<div class="wrap">
  <!-- القطيع -->
  <section id="tab-herd" class="card">
    <div style="padding:12px">
      <div class="stats">
        <div class="stat"><div class="k">إجمالي (حية)</div><div id="s_total" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">أمهات</div><div id="s_ewes" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">مواليد 30 يوم</div><div id="s_birth30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">تكلفة العلف 30 يوم</div><div id="s_feed30" style="font-weight:800;font-size:22px">0</div></div>
      </div>
      <div class="row" style="gap:10px;margin-top:4px">
        <input id="q" oninput="renderList()" placeholder="بحث بالوسم/المجموعة/الحالة">
        <select id="sort" onchange="renderList()">
          <option value="created">الأحدث</option>
          <option value="id">الوسم</option>
          <option value="dob">الميلاد</option>
          <option value="group">المجموعة</option>
        </select>
      </div>
    </div>
    <div class="list" id="list"></div>
  </section>

  <!-- إضافة سريعة -->
  <section id="tab-add" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">➕ إضافة سريعة</h3>
      <div><label class="k">الوسم</label><input id="f_id" placeholder="مثال: 105"></div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">الجنس</label>
          <select id="f_sex"><option>أنثى</option><option>ذكر</option></select></div>
        <div style="flex:1"><label class="k">المجموعة</label>
          <input id="f_group" list="dlGroups" placeholder="أمهات/مواليد/فحول">
          <datalist id="dlGroups"></datalist>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">تاريخ الميلاد</label><input id="f_dob" type="date"></div>
        <div style="flex:1"><label class="k">آخر وزن (كجم)</label><input id="f_w" type="number" step="0.01" placeholder="اختياري"></div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">الأم (وسم)</label><input id="f_mom" placeholder="اختياري"></div>
        <div style="flex:1"><label class="k">الأب (وسم)</label><input id="f_dad" placeholder="اختياري"></div>
      </div>
      <div><label class="k">ملاحظات</label><textarea id="f_notes" rows="2" placeholder="اختياري"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" onclick="clearQuick()">مسح</button>
        <button class="btn solid" onclick="saveQuick()">حفظ</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)">
      <div class="row" style="gap:10px">
        <button class="btn ghost" onclick="openBirth()">🍼 ولادة</button>
        <button class="btn ghost" onclick="openWeightPrompt()">⚖️ وزن</button>
        <button class="btn ghost" onclick="openVacc()">💉 تطعيم</button>
        <button class="btn warn" onclick="openMove()">بيع/شراء/نفوق</button>
      </div>
    </div>
  </section>

  <!-- السجلات -->
  <section id="tab-events" class="card hidden">
    <div style="padding:12px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" data-t="all"  onclick="filterEv(this)">الكل</button>
        <button class="btn" data-t="birth" onclick="filterEv(this)">ولادة</button>
        <button class="btn" data-t="weight" onclick="filterEv(this)">أوزان</button>
        <button class="btn" data-t="vaccination" onclick="filterEv(this)">تطعيم</button>
        <button class="btn" data-t="movement" onclick="filterEv(this)">بيع/شراء</button>
        <button class="btn" data-t="feed" onclick="filterEv(this)">علف</button>
      </div>
    </div>
    <div class="list" id="events"></div>
  </section>

  <!-- العلف / المصروفات -->
  <section id="tab-feed" class="card hidden">
    <div style="padding:14px;display:grid;gap:12px">
      <h3 style="margin:0">🌾 تسجيل علف/مصروف</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label class="k">النوع</label>
          <select id="fd_type">
            <option>شراء علف</option>
            <option>صرف علف</option>
            <option>مصروف آخر</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px"><label class="k">الاسم/الوصف</label><input id="fd_name" placeholder="شعير، برسيم، مكعبات…"></div>
        <div style="flex:1;min-width:160px"><label class="k">التاريخ</label><input id="fd_date" type="date"></div>
        <div style="flex:1;min-width:140px"><label class="k">الكمية (كجم)</label><input id="fd_qty" type="number" step="0.01"></div>
        <div style="flex:1;min-width:160px"><label class="k">التكلفة (ريال)</label><input id="fd_cost" type="number" step="0.01"></div>
      </div>
      <div><label class="k">ملاحظات</label><input id="fd_notes" placeholder="اختياري"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn solid" onclick="saveFeed()">حفظ</button>
      </div>

      <h3 style="margin:10px 0 0 0">📋 السجل</h3>
      <div style="overflow:auto">
        <table class="table" id="tblFeed"><thead>
          <tr><th>التاريخ</th><th>النوع</th><th>الاسم</th><th>كمية</th><th>التكلفة</th><th>ملاحظات</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- الإعدادات -->
  <section id="tab-settings" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">إعدادات</h3>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">اسم المزرعة</label><input id="farm" oninput="saveSettings()"></div>
        <div style="flex:1"><label class="k">مجموعات (افصل بفاصلة)</label><input id="groups" oninput="saveSettings()" placeholder="أمهات, فحول, مواليد, تسمين, للبيع"></div>
      </div>
      <div class="mini">البيانات محفوظة داخليًا في جهازك. لنقلها لجهاز آخر استخدم التصدير/الاستيراد.</div>
      <div class="row" style="gap:10px">
        <label class="btn">⬆️ استيراد<input id="imp" type="file" accept=".json" class="hidden" onchange="importData(event)"></label>
        <button class="btn" onclick="exportData()">⬇️ تصدير</button>
        <button class="btn warn" onclick="if(confirm('متأكد؟')){localStorage.removeItem(KEY);location.reload()}">تفريغ البيانات</button>
      </div>
    </div>
  </section>
</div>

<button class="fab" onclick="go('tab-add')">＋</button>

<div class="nav">
  <button id="b-herd" class="active" onclick="go('tab-herd')">القطيع</button>
  <button id="b-add" onclick="go('tab-add')">إضافة</button>
  <button id="b-events" onclick="go('tab-events')">السجلات</button>
  <button id="b-feed" onclick="go('tab-feed')">العلف</button>
  <button id="b-settings" onclick="go('tab-settings')">إعدادات</button>
</div>

<script>
/* ======= قاعدة بيانات محلية ======= */
const KEY='sheep_data_pwa_v2';
let DB = (()=>{ try{ const t=localStorage.getItem(KEY); return t?JSON.parse(t):null }catch{ return null } })()
   || {sheep:{},events:[],finance:[],settings:{farm:'',groups:'أمهات, فحول, مواليد, تسمين, للبيع'}};
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(DB)); }catch(e){ alert('تعذّر الحفظ: مساحة المتصفح ممتلئة أو محظورة.'); } }

/* ======= تنقّل ======= */
function go(id){
  document.querySelectorAll('.card').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  const map={'tab-herd':'b-herd','tab-add':'b-add','tab-events':'b-events','tab-feed':'b-feed','tab-settings':'b-settings'};
  document.getElementById(map[id]).classList.add('active');
  if(id==='tab-herd'){ renderList(); statsToUI(); }
  if(id==='tab-events') renderEvents();
  if(id==='tab-feed') renderFeed();
  if(id==='tab-settings') renderSettings();
}

/* ======= أدوات ======= */
function byId(x){return document.getElementById(x)}
function dstr(){return new Date().toISOString().slice(0,10)}
function fmt(d){if(!d) return '—'; try{return new Date(d).toLocaleDateString('ar')}catch(e){return d}}

/* ======= إحصاءات أعلى الصفحة ======= */
function getStats(){
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  const ewes=alive.filter(s=>s.sex==='أنثى').length;
  const since=new Date(); since.setDate(since.getDate()-30);
  const birth30=DB.events.filter(e=>e.type==='birth'&&new Date(e.date)>=since).length;
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  return {total:alive.length,ewes,birth30,feed30};
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birth30').textContent=s.birth30;
  byId('s_feed30').textContent=s.feed30.toFixed(0);
}

/* ======= القطيع ======= */
function renderList(){
  const q=(byId('q')?.value||'').toLowerCase();
  const sort=byId('sort')?.value||'created';
  let arr=Object.values(DB.sheep);
  if(q){arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q))}
  arr.sort((a,b)=>{
    if(sort==='id') return (a.id||'').localeCompare(b.id||'');
    if(sort==='dob') return (b.dob||'').localeCompare(a.dob||'');
    if(sort==='group') return (a.group||'').localeCompare(b.group||'');
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });
  const box=byId('list'); box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="item"><div>لا توجد سجلات.. اضغط + لإضافة أول رأس</div></div>'; return; }
  arr.forEach(s=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div style="flex:1">
        <div class="row"><b>${s.id||''}</b> <span class="badge">${s.group||'—'}</span></div>
        <div class="k">${s.sex||''} • ${s.status||'حية'} • ${fmt(s.dob)} ${s.lastWeight!=null?('• '+s.lastWeight+' كجم'):''}</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="edit('${s.id}')">تعديل</button>
        <button class="btn" onclick="weight('${s.id}')">⚖️</button>
      </div>`;
    box.appendChild(el);
  });
}
function edit(id){
  const s=DB.sheep[id]; if(!s) return;
  byId('f_id').value=s.id; byId('f_sex').value=s.sex||'أنثى'; byId('f_group').value=s.group||'';
  byId('f_dob').value=s.dob||''; byId('f_w').value=s.lastWeight??''; byId('f_mom').value=s.motherId||''; byId('f_dad').value=s.fatherId||'';
  byId('f_notes').value=s.notes||''; go('tab-add');
}
function weight(id){
  const s=DB.sheep[id]; if(!s) return;
  const v=prompt('الوزن (كجم):', s.lastWeight ?? '');
  if(v==null) return;
  const w=parseFloat(v);
  if(!isFinite(w)) return alert('رقم غير صالح');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:`${w} كجم`});
  save(); renderList(); statsToUI(); go('tab-herd');
}

/* ======= إضافة سريعة ======= */
function clearQuick(){['f_id','f_group','f_dob','f_w','f_mom','f_dad','f_notes'].forEach(x=>byId(x).value=''); byId('f_sex').value='أنثى'}
function saveQuick(){
  const id=(byId('f_id').value||'').trim();
  if(!id) return alert('اكتب الوسم');
  const s={
    id,
    sex:byId('f_sex').value||'أنثى',
    group:byId('f_group').value||'',
    dob:byId('f_dob').value||'',
    lastWeight: byId('f_w').value?parseFloat(byId('f_w').value):null,
    motherId:byId('f_mom').value||'',
    fatherId:byId('f_dad').value||'',
    notes:byId('f_notes').value||'',
    status: DB.sheep[id]?.status || 'حية',
    createdAt: DB.sheep[id]?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  DB.sheep[id]=s; save();
  clearQuick(); statsToUI(); renderList(); alert('تم الحفظ ✅'); go('tab-herd');
}

/* ======= سجلات ======= */
let EV_FILTER='all';
function filterEv(btn){EV_FILTER=btn.dataset.t; renderEvents()}
function renderEvents(){
  const box=byId('events'); box.innerHTML='';
  let arr=DB.events.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  if(EV_FILTER!=='all') arr=arr.filter(e=>e.type===EV_FILTER);
  if(!arr.length){ box.innerHTML='<div class="item">لا توجد سجلات بعد.</div>'; return; }
  const map={birth:'🍼 ولادة',weight:'⚖️ وزن',vaccination:'💉 تطعيم',movement:'🔁 حركة',feed:'🌾 علف'};
  arr.forEach(e=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div style="flex:1"><b>${map[e.type]||e.type}</b><div class="k">${e.details||''}</div></div><div class="k">${fmt(e.date)}</div>`;
    box.appendChild(el);
  });
}

/* ======= عمليات سريعة (ولادة/تطعيم/حركة) ======= */
function openBirth(){
  const mom=prompt('وسم الأم؟'); if(!mom) return;
  const cnt=parseInt(prompt('عدد المواليد؟ (1/2/..)')||'1',10);
  DB.events.push({type:'birth',ids:[mom],date:dstr(),details:`${cnt} مولود`});
  save(); alert('سُجّلت الولادة'); statsToUI(); renderEvents(); go('tab-events');
}
function openWeightPrompt(){
  const id=prompt('وسم الرأس؟'); if(!id||!DB.sheep[id]) return alert('الوسم غير موجود');
  weight(id);
}
function openVacc(){
  const ids=(prompt('الوسوم (افصل بفاصلة)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const name=prompt('اسم اللقاح؟')||'لقاح';
  const next=prompt('موعد قادم (YYYY-MM-DD) اختياري')||'';
  ids.forEach(id=>{
    if(DB.sheep[id]){ DB.sheep[id].vaccinations=(DB.sheep[id].vaccinations||[]); DB.sheep[id].vaccinations.push({name,date:dstr(),next}); }
  });
  DB.events.push({type:'vaccination',ids,date:dstr(),details:`${name}${next? ' — القادم: '+next:''}`});
  save(); alert('تم التطعيم'); renderEvents(); go('tab-events');
}
function openMove(){
  const type=prompt('العملية: بيع / شراء / نفوق / نقل')||'بيع';
  const ids=(prompt('الوسوم (افصل بفاصلة)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const date=dstr();
  let det=type; let amt=null; let to='';
  if(type==='بيع'||type==='شراء'){ amt=parseFloat(prompt('القيمة (ريال)')||'0'); det+=` — ${amt} ريال`; }
  if(type==='نقل'){ to=prompt('إلى أي مجموعة؟')||''; det+=to?` — إلى ${to}`:''; }
  ids.forEach(id=>{
    const s=DB.sheep[id]; if(!s) return;
    if(type==='بيع') s.status='مباعة';
    else if(type==='شراء') s.status='حية';
    else if(type==='نفوق') s.status='نافقة';
    else if(type==='نقل') s.group=to;
    s.updatedAt=new Date().toISOString();
  });
  DB.events.push({type:'movement',ids,date,details:det,amount:(type==='بيع'&&amt)?amt:0});
  save(); alert('تم تسجيل الحركة'); renderEvents(); renderList(); statsToUI(); go('tab-events');
}

/* ======= العلف/المصروفات ======= */
function renderFeed(){
  const tb=byId('tblFeed').querySelector('tbody'); tb.innerHTML='';
  DB.finance.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.type}</td><td>${r.name||'—'}</td><td>${r.qty||0}</td><td>${r.cost||0}</td><td>${r.notes||''}</td>`;
    tb.appendChild(tr);
  });
}
function saveFeed(){
  const t=byId('fd_type').value,
        name=byId('fd_name').value||'',
        date=byId('fd_date').value||dstr(),
        qty=byId('fd_qty').value?parseFloat(byId('fd_qty').value):0,
        cost=byId('fd_cost').value?parseFloat(byId('fd_cost').value):0,
        notes=byId('fd_notes').value||'';
  DB.finance.push({type:t,name,date,qty,cost,notes});
  DB.events.push({type:'feed',ids:[],date,details:`${t} — ${name} — ${qty||0} كجم — ${cost||0} ريال ${notes? ' — '+notes:''}`});
  save();
  byId('fd_name').value=''; byId('fd_qty').value=''; byId('fd_cost').value=''; byId('fd_notes').value='';
  renderFeed(); statsToUI(); alert('تم الحفظ ✅');
}

/* ======= إعدادات ======= */
function renderSettings(){
  byId('farm').value=DB.settings.farm||'';
  byId('groups').value=DB.settings.groups||'';
  const dl=byId('dlGroups'); dl.innerHTML='';
  (DB.settings.groups||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(g=>{
    const o=document.createElement('option'); o.value=g; dl.appendChild(o);
  });
}
function saveSettings(){ DB.settings.farm=byId('farm').value; DB.settings.groups=byId('groups').value; save(); renderSettings(); }

/* ======= تصدير/استيراد ======= */
function exportData(){ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sheep-data.json'; a.click(); }
function importData(ev){ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); go('tab-herd'); renderList(); renderEvents(); renderFeed(); renderSettings(); statsToUI(); alert('تم الاستيراد ✅'); }catch{ alert('ملف غير صالح'); } }; r.readAsText(f); }

/* تهيئة */
go('tab-herd'); renderSettings(); statsToUI();

/* PWA */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=2').catch(console.warn); }); }
</script>
</body>
</html>
