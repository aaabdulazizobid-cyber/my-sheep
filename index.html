<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø§Ù„Ù…Ø¨Ø³Ù‘Ø· (PWA)</title>
<link rel="manifest" href="manifest.webmanifest?v=2">
<meta name="theme-color" content="#10b981">
<link rel="apple-touch-icon" href="icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b;
}
*{box-sizing:border-box} html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px}
.top h1{margin:0;font-size:18px;font-weight:800}
.top small{opacity:.9;font-size:12px}
.wrap{max-width:900px;margin:auto;padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.list{overflow:auto}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75}
.row{display:flex;justify-content:space-between;align-items:center}
.k{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#f9fafb}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.gray{background:#f3f4f6}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}

.nav{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr)}
.nav button{padding:10px 6px;background:#fff;border:0}
.nav button.active{color:var(--brand);font-weight:700}
.fab{position:fixed;right:16px;bottom:74px;background:var(--brand);color:#fff;border:none;width:58px;height:58px;border-radius:50%;font-size:26px;box-shadow:0 10px 30px #10b98155;cursor:pointer}

.hidden{display:none}
.mini{font-size:12px;color:var(--muted)}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.stat{padding:12px;border-radius:12px;color:#064e3b;background:linear-gradient(135deg,#d1fae5,#ecfdf5)}
@media(min-width:720px){.stats{grid-template-columns:repeat(4,1fr)}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:center;font-size:14px}

/* Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù… */
.kids{margin-top:8px;border-top:1px dashed var(--line);padding-top:6px}
.kids h4{margin:6px 0;font-size:13px;color:#065f46}
.kids .kid{font-size:13px;color:#334155;display:flex;justify-content:space-between;padding:6px 8px;border:1px solid var(--line);border-radius:10px;margin:4px 0;background:#f8fafc}
.kids .group{background:#ecfdf5;border-color:#a7f3d0;padding:6px 8px;border-radius:10px;margin:6px 0}
.badge.birth{background:#fff7ed;border:1px solid #fdba74;color:#9a3412}
.toggle{cursor:pointer}

/* Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.mini-btn{padding:4px 8px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:12px}
.mini-btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}

/* Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª */
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
</style>
</head>
<body>

<div class="top">
  <div class="row">
    <h1>ğŸ‘ Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… <small>Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ù‘Ø· (PWA)</small></h1>
    <button class="btn" onclick="exportData()">ØªØµØ¯ÙŠØ±</button>
  </div>
  <div class="mini">Ù„Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©: Ø§ÙØªØ­ Ø¨Ù€ Safari â† Ù…Ø´Ø§Ø±ÙƒØ© â† Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</div>
</div>

<div class="wrap">
  <!-- Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <section id="tab-herd" class="card">
    <div style="padding:12px">
      <div class="stats">
        <div class="stat"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</div><div id="s_total" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ø£Ù…Ù‡Ø§Øª</div><div id="s_ewes" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ù…ÙˆØ§Ù„ÙŠØ¯ 30 ÙŠÙˆÙ…</div><div id="s_birth30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù 30 ÙŠÙˆÙ…</div><div id="s_feed30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ù…Ø¨Ø§Ø¹Ø© 30 ÙŠÙˆÙ…</div><div id="s_sold30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ø¥ÙŠØ±Ø§Ø¯ Ø¨ÙŠØ¹ 30 ÙŠÙˆÙ…</div><div id="s_rev30" style="font-weight:800;font-size:22px">0</div></div>
      </div>

      <div class="row" style="gap:10px;margin-top:4px;flex-wrap:wrap">
        <input id="q" oninput="renderList()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©" style="flex:2">
        <select id="fltStatus" onchange="renderList()" style="flex:1;min-width:170px">
          <option value="alive">Ø§Ù„Ø­ÙŠÙ‘Ø© ÙÙ‚Ø·</option>
          <option value="sold">Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>
        <select id="sort" onchange="renderList()" style="flex:1;min-width:160px">
          <option value="created">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="id">Ø§Ù„ÙˆØ³Ù…</option>
          <option value="dob">Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</option>
          <option value="group">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
        </select>
      </div>

      <div class="toolbar">
        <button class="btn gray" onclick="toggleSimpleMode(this)">ÙˆØ¶Ø¹ Ù…Ø¨Ø³Ù‘Ø· Ø¬Ø¯Ø§Ù‹: <span id="lblSimple">Ù…ØºÙ„Ù‚</span></button>
        <button class="btn gray" onclick="byId('fltStatus').value='sold';renderList()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</button>
        <button class="btn gray" onclick="go('tab-settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù‡Ù„Ø©</button>
      </div>
    </div>
    <div class="list" id="list"></div>
  </section>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© -->
  <section id="tab-add" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</h3>
      <div><label class="k">Ø§Ù„ÙˆØ³Ù…</label><input id="f_id" placeholder="Ù…Ø«Ø§Ù„: 105"></div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="f_sex"><option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option></select></div>
        <div style="flex:1"><label class="k">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <input id="f_group" list="dlGroups" placeholder="Ø£Ù…Ù‡Ø§Øª/Ù…ÙˆØ§Ù„ÙŠØ¯/ÙØ­ÙˆÙ„">
          <datalist id="dlGroups"></datalist>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="f_dob" type="date"></div>
        <div style="flex:1"><label class="k">Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="f_w" type="number" step="0.01" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="f_mom" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
        <div style="flex:1"><label class="k">Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)</label><input id="f_dad" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>
      <div><label class="k">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" onclick="clearQuick()">Ù…Ø³Ø­</button>
        <button class="btn solid" onclick="saveQuick()">Ø­ÙØ¸</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button class="btn ghost" onclick="openBirth()">ğŸ¼ ÙˆÙ„Ø§Ø¯Ø©</button>
        <button class="btn ghost" onclick="openWeightPrompt()">âš–ï¸ ÙˆØ²Ù†</button>
        <button class="btn ghost" onclick="openVacc()">ğŸ’‰ ØªØ·Ø¹ÙŠÙ…</button>
        <button class="btn warn" onclick="openMove()">Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡/Ù†ÙÙˆÙ‚</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
  <section id="tab-events" class="card hidden">
    <div style="padding:12px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" data-t="all"  onclick="filterEv(this)">Ø§Ù„ÙƒÙ„</button>
        <button class="btn" data-t="birth" onclick="filterEv(this)">ÙˆÙ„Ø§Ø¯Ø©</button>
        <button class="btn" data-t="weight" onclick="filterEv(this)">Ø£ÙˆØ²Ø§Ù†</button>
        <button class="btn" data-t="vaccination" onclick="filterEv(this)">ØªØ·Ø¹ÙŠÙ…</button>
        <button class="btn" data-t="movement" onclick="filterEv(this)">Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡</button>
        <button class="btn" data-t="feed" onclick="filterEv(this)">Ø¹Ù„Ù</button>
      </div>
    </div>
    <div class="list" id="events"></div>
  </section>

  <!-- Ø§Ù„Ø¹Ù„Ù / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
  <section id="tab-feed" class="card hidden">
    <div style="padding:14px;display:grid;gap:12px">
      <h3 style="margin:0">ğŸŒ¾ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label class="k">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="fd_type">
            <option>Ø´Ø±Ø§Ø¡ Ø¹Ù„Ù</option>
            <option>ØµØ±Ù Ø¹Ù„Ù</option>
            <option>Ù…ØµØ±ÙˆÙ Ø¢Ø®Ø±</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px"><label class="k">Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØµÙ</label><input id="fd_name" placeholder="Ø´Ø¹ÙŠØ±ØŒ Ø¨Ø±Ø³ÙŠÙ…ØŒ Ù…ÙƒØ¹Ø¨Ø§Øªâ€¦"></div>
        <div style="flex:1;min-width:160px"><label class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="fd_date" type="date"></div>
        <div style="flex:1;min-width:140px"><label class="k">Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</label><input id="fd_qty" type="number" step="0.01"></div>
        <div style="flex:1;min-width:160px"><label class="k">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</label><input id="fd_cost" type="number" step="0.01"></div>
      </div>
      <div><label class="k">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="fd_notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn solid" onclick="saveFeed()">Ø­ÙØ¸</button>
      </div>

      <h3 style="margin:10px 0 0 0">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</h3>
      <div style="overflow:auto">
        <table class="table" id="tblFeed"><thead>
          <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <section id="tab-settings" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>

      <div class="toolbar">
        <button class="btn gray" onclick="setTrain(!TRAIN)">ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨: <b id="lblTrain">Ù…ØºÙ„Ù‚</b></button>
        <button class="btn" onclick="clearTrain()">ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button>
      </div>

      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</label><input id="farm" oninput="saveSettings()"></div>
        <div style="flex:1"><label class="k">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label><input id="groups" oninput="saveSettings()" placeholder="Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹"></div>
      </div>
      <div class="mini">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ. Ù„Ù†Ù‚Ù„Ù‡Ø§ Ù„Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ±/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.</div>
      <div class="row" style="gap:10px">
        <label class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input id="imp" type="file" accept=".json" class="hidden" onchange="importData(event)"></label>
        <button class="btn" onclick="exportData()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <button class="btn warn" onclick="if(confirm('Ù…ØªØ£ÙƒØ¯ØŸ')){localStorage.removeItem(KEY);location.reload()}">ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø¹Ø§Ø¯ÙŠ)</button>
      </div>
    </div>
  </section>
</div>

<button class="fab" onclick="go('tab-add')">ï¼‹</button>

<div class="nav">
  <button id="b-herd" class="active" onclick="go('tab-herd')">Ø§Ù„Ù‚Ø·ÙŠØ¹</button>
  <button id="b-add" onclick="go('tab-add')">Ø¥Ø¶Ø§ÙØ©</button>
  <button id="b-events" onclick="go('tab-events')">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
  <button id="b-feed" onclick="go('tab-feed')">Ø§Ù„Ø¹Ù„Ù</button>
  <button id="b-settings" onclick="go('tab-settings')">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<script>
/* ======= Ø§Ù„Ù…ÙØ§ØªÙŠØ­ / ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ======= */
const KEY='sheep_data_pwa_v2';
const KEY_TRAIN='sheep_data_pwa_training';
let TRAIN=false; // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù…ØºÙ„Ù‚
let SIMPLE=false;

let DB = (()=>{ 
  try{ const t=localStorage.getItem(KEY); return t?JSON.parse(t):null }catch{ return null } 
})() || {sheep:{},events:[],finance:[],settings:{farm:'',groups:'Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹'}};

function save(){
  try{
    localStorage.setItem(TRAIN? KEY_TRAIN : KEY, JSON.stringify(DB));
  }catch(e){
    alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©.');
  }
}

/* ======= ØªÙ†Ù‚Ù‘Ù„ ======= */
function go(id){
  document.querySelectorAll('.card').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  const map={'tab-herd':'b-herd','tab-add':'b-add','tab-events':'b-events','tab-feed':'b-feed','tab-settings':'b-settings'};
  document.getElementById(map[id]).classList.add('active');
  if(id==='tab-herd'){ renderList(); statsToUI(); }
  if(id==='tab-events') renderEvents();
  if(id==='tab-feed') renderFeed();
  if(id==='tab-settings') renderSettings();
}

/* ======= Ø£Ø¯ÙˆØ§Øª ======= */
function byId(x){return document.getElementById(x)}
function dstr(){return new Date().toISOString().slice(0,10)}
function fmt(d){if(!d) return 'â€”'; try{return new Date(d).toLocaleDateString('ar')}catch(e){return d}}
function toggleSimpleMode(){ SIMPLE=!SIMPLE; byId('lblSimple').textContent=SIMPLE?'Ù…Ø´ØºÙ‘Ù„':'Ù…ØºÙ„Ù‚'; renderList(); }
function setTrain(on){ TRAIN=!!on; const raw=localStorage.getItem(TRAIN?KEY_TRAIN:KEY); if(raw){ try{ DB=JSON.parse(raw) }catch{} } renderSettings(); renderList(); renderEvents(); renderFeed(); statsToUI(); alert('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ '+(TRAIN?'ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨':'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ')); }
function clearTrain(){ localStorage.removeItem(KEY_TRAIN); if(TRAIN){ DB={sheep:{},events:[],finance:[],settings:{farm:'',groups:'Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹'}}; save(); } alert('ØªÙ… ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨'); renderList(); renderEvents(); renderFeed(); statsToUI(); }

/* ======= Ø¥Ø­ØµØ§Ø¡Ø§Øª ======= */
function getStats(){
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  const ewes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰').length;
  const since=new Date(); since.setDate(since.getDate()-30);
  const birth30=DB.events.filter(e=>e.type==='birth'&&new Date(e.date)>=since).length;
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const soldEvents=DB.events.filter(e=>e.type==='movement' && /Ø¨ÙŠØ¹/.test(e.details||'') && new Date(e.date)>=since);
  const sold30=soldEvents.length;
  const rev30=soldEvents.reduce((a,e)=>a+(+e.amount||0),0);
  return {total:alive.length,ewes,birth30,feed30,sold30,rev30};
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birth30').textContent=s.birth30;
  byId('s_feed30').textContent=s.feed30.toFixed(0);
  byId('s_sold30').textContent=s.sold30;
  byId('s_rev30').textContent=s.rev30.toFixed(0);
}

/* ======= Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù… / Ø§Ù„Ø¯ÙÙØ¹Ø§Øª ======= */
function getChildren(momId){
  return Object.values(DB.sheep).filter(ch => (ch.motherId||'').trim() === (momId||'').trim());
}
function groupChildrenByBirth(momId){
  const kids = getChildren(momId).slice().sort((a,b)=>(a.dob||'').localeCompare(b.dob||''));
  const map = {};
  kids.forEach(k=>{
    const key = k.dob || 'ØºÙŠØ± Ù…ÙØ³Ø¬Ù‘Ù„';
    (map[key] ||= []).push(k);
  });
  return map;
}
function toggleKids(momId){
  const row = document.getElementById('kids-'+momId);
  if(row) row.classList.toggle('hidden');
}
function latestBirthDate(momId){
  const groups = groupChildrenByBirth(momId);
  const dates = Object.keys(groups).filter(d => d && d !== 'ØºÙŠØ± Ù…ÙØ³Ø¬Ù‘Ù„');
  if(!dates.length) return dstr();
  dates.sort();
  return dates[dates.length-1];
}

/* ======= Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ„ÙˆØ¯/ØªÙˆØ£Ù…/Ø¯ÙØ¹Ø© ======= */
function addChild(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…'); return; }
  const next = getChildren(momId).length + 1;
  const suggested = momId + '-' + String(next).padStart(2,'0');
  go('tab-add');
  byId('f_id').value    = suggested;
  byId('f_sex').value   = 'Ø£Ù†Ø«Ù‰';
  byId('f_group').value = 'Ù…ÙˆØ§Ù„ÙŠØ¯';
  byId('f_dob').value   = dstr();
  byId('f_w').value     = '';
  byId('f_mom').value   = momId;
  byId('f_dad').value   = mom.fatherId || '';
  byId('f_notes').value = 'Ù…ÙˆÙ„ÙˆØ¯ Ù…Ù† Ø§Ù„Ø£Ù… '+momId;
  byId('f_id').focus();
}
function addTwin(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…'); return; }
  const next = getChildren(momId).length + 1;
  const suggested = momId + '-' + String(next).padStart(2,'0');
  go('tab-add');
  byId('f_id').value    = suggested;
  byId('f_sex').value   = 'Ø£Ù†Ø«Ù‰';
  byId('f_group').value = 'Ù…ÙˆØ§Ù„ÙŠØ¯';
  byId('f_dob').value   = latestBirthDate(momId);
  byId('f_w').value     = '';
  byId('f_mom').value   = momId;
  byId('f_dad').value   = mom.fatherId || '';
  byId('f_notes').value = 'ØªÙˆØ£Ù… Ù„Ù„Ø£Ù… '+momId;
  byId('f_id').focus();
}
function addMany(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…'); return; }
  let n = parseInt(prompt('ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ØŸ', '2')||'0', 10);
  if(!Number.isFinite(n) || n<=0){ alert('Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
  const sexAns = (prompt('Ø§Ù„Ø¬Ù†Ø³: Ø§ÙƒØªØ¨ "Ø£Ù†Ø«Ù‰" Ø£Ùˆ "Ø°ÙƒØ±" Ø£Ùˆ "Ù…Ø®ØªÙ„Ø·"', 'Ù…Ø®ØªÙ„Ø·')||'').trim();
  const mode = /Ø°ÙƒØ±/i.test(sexAns) ? 'M' : (/Ø£Ù†Ø«/i.test(sexAns) ? 'F' : 'X');
  const sameBatch = (prompt('Ù†ÙØ³ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹Ø©ØŸ (Ù†Ø¹Ù…/Ù„Ø§)', 'Ù†Ø¹Ù…')||'Ù†Ø¹Ù…').trim();
  const date = /^Ù†|^y|^Y|^yes|^Ù†Ø¹Ù…/.test(sameBatch) ? latestBirthDate(momId) : dstr();

  let next = getChildren(momId).length + 1;
  const nowISO = new Date().toISOString();
  for(let i=0;i<n;i++){
    const id = momId + '-' + String(next++).padStart(2,'0');
    let sex = 'Ø£Ù†Ø«Ù‰';
    if(mode==='M') sex = 'Ø°ÙƒØ±';
    else if(mode==='X') sex = (i%2===0 ? 'Ø£Ù†Ø«Ù‰' : 'Ø°ÙƒØ±');
    DB.sheep[id] = {
      id, sex, group:'Ù…ÙˆØ§Ù„ÙŠØ¯', dob:date, lastWeight:null,
      motherId:momId, fatherId:mom.fatherId||'',
      notes:'Ù…Ø¶Ø§Ù ÙƒØ¯ÙØ¹Ø©', status:'Ø­ÙŠØ©', createdAt:nowISO, updatedAt:nowISO
    };
  }
  DB.events.push({type:'birth', ids:[momId], date, details:`${n} Ù…ÙˆÙ„ÙˆØ¯`});
  save(); renderList(); statsToUI(); renderEvents?.();
  const kidsBox = document.getElementById('kids-'+momId); if(kidsBox) kidsBox.classList.remove('hidden');
  alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© '+n+' Ù…ÙˆØ§Ù„ÙŠØ¯ âœ…');
}

/* ======= Ø¨ÙŠØ¹ / Ø­Ø°Ù / ÙˆØ²Ù† ======= */
let _undo=null; // Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­Ø°Ù
function deleteSheep(id){
  const s=DB.sheep[id];
  if(!s){ alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  if(!confirm('Ø­Ø°Ù Ø§Ù„ÙˆØ³Ù… "'+id+'" ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ')) return;
  _undo={id,data:JSON.parse(JSON.stringify(s))};
  delete DB.sheep[id];
  DB.events = DB.events.filter(e => !(e.ids||[]).includes(id));
  save(); renderList(); statsToUI();
  if(confirm('ØªÙ… Ø§Ù„Ø­Ø°Ù. ØªØ¨ÙŠ ØªØ±Ø§Ø¬Ø¹ØŸ')){ DB.sheep[_undo.id]=_undo.data; save(); renderList(); statsToUI(); _undo=null; }
}
function sellSheep(id){
  const s=DB.sheep[id]; if(!s) return;
  const price = parseFloat(prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø±ÙŠØ§Ù„):','')||'');
  if(!isFinite(price)) return alert('Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­');
  const date  = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹ (YYYY-MM-DD)', dstr()) || dstr();
  s.status='Ù…Ø¨Ø§Ø¹Ø©';
  s.soldPrice=price;
  s.soldDate=date;
  s.updatedAt=new Date().toISOString();
  DB.events.push({type:'movement',ids:[id],date,details:'Ø¨ÙŠØ¹',amount:price});
  save(); renderList(); statsToUI(); renderEvents();
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ„ØªØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù…Ø¨Ø§Ø¹Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø¨Ø¹ØªÙ‡
  byId('fltStatus').value='sold'; renderList();
  alert('ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ âœ…');
}
function edit(id){
  const s=DB.sheep[id]; if(!s) return;
  byId('f_id').value=s.id; byId('f_sex').value=s.sex||'Ø£Ù†Ø«Ù‰'; byId('f_group').value=s.group||'';
  byId('f_dob').value=s.dob||''; byId('f_w').value=s.lastWeight??''; byId('f_mom').value=s.motherId||''; byId('f_dad').value=s.fatherId||'';
  byId('f_notes').value=s.notes||''; go('tab-add');
}
function weight(id){
  const s=DB.sheep[id]; if(!s) return;
  const v=prompt('Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):', s.lastWeight ?? '');
  if(v==null) return;
  const w=parseFloat(v);
  if(!isFinite(w)) return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:`${w} ÙƒØ¬Ù…`});
  save(); renderList(); statsToUI(); go('tab-herd');
}

/* ======= Ø§Ù„Ù‚Ø·ÙŠØ¹ (Ù‚Ø§Ø¦Ù…Ø©) ======= */
function renderList(){
  const q=(byId('q')?.value||'').toLowerCase();
  const sort=byId('sort')?.value||'created';
  const flt=byId('fltStatus')?.value||'alive';
  let arr=Object.values(DB.sheep);

  if(q){
    arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)
      ||(s.group||'').toLowerCase().includes(q)
      ||(s.status||'').toLowerCase().includes(q));
  }
  if(flt==='alive') arr=arr.filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  else if(flt==='sold') arr=arr.filter(s=>s.status==='Ù…Ø¨Ø§Ø¹Ø©');

  arr.sort((a,b)=>{
    if(sort==='id') return (a.id||'').localeCompare(b.id||'');
    if(sort==='dob') return (b.dob||'').localeCompare(a.dob||'');
    if(sort==='group') return (a.group||'').localeCompare(b.group||'');
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });

  const box=byId('list'); box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="item"><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù‡Ù†Ø§.. ØºÙŠÙ‘Ø± Ø§Ù„ÙÙ„ØªØ± Ø£Ùˆ Ø§Ø¶ØºØ· + Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³ Ø¬Ø¯ÙŠØ¯</div></div>'; return; }

  arr.forEach(s=>{
    const isEwe = (s.sex||'').includes('Ø£Ù†Ø«');
    const birthsGrouped = isEwe ? groupChildrenByBirth(s.id) : {};
    const birthsCount   = isEwe ? Object.keys(birthsGrouped).length : 0;

    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div style="flex:1">
        <div class="row">
          <b>${s.id||''}</b>
          ${
            SIMPLE
            ? ''
            : `<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                 <span class="badge">${s.group||'â€”'}</span>
                 ${s.status==='Ù…Ø¨Ø§Ø¹Ø©' ? '<span class="badge" style="background:#fee2e2;border-color:#fecaca;color:#991b1b">Ù…Ø¨Ø§Ø¹Ø©'+(s.soldPrice!=null?(' â€¢ '+s.soldPrice+'Ø±.Ø³'):'')+'</span>':''}
                 ${isEwe ? `<span class="badge birth toggle" title="Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡" onclick="toggleKids('${s.id}')">ğŸ¼ ${birthsCount}</span>`:''}
               </div>`
          }
        </div>
        <div class="k">${s.sex||''} â€¢ ${s.status||'Ø­ÙŠØ©'} â€¢ ${fmt(s.dob)} ${s.lastWeight!=null?('â€¢ '+s.lastWeight+' ÙƒØ¬Ù…'):''}</div>

        ${
          (isEwe && !SIMPLE)
          ? `<div id="kids-${s.id}" class="kids hidden">
               ${
                 Object.keys(birthsGrouped).length
                 ? Object.entries(birthsGrouped).map(([date,list])=>`
                   <div class="group">
                     <h4>Ø¯ÙØ¹Ø© ${date==='ØºÙŠØ± Ù…ÙØ³Ø¬Ù‘Ù„'?'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®':fmt(date)} â€” ${list.length} ${list.length>1?'Ù…ÙˆØ§Ù„ÙŠØ¯':'Ù…ÙˆÙ„ÙˆØ¯'}</h4>
                     ${list.map(ch=>`
                       <div class="kid">
                         <div><b>${ch.id||''}</b> â€¢ ${ch.sex||''} ${ch.lastWeight!=null?('â€¢ '+ch.lastWeight+' ÙƒØ¬Ù…'):''}</div>
                         <div class="k">${ch.group||''}</div>
                       </div>
                     `).join('')}
                   </div>
                 `).join('')
                 : `<div class="k">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù… Ø¨Ø¹Ø¯.</div>`
               }
             </div>`
          : ''
        }
      </div>

      <div class="row" style="gap:6px;flex-wrap:wrap">
        ${ isEwe && s.status!=='Ù…Ø¨Ø§Ø¹Ø©' ? `<button class="btn gray" onclick="addChild('${s.id}')">ï¼‹ Ù…ÙˆÙ„ÙˆØ¯</button>` : '' }
        ${ isEwe && !SIMPLE && s.status!=='Ù…Ø¨Ø§Ø¹Ø©' ? `<button class="btn gray" onclick="addTwin('${s.id}')">ï¼‹ ØªÙˆØ£Ù…</button>` : '' }
        ${ isEwe && !SIMPLE && s.status!=='Ù…Ø¨Ø§Ø¹Ø©' ? `<button class="btn gray" onclick="addMany('${s.id}')">ï¼‹ Ù…ØªØ¹Ø¯Ø¯</button>` : '' }
        ${ s.status!=='Ù…Ø¨Ø§Ø¹Ø©' ? `<button class="btn warn" onclick="sellSheep('${s.id}')">ğŸ’¸ Ø¨ÙŠØ¹</button>` : '' }
        <button class="btn" onclick="edit('${s.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="weight('${s.id}')">âš–ï¸</button>
        <button class="btn danger" onclick="deleteSheep('${s.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;
    box.appendChild(el);
  });
}

/* ======= Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© ======= */
function clearQuick(){['f_id','f_group','f_dob','f_w','f_mom','f_dad','f_notes'].forEach(x=>byId(x).value=''); byId('f_sex').value='Ø£Ù†Ø«Ù‰'}
function saveQuick(){
  const id=(byId('f_id').value||'').trim();
  if(!id) return alert('Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØ³Ù…');
  const s={
    id,
    sex:byId('f_sex').value||'Ø£Ù†Ø«Ù‰',
    group:byId('f_group').value||'',
    dob:byId('f_dob').value||'',
    lastWeight: byId('f_w').value?parseFloat(byId('f_w').value):null,
    motherId:byId('f_mom').value||'',
    fatherId:byId('f_dad').value||'',
    notes:byId('f_notes').value||'',
    status: DB.sheep[id]?.status || 'Ø­ÙŠØ©',
    soldPrice: DB.sheep[id]?.soldPrice ?? null,
    soldDate:  DB.sheep[id]?.soldDate  ?? '',
    createdAt: DB.sheep[id]?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  DB.sheep[id]=s; save();
  clearQuick(); statsToUI(); renderList(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'); go('tab-herd');
}

/* ======= Ø³Ø¬Ù„Ø§Øª ======= */
let EV_FILTER='all';
function filterEv(btn){EV_FILTER=btn.dataset.t; renderEvents()}
function renderEvents(){
  const box=byId('events'); box.innerHTML='';
  let arr=DB.events.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  if(EV_FILTER!=='all') arr=arr.filter(e=>e.type===EV_FILTER);
  if(!arr.length){ box.innerHTML='<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>'; return; }
  const map={birth:'ğŸ¼ ÙˆÙ„Ø§Ø¯Ø©',weight:'âš–ï¸ ÙˆØ²Ù†',vaccination:'ğŸ’‰ ØªØ·Ø¹ÙŠÙ…',movement:'ğŸ” Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡',feed:'ğŸŒ¾ Ø¹Ù„Ù'};
  arr.forEach(e=>{
    const el=document.createElement('div'); el.className='item';
    const det=(e.type==='movement'&&/Ø¨ÙŠØ¹/.test(e.details||'')) ? (e.details+' â€” '+(e.amount||0)+' Ø±.Ø³') : (e.details||'');
    el.innerHTML=`<div style="flex:1"><b>${map[e.type]||e.type}</b><div class="k">${det}</div></div><div class="k">${fmt(e.date)}</div>`;
    box.appendChild(el);
  });
}

/* ======= Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© (ÙˆÙ„Ø§Ø¯Ø©/ØªØ·Ø¹ÙŠÙ…/Ø­Ø±ÙƒØ©) ======= */
function openBirth(){
  const mom=prompt('ÙˆØ³Ù… Ø§Ù„Ø£Ù…ØŸ'); if(!mom) return;
  const cnt=parseInt(prompt('Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ØŸ (1/2/..)')||'1',10);
  DB.events.push({type:'birth',ids:[mom],date:dstr(),details:`${cnt} Ù…ÙˆÙ„ÙˆØ¯`});
  save(); alert('Ø³ÙØ¬Ù‘Ù„Øª Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©'); statsToUI(); renderEvents(); go('tab-events');
}
function openWeightPrompt(){
  const id=prompt('ÙˆØ³Ù… Ø§Ù„Ø±Ø£Ø³ØŸ'); if(!id||!DB.sheep[id]) return alert('Ø§Ù„ÙˆØ³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  weight(id);
}
function openVacc(){
  const ids=(prompt('Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const name=prompt('Ø§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­ØŸ')||'Ù„Ù‚Ø§Ø­';
  const next=prompt('Ù…ÙˆØ¹Ø¯ Ù‚Ø§Ø¯Ù… (YYYY-MM-DD) Ø§Ø®ØªÙŠØ§Ø±ÙŠ')||'';
  ids.forEach(id=>{
    if(DB.sheep[id]){ DB.sheep[id].vaccinations=(DB.sheep[id].vaccinations||[]); DB.sheep[id].vaccinations.push({name,date:dstr(),next}); }
  });
  DB.events.push({type:'vaccination',ids,date:dstr(),details:`${name}${next? ' â€” Ø§Ù„Ù‚Ø§Ø¯Ù…: '+next:''}`});
  save(); alert('ØªÙ… Ø§Ù„ØªØ·Ø¹ÙŠÙ…'); renderEvents(); go('tab-events');
}
function openMove(){
  const type=prompt('Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: Ø¨ÙŠØ¹ / Ø´Ø±Ø§Ø¡ / Ù†ÙÙˆÙ‚ / Ù†Ù‚Ù„')||'Ø¨ÙŠØ¹';
  const ids=(prompt('Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const date=dstr();
  let det=type; let amt=null; let to='';
  if(type==='Ø¨ÙŠØ¹'||type==='Ø´Ø±Ø§Ø¡'){ amt=parseFloat(prompt('Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±ÙŠØ§Ù„)')||'0'); det+=` â€” ${amt} Ø±ÙŠØ§Ù„`; }
  if(type==='Ù†Ù‚Ù„'){ to=prompt('Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ')||''; det+=to?` â€” Ø¥Ù„Ù‰ ${to}`:''; }
  ids.forEach(id=>{
    const s=DB.sheep[id]; if(!s) return;
    if(type==='Ø¨ÙŠØ¹'){ s.status='Ù…Ø¨Ø§Ø¹Ø©'; s.soldPrice=amt; s.soldDate=date; }
    else if(type==='Ø´Ø±Ø§Ø¡') s.status='Ø­ÙŠØ©';
    else if(type==='Ù†ÙÙˆÙ‚') s.status='Ù†Ø§ÙÙ‚Ø©';
    else if(type==='Ù†Ù‚Ù„') s.group=to;
    s.updatedAt=new Date().toISOString();
  });
  DB.events.push({type:'movement',ids,date,details:det,amount:(type==='Ø¨ÙŠØ¹'&&amt)?amt:0});
  save(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©'); renderEvents(); renderList(); statsToUI(); go('tab-events');
}

/* ======= Ø§Ù„Ø¹Ù„Ù/Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ======= */
function renderFeed(){
  const tb=byId('tblFeed').querySelector('tbody'); tb.innerHTML='';
  DB.finance.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.type}</td><td>${r.name||'â€”'}</td><td>${r.qty||0}</td><td>${r.cost||0}</td><td>${r.notes||''}</td>`;
    tb.appendChild(tr);
  });
}
function saveFeed(){
  const t=byId('fd_type').value,
        name=byId('fd_name').value||'',
        date=byId('fd_date').value||dstr(),
        qty=byId('fd_qty').value?parseFloat(byId('fd_qty').value):0,
        cost=byId('fd_cost').value?parseFloat(byId('fd_cost').value):0,
        notes=byId('fd_notes').value||'';
  DB.finance.push({type:t,name,date,qty,cost,notes});
  DB.events.push({type:'feed',ids:[],date,details:`${t} â€” ${name} â€” ${qty||0} ÙƒØ¬Ù… â€” ${cost||0} Ø±ÙŠØ§Ù„ ${notes? ' â€” '+notes:''}`});
  save();
  byId('fd_name').value=''; byId('fd_qty').value=''; byId('fd_cost').value=''; byId('fd_notes').value='';
  renderFeed(); statsToUI(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}

/* ======= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ======= */
function renderSettings(){
  byId('farm').value=DB.settings.farm||'';
  byId('groups').value=DB.settings.groups||'';
  byId('lblTrain').textContent = TRAIN? 'Ù…Ø´ØºÙ‘Ù„' : 'Ù…ØºÙ„Ù‚';
  const dl=byId('dlGroups'); dl.innerHTML='';
  (DB.settings.groups||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(g=>{
    const o=document.createElement('option'); o.value=g; dl.appendChild(o);
  });
}
function saveSettings(){ DB.settings.farm=byId('farm').value; DB.settings.groups=byId('groups').value; save(); renderSettings(); }

/* ======= ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ======= */
function exportData(){ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sheep-data.json'; a.click(); }
function importData(ev){ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); go('tab-herd'); renderList(); renderEvents(); renderFeed(); renderSettings(); statsToUI(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } }; r.readAsText(f); }

/* ØªÙ‡ÙŠØ¦Ø© */
go('tab-herd'); renderSettings(); statsToUI();

/* PWA */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=2').catch(console.warn); }); }
</script>
</body>
</html>
