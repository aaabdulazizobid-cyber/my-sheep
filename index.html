<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… â€” Ø§Ù„Ù…Ø¨Ø³Ù‘Ø· (PWA)</title>
<link rel="manifest" href="manifest.webmanifest?v=2">
<meta name="theme-color" content="#10b981">
<link rel="apple-touch-icon" href="icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b;
}
*{box-sizing:border-box} html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px}
.top h1{margin:0;font-size:18px;font-weight:800}
.top small{opacity:.9;font-size:12px}
.wrap{max-width:900px;margin:auto;padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.list{overflow:auto}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75}
.row{display:flex;justify-content:space-between;align-items:center}
.k{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#f9fafb}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.nav{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr)}
.nav button{padding:10px 6px;background:#fff;border:0}
.nav button.active{color:var(--brand);font-weight:700}
.fab{position:fixed;right:16px;bottom:74px;background:var(--brand);color:#fff;border:none;width:58px;height:58px;border-radius:50%;font-size:26px;box-shadow:0 10px 30px #10b98155;cursor:pointer}
.hidden{display:none}
.mini{font-size:12px;color:var(--muted)}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.stat{padding:12px;border-radius:12px;color:#064e3b;background:linear-gradient(135deg,#d1fae5,#ecfdf5)}
@media(min-width:720px){.stats{grid-template-columns:repeat(4,1fr)}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:center;font-size:14px}
</style>
</head>
<body>

<div class="top">
  <div class="row">
    <h1>ğŸ‘ Ø¯ÙØªØ± Ø§Ù„ØºÙ†Ù… <small>Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ù‘Ø· (PWA)</small></h1>
    <button class="btn" onclick="exportData()">ØªØµØ¯ÙŠØ±</button>
  </div>
  <div class="mini">Ù„Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©: Ø§ÙØªØ­ Ø¨Ù€ Safari â† Ù…Ø´Ø§Ø±ÙƒØ© â† Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</div>
</div>

<div class="wrap">
  <!-- Ø§Ù„Ù‚Ø·ÙŠØ¹ -->
  <section id="tab-herd" class="card">
    <div style="padding:12px">
      <div class="stats">
        <div class="stat"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø­ÙŠØ©)</div><div id="s_total" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ø£Ù…Ù‡Ø§Øª</div><div id="s_ewes" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">Ù…ÙˆØ§Ù„ÙŠØ¯ 30 ÙŠÙˆÙ…</div><div id="s_birth30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù„Ù 30 ÙŠÙˆÙ…</div><div id="s_feed30" style="font-weight:800;font-size:22px">0</div></div>
      </div>
      <div class="row" style="gap:10px;margin-top:4px">
        <input id="q" oninput="renderList()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØ³Ù…/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©/Ø§Ù„Ø­Ø§Ù„Ø©">
        <select id="sort" onchange="renderList()">
          <option value="created">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="id">Ø§Ù„ÙˆØ³Ù…</option>
          <option value="dob">Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</option>
          <option value="group">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
        </select>
      </div>
    </div>
    <div class="list" id="list"></div>
  </section>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© -->
  <section id="tab-add" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</h3>
      <div><label class="k">Ø§Ù„ÙˆØ³Ù…</label><input id="f_id" placeholder="Ù…Ø«Ø§Ù„: 105"></div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="f_sex"><option>Ø£Ù†Ø«Ù‰</option><option>Ø°ÙƒØ±</option></select></div>
        <div style="flex:1"><label class="k">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <input id="f_group" list="dlGroups" placeholder="Ø£Ù…Ù‡Ø§Øª/Ù…ÙˆØ§Ù„ÙŠØ¯/ÙØ­ÙˆÙ„">
          <datalist id="dlGroups"></datalist>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="f_dob" type="date"></div>
        <div style="flex:1"><label class="k">Ø¢Ø®Ø± ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="f_w" type="number" step="0.01" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ù„Ø£Ù… (ÙˆØ³Ù…)</label><input id="f_mom" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
        <div style="flex:1"><label class="k">Ø§Ù„Ø£Ø¨ (ÙˆØ³Ù…)</label><input id="f_dad" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>
      <div><label class="k">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" onclick="clearQuick()">Ù…Ø³Ø­</button>
        <button class="btn solid" onclick="saveQuick()">Ø­ÙØ¸</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)">
      <div class="row" style="gap:10px">
        <button class="btn ghost" onclick="openBirth()">ğŸ¼ ÙˆÙ„Ø§Ø¯Ø©</button>
        <button class="btn ghost" onclick="openWeightPrompt()">âš–ï¸ ÙˆØ²Ù†</button>
        <button class="btn ghost" onclick="openVacc()">ğŸ’‰ ØªØ·Ø¹ÙŠÙ…</button>
        <button class="btn warn" onclick="openMove()">Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡/Ù†ÙÙˆÙ‚</button>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
  <section id="tab-events" class="card hidden">
    <div style="padding:12px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" data-t="all"  onclick="filterEv(this)">Ø§Ù„ÙƒÙ„</button>
        <button class="btn" data-t="birth" onclick="filterEv(this)">ÙˆÙ„Ø§Ø¯Ø©</button>
        <button class="btn" data-t="weight" onclick="filterEv(this)">Ø£ÙˆØ²Ø§Ù†</button>
        <button class="btn" data-t="vaccination" onclick="filterEv(this)">ØªØ·Ø¹ÙŠÙ…</button>
        <button class="btn" data-t="movement" onclick="filterEv(this)">Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡</button>
        <button class="btn" data-t="feed" onclick="filterEv(this)">Ø¹Ù„Ù</button>
      </div>
    </div>
    <div class="list" id="events"></div>
  </section>

  <!-- Ø§Ù„Ø¹Ù„Ù / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
  <section id="tab-feed" class="card hidden">
    <div style="padding:14px;display:grid;gap:12px">
      <h3 style="margin:0">ğŸŒ¾ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù/Ù…ØµØ±ÙˆÙ</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label class="k">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="fd_type">
            <option>Ø´Ø±Ø§Ø¡ Ø¹Ù„Ù</option>
            <option>ØµØ±Ù Ø¹Ù„Ù</option>
            <option>Ù…ØµØ±ÙˆÙ Ø¢Ø®Ø±</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px"><label class="k">Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØµÙ</label><input id="fd_name" placeholder="Ø´Ø¹ÙŠØ±ØŒ Ø¨Ø±Ø³ÙŠÙ…ØŒ Ù…ÙƒØ¹Ø¨Ø§Øªâ€¦"></div>
        <div style="flex:1;min-width:160px"><label class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="fd_date" type="date"></div>
        <div style="flex:1;min-width:140px"><label class="k">Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</label><input id="fd_qty" type="number" step="0.01"></div>
        <div style="flex:1;min-width:160px"><label class="k">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</label><input id="fd_cost" type="number" step="0.01"></div>
      </div>
      <div><label class="k">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="fd_notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn solid" onclick="saveFeed()">Ø­ÙØ¸</button>
      </div>

      <h3 style="margin:10px 0 0 0">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</h3>
      <div style="overflow:auto">
        <table class="table" id="tblFeed"><thead>
          <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <section id="tab-settings" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</label><input id="farm" oninput="saveSettings()"></div>
        <div style="flex:1"><label class="k">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label><input id="groups" oninput="saveSettings()" placeholder="Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹"></div>
      </div>
      <div class="mini">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ. Ù„Ù†Ù‚Ù„Ù‡Ø§ Ù„Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ±/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.</div>
      <div class="row" style="gap:10px">
        <label class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯<input id="imp" type="file" accept=".json" class="hidden" onchange="importData(event)"></label>
        <button class="btn" onclick="exportData()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <button class="btn warn" onclick="if(confirm('Ù…ØªØ£ÙƒØ¯ØŸ')){localStorage.removeItem(KEY);location.reload()}">ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </section>
</div>

<button class="fab" onclick="go('tab-add')">ï¼‹</button>

<div class="nav">
  <button id="b-herd" class="active" onclick="go('tab-herd')">Ø§Ù„Ù‚Ø·ÙŠØ¹</button>
  <button id="b-add" onclick="go('tab-add')">Ø¥Ø¶Ø§ÙØ©</button>
  <button id="b-events" onclick="go('tab-events')">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
  <button id="b-feed" onclick="go('tab-feed')">Ø§Ù„Ø¹Ù„Ù</button>
  <button id="b-settings" onclick="go('tab-settings')">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<script>
/* ======= Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ======= */
const KEY='sheep_data_pwa_v2';
let DB = (()=>{ try{ const t=localStorage.getItem(KEY); return t?JSON.parse(t):null }catch{ return null } })()
   || {sheep:{},events:[],finance:[],settings:{farm:'',groups:'Ø£Ù…Ù‡Ø§Øª, ÙØ­ÙˆÙ„, Ù…ÙˆØ§Ù„ÙŠØ¯, ØªØ³Ù…ÙŠÙ†, Ù„Ù„Ø¨ÙŠØ¹'}};
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(DB)); }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø© Ø£Ùˆ Ù…Ø­Ø¸ÙˆØ±Ø©.'); } }

/* ======= ØªÙ†Ù‚Ù‘Ù„ ======= */
function go(id){
  document.querySelectorAll('.card').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  const map={'tab-herd':'b-herd','tab-add':'b-add','tab-events':'b-events','tab-feed':'b-feed','tab-settings':'b-settings'};
  document.getElementById(map[id]).classList.add('active');
  if(id==='tab-herd'){ renderList(); statsToUI(); }
  if(id==='tab-events') renderEvents();
  if(id==='tab-feed') renderFeed();
  if(id==='tab-settings') renderSettings();
}

/* ======= Ø£Ø¯ÙˆØ§Øª ======= */
function byId(x){return document.getElementById(x)}
function dstr(){return new Date().toISOString().slice(0,10)}
function fmt(d){if(!d) return 'â€”'; try{return new Date(d).toLocaleDateString('ar')}catch(e){return d}}

/* ======= Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ======= */
function getStats(){
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='Ù…Ø¨Ø§Ø¹Ø©'&&s.status!=='Ù†Ø§ÙÙ‚Ø©');
  const ewes=alive.filter(s=>s.sex==='Ø£Ù†Ø«Ù‰').length;
  const since=new Date(); since.setDate(since.getDate()-30);
  const birth30=DB.events.filter(e=>e.type==='birth'&&new Date(e.date)>=since).length;
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  return {total:alive.length,ewes,birth30,feed30};
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birth30').textContent=s.birth30;
  byId('s_feed30').textContent=s.feed30.toFixed(0);
}

/* ======= Ø§Ù„Ù‚Ø·ÙŠØ¹ ======= */
function renderList(){
  const q=(byId('q')?.value||'').toLowerCase();
  const sort=byId('sort')?.value||'created';
  let arr=Object.values(DB.sheep);
  if(q){arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)||(s.group||'').toLowerCase().includes(q)||(s.status||'').toLowerCase().includes(q))}
  arr.sort((a,b)=>{
    if(sort==='id') return (a.id||'').localeCompare(b.id||'');
    if(sort==='dob') return (b.dob||'').localeCompare(a.dob||'');
    if(sort==='group') return (a.group||'').localeCompare(b.group||'');
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });
  const box=byId('list'); box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="item"><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.. Ø§Ø¶ØºØ· + Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø±Ø£Ø³</div></div>'; return; }
  arr.forEach(s=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div style="flex:1">
        <div class="row"><b>${s.id||''}</b> <span class="badge">${s.group||'â€”'}</span></div>
        <div class="k">${s.sex||''} â€¢ ${s.status||'Ø­ÙŠØ©'} â€¢ ${fmt(s.dob)} ${s.lastWeight!=null?('â€¢ '+s.lastWeight+' ÙƒØ¬Ù…'):''}</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="edit('${s.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="weight('${s.id}')">âš–ï¸</button>
      </div>`;
    box.appendChild(el);
  });
}
function edit(id){
  const s=DB.sheep[id]; if(!s) return;
  byId('f_id').value=s.id; byId('f_sex').value=s.sex||'Ø£Ù†Ø«Ù‰'; byId('f_group').value=s.group||'';
  byId('f_dob').value=s.dob||''; byId('f_w').value=s.lastWeight??''; byId('f_mom').value=s.motherId||''; byId('f_dad').value=s.fatherId||'';
  byId('f_notes').value=s.notes||''; go('tab-add');
}
function weight(id){
  const s=DB.sheep[id]; if(!s) return;
  const v=prompt('Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):', s.lastWeight ?? '');
  if(v==null) return;
  const w=parseFloat(v);
  if(!isFinite(w)) return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:`${w} ÙƒØ¬Ù…`});
  save(); renderList(); statsToUI(); go('tab-herd');
}

/* ======= Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© ======= */
function clearQuick(){['f_id','f_group','f_dob','f_w','f_mom','f_dad','f_notes'].forEach(x=>byId(x).value=''); byId('f_sex').value='Ø£Ù†Ø«Ù‰'}
function saveQuick(){
  const id=(byId('f_id').value||'').trim();
  if(!id) return alert('Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØ³Ù…');
  const s={
    id,
    sex:byId('f_sex').value||'Ø£Ù†Ø«Ù‰',
    group:byId('f_group').value||'',
    dob:byId('f_dob').value||'',
    lastWeight: byId('f_w').value?parseFloat(byId('f_w').value):null,
    motherId:byId('f_mom').value||'',
    fatherId:byId('f_dad').value||'',
    notes:byId('f_notes').value||'',
    status: DB.sheep[id]?.status || 'Ø­ÙŠØ©',
    createdAt: DB.sheep[id]?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  DB.sheep[id]=s; save();
  clearQuick(); statsToUI(); renderList(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'); go('tab-herd');
}

/* ======= Ø³Ø¬Ù„Ø§Øª ======= */
let EV_FILTER='all';
function filterEv(btn){EV_FILTER=btn.dataset.t; renderEvents()}
function renderEvents(){
  const box=byId('events'); box.innerHTML='';
  let arr=DB.events.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  if(EV_FILTER!=='all') arr=arr.filter(e=>e.type===EV_FILTER);
  if(!arr.length){ box.innerHTML='<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>'; return; }
  const map={birth:'ğŸ¼ ÙˆÙ„Ø§Ø¯Ø©',weight:'âš–ï¸ ÙˆØ²Ù†',vaccination:'ğŸ’‰ ØªØ·Ø¹ÙŠÙ…',movement:'ğŸ” Ø­Ø±ÙƒØ©',feed:'ğŸŒ¾ Ø¹Ù„Ù'};
  arr.forEach(e=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div style="flex:1"><b>${map[e.type]||e.type}</b><div class="k">${e.details||''}</div></div><div class="k">${fmt(e.date)}</div>`;
    box.appendChild(el);
  });
}

/* ======= Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© (ÙˆÙ„Ø§Ø¯Ø©/ØªØ·Ø¹ÙŠÙ…/Ø­Ø±ÙƒØ©) ======= */
function openBirth(){
  const mom=prompt('ÙˆØ³Ù… Ø§Ù„Ø£Ù…ØŸ'); if(!mom) return;
  const cnt=parseInt(prompt('Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ØŸ (1/2/..)')||'1',10);
  DB.events.push({type:'birth',ids:[mom],date:dstr(),details:`${cnt} Ù…ÙˆÙ„ÙˆØ¯`});
  save(); alert('Ø³ÙØ¬Ù‘Ù„Øª Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©'); statsToUI(); renderEvents(); go('tab-events');
}
function openWeightPrompt(){
  const id=prompt('ÙˆØ³Ù… Ø§Ù„Ø±Ø£Ø³ØŸ'); if(!id||!DB.sheep[id]) return alert('Ø§Ù„ÙˆØ³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  weight(id);
}
function openVacc(){
  const ids=(prompt('Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const name=prompt('Ø§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­ØŸ')||'Ù„Ù‚Ø§Ø­';
  const next=prompt('Ù…ÙˆØ¹Ø¯ Ù‚Ø§Ø¯Ù… (YYYY-MM-DD) Ø§Ø®ØªÙŠØ§Ø±ÙŠ')||'';
  ids.forEach(id=>{
    if(DB.sheep[id]){ DB.sheep[id].vaccinations=(DB.sheep[id].vaccinations||[]); DB.sheep[id].vaccinations.push({name,date:dstr(),next}); }
  });
  DB.events.push({type:'vaccination',ids,date:dstr(),details:`${name}${next? ' â€” Ø§Ù„Ù‚Ø§Ø¯Ù…: '+next:''}`});
  save(); alert('ØªÙ… Ø§Ù„ØªØ·Ø¹ÙŠÙ…'); renderEvents(); go('tab-events');
}
function openMove(){
  const type=prompt('Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: Ø¨ÙŠØ¹ / Ø´Ø±Ø§Ø¡ / Ù†ÙÙˆÙ‚ / Ù†Ù‚Ù„')||'Ø¨ÙŠØ¹';
  const ids=(prompt('Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const date=dstr();
  let det=type; let amt=null; let to='';
  if(type==='Ø¨ÙŠØ¹'||type==='Ø´Ø±Ø§Ø¡'){ amt=parseFloat(prompt('Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±ÙŠØ§Ù„)')||'0'); det+=` â€” ${amt} Ø±ÙŠØ§Ù„`; }
  if(type==='Ù†Ù‚Ù„'){ to=prompt('Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ')||''; det+=to?` â€” Ø¥Ù„Ù‰ ${to}`:''; }
  ids.forEach(id=>{
    const s=DB.sheep[id]; if(!s) return;
    if(type==='Ø¨ÙŠØ¹') s.status='Ù…Ø¨Ø§Ø¹Ø©';
    else if(type==='Ø´Ø±Ø§Ø¡') s.status='Ø­ÙŠØ©';
    else if(type==='Ù†ÙÙˆÙ‚') s.status='Ù†Ø§ÙÙ‚Ø©';
    else if(type==='Ù†Ù‚Ù„') s.group=to;
    s.updatedAt=new Date().toISOString();
  });
  DB.events.push({type:'movement',ids,date,details:det,amount:(type==='Ø¨ÙŠØ¹'&&amt)?amt:0});
  save(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©'); renderEvents(); renderList(); statsToUI(); go('tab-events');
}

/* ======= Ø§Ù„Ø¹Ù„Ù/Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ======= */
function renderFeed(){
  const tb=byId('tblFeed').querySelector('tbody'); tb.innerHTML='';
  DB.finance.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.type}</td><td>${r.name||'â€”'}</td><td>${r.qty||0}</td><td>${r.cost||0}</td><td>${r.notes||''}</td>`;
    tb.appendChild(tr);
  });
}
function saveFeed(){
  const t=byId('fd_type').value,
        name=byId('fd_name').value||'',
        date=byId('fd_date').value||dstr(),
        qty=byId('fd_qty').value?parseFloat(byId('fd_qty').value):0,
        cost=byId('fd_cost').value?parseFloat(byId('fd_cost').value):0,
        notes=byId('fd_notes').value||'';
  DB.finance.push({type:t,name,date,qty,cost,notes});
  DB.events.push({type:'feed',ids:[],date,details:`${t} â€” ${name} â€” ${qty||0} ÙƒØ¬Ù… â€” ${cost||0} Ø±ÙŠØ§Ù„ ${notes? ' â€” '+notes:''}`});
  save();
  byId('fd_name').value=''; byId('fd_qty').value=''; byId('fd_cost').value=''; byId('fd_notes').value='';
  renderFeed(); statsToUI(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}

/* ======= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ======= */
function renderSettings(){
  byId('farm').value=DB.settings.farm||'';
  byId('groups').value=DB.settings.groups||'';
  const dl=byId('dlGroups'); dl.innerHTML='';
  (DB.settings.groups||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(g=>{
    const o=document.createElement('option'); o.value=g; dl.appendChild(o);
  });
}
function saveSettings(){ DB.settings.farm=byId('farm').value; DB.settings.groups=byId('groups').value; save(); renderSettings(); }

/* ======= ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ======= */
function exportData(){ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sheep-data.json'; a.click(); }
function importData(ev){ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); go('tab-herd'); renderList(); renderEvents(); renderFeed(); renderSettings(); statsToUI(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } }; r.readAsText(f); }

/* ØªÙ‡ÙŠØ¦Ø© */
go('tab-herd'); renderSettings(); statsToUI();

/* PWA */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=2').catch(console.warn); }); }
</script>
</body>
</html>
