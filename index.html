<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>دفتر الغنم — المبسّط (PWA)</title>
<link rel="manifest" href="manifest.webmanifest?v=2">
<meta name="theme-color" content="#10b981">
<link rel="apple-touch-icon" href="icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --brand:#10b981;--brand2:#34d399;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--warn:#f59e0b;
}
*{box-sizing:border-box} html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,sans-serif;background:var(--bg);color:var(--ink)}
.top{position:sticky;top:0;z-index:9;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px}
.top h1{margin:0;font-size:18px;font-weight:800}
.top small{opacity:.9;font-size:12px}
.wrap{max-width:900px;margin:auto;padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px #0b1a4411}
.list{overflow:auto}
.item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.badge{font-size:12px;background:#ecfeff;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;color:#155e75}
.row{display:flex;justify-content:space-between;align-items:center}
.k{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#f9fafb}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
.btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.gray{background:#f3f4f6}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}

.nav{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr)}
.nav button{padding:10px 6px;background:#fff;border:0}
.nav button.active{color:var(--brand);font-weight:700}
.fab{position:fixed;right:16px;bottom:74px;background:var(--brand);color:#fff;border:none;width:58px;height:58px;border-radius:50%;font-size:26px;box-shadow:0 10px 30px #10b98155;cursor:pointer}

.hidden{display:none}
.mini{font-size:12px;color:var(--muted)}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px}
.stat{padding:12px;border-radius:12px;color:#064e3b;background:linear-gradient(135deg,#d1fae5,#ecfdf5)}
@media(min-width:720px){.stats{grid-template-columns:repeat(4,1fr)}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:center;font-size:14px}

/* أبناء الأم */
.kids{margin-top:8px;border-top:1px dashed var(--line);padding-top:6px}
.kids h4{margin:6px 0;font-size:13px;color:#065f46}
.kids .kid{font-size:13px;color:#334155;display:flex;justify-content:space-between;padding:6px 8px;border:1px solid var(--line);border-radius:10px;margin:4px 0;background:#f8fafc}
.kids .group{background:#ecfdf5;border-color:#a7f3d0;padding:6px 8px;border-radius:10px;margin:6px 0}
.badge.birth{background:#fff7ed;border:1px solid #fdba74;color:#9a3412}
.toggle{cursor:pointer}

/* أزرار صغيرة داخل البطاقة */
.mini-btn{padding:4px 8px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:12px}
.mini-btn.solid{background:var(--brand);border-color:var(--brand);color:#fff}

/* شريط أدوات */
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
</style>
</head>
<body>

<div class="top">
  <div class="row">
    <h1>🐑 دفتر الغنم <small>الإصدار المبسّط (PWA)</small></h1>
    <button class="btn" onclick="exportData()">تصدير</button>
  </div>
  <div class="mini">لأفضل تجربة: افتح بـ Safari ← مشاركة ← إضافة إلى الشاشة الرئيسية.</div>
</div>

<div class="wrap">
  <!-- القطيع -->
  <section id="tab-herd" class="card">
    <div style="padding:12px">
      <div class="stats">
        <div class="stat"><div class="k">إجمالي (حية)</div><div id="s_total" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">أمهات</div><div id="s_ewes" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">مواليد 30 يوم</div><div id="s_birth30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">تكلفة العلف 30 يوم</div><div id="s_feed30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">مباعة 30 يوم</div><div id="s_sold30" style="font-weight:800;font-size:22px">0</div></div>
        <div class="stat"><div class="k">إيراد بيع 30 يوم</div><div id="s_rev30" style="font-weight:800;font-size:22px">0</div></div>
      </div>

      <div class="row" style="gap:10px;margin-top:4px;flex-wrap:wrap">
        <input id="q" oninput="renderList()" placeholder="بحث بالوسم/المجموعة/الحالة" style="flex:2">
        <select id="fltStatus" onchange="renderList()" style="flex:1;min-width:170px">
          <option value="alive">الحيّة فقط</option>
          <option value="sold">المباعة</option>
          <option value="all">الكل</option>
        </select>
        <select id="sort" onchange="renderList()" style="flex:1;min-width:160px">
          <option value="created">الأحدث</option>
          <option value="id">الوسم</option>
          <option value="dob">الميلاد</option>
          <option value="group">المجموعة</option>
        </select>
      </div>

      <div class="toolbar">
        <button class="btn gray" onclick="toggleSimpleMode(this)">وضع مبسّط جداً: <span id="lblSimple">مغلق</span></button>
        <button class="btn gray" onclick="byId('fltStatus').value='sold';renderList()">عرض المباعة</button>
        <button class="btn gray" onclick="go('tab-settings')">⚙️ الإعدادات السهلة</button>
      </div>
    </div>
    <div class="list" id="list"></div>
  </section>

  <!-- إضافة سريعة -->
  <section id="tab-add" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">➕ إضافة سريعة</h3>
      <div><label class="k">الوسم</label><input id="f_id" placeholder="مثال: 105"></div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">الجنس</label>
          <select id="f_sex"><option>أنثى</option><option>ذكر</option></select></div>
        <div style="flex:1"><label class="k">المجموعة</label>
          <input id="f_group" list="dlGroups" placeholder="أمهات/مواليد/فحول">
          <datalist id="dlGroups"></datalist>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">تاريخ الميلاد</label><input id="f_dob" type="date"></div>
        <div style="flex:1"><label class="k">آخر وزن (كجم)</label><input id="f_w" type="number" step="0.01" placeholder="اختياري"></div>
      </div>
      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">الأم (وسم)</label><input id="f_mom" placeholder="اختياري"></div>
        <div style="flex:1"><label class="k">الأب (وسم)</label><input id="f_dad" placeholder="اختياري"></div>
      </div>
      <div><label class="k">ملاحظات</label><textarea id="f_notes" rows="2" placeholder="اختياري"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" onclick="clearQuick()">مسح</button>
        <button class="btn solid" onclick="saveQuick()">حفظ</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button class="btn ghost" onclick="openBirth()">🍼 ولادة</button>
        <button class="btn ghost" onclick="openWeightPrompt()">⚖️ وزن</button>
        <button class="btn ghost" onclick="openVacc()">💉 تطعيم</button>
        <button class="btn warn" onclick="openMove()">بيع/شراء/نفوق</button>
      </div>
    </div>
  </section>

  <!-- السجلات -->
  <section id="tab-events" class="card hidden">
    <div style="padding:12px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" data-t="all"  onclick="filterEv(this)">الكل</button>
        <button class="btn" data-t="birth" onclick="filterEv(this)">ولادة</button>
        <button class="btn" data-t="weight" onclick="filterEv(this)">أوزان</button>
        <button class="btn" data-t="vaccination" onclick="filterEv(this)">تطعيم</button>
        <button class="btn" data-t="movement" onclick="filterEv(this)">بيع/شراء</button>
        <button class="btn" data-t="feed" onclick="filterEv(this)">علف</button>
      </div>
    </div>
    <div class="list" id="events"></div>
  </section>

  <!-- العلف / المصروفات -->
  <section id="tab-feed" class="card hidden">
    <div style="padding:14px;display:grid;gap:12px">
      <h3 style="margin:0">🌾 تسجيل علف/مصروف</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label class="k">النوع</label>
          <select id="fd_type">
            <option>شراء علف</option>
            <option>صرف علف</option>
            <option>مصروف آخر</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px"><label class="k">الاسم/الوصف</label><input id="fd_name" placeholder="شعير، برسيم، مكعبات…"></div>
        <div style="flex:1;min-width:160px"><label class="k">التاريخ</label><input id="fd_date" type="date"></div>
        <div style="flex:1;min-width:140px"><label class="k">الكمية (كجم)</label><input id="fd_qty" type="number" step="0.01"></div>
        <div style="flex:1;min-width:160px"><label class="k">التكلفة (ريال)</label><input id="fd_cost" type="number" step="0.01"></div>
      </div>
      <div><label class="k">ملاحظات</label><input id="fd_notes" placeholder="اختياري"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn solid" onclick="saveFeed()">حفظ</button>
      </div>

      <h3 style="margin:10px 0 0 0">📋 السجل</h3>
      <div style="overflow:auto">
        <table class="table" id="tblFeed"><thead>
          <tr><th>التاريخ</th><th>النوع</th><th>الاسم</th><th>كمية</th><th>التكلفة</th><th>ملاحظات</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- الإعدادات -->
  <section id="tab-settings" class="card hidden">
    <div style="padding:14px;display:grid;gap:10px">
      <h3 style="margin:0">إعدادات</h3>

      <div class="toolbar">
        <button class="btn gray" onclick="setTrain(!TRAIN)">وضع التدريب: <b id="lblTrain">مغلق</b></button>
        <button class="btn" onclick="clearTrain()">تصفير بيانات التدريب</button>
      </div>

      <div class="row" style="gap:10px">
        <div style="flex:1"><label class="k">اسم المزرعة</label><input id="farm" oninput="saveSettings()"></div>
        <div style="flex:1"><label class="k">مجموعات (افصل بفاصلة)</label><input id="groups" oninput="saveSettings()" placeholder="أمهات, فحول, مواليد, تسمين, للبيع"></div>
      </div>
      <div class="mini">البيانات محفوظة داخليًا في جهازك. لنقلها لجهاز آخر استخدم التصدير/الاستيراد.</div>
      <div class="row" style="gap:10px">
        <label class="btn">⬆️ استيراد<input id="imp" type="file" accept=".json" class="hidden" onchange="importData(event)"></label>
        <button class="btn" onclick="exportData()">⬇️ تصدير</button>
        <button class="btn warn" onclick="if(confirm('متأكد؟')){localStorage.removeItem(KEY);location.reload()}">تفريغ البيانات (العادي)</button>
      </div>
    </div>
  </section>
</div>

<button class="fab" onclick="go('tab-add')">＋</button>

<div class="nav">
  <button id="b-herd" class="active" onclick="go('tab-herd')">القطيع</button>
  <button id="b-add" onclick="go('tab-add')">إضافة</button>
  <button id="b-events" onclick="go('tab-events')">السجلات</button>
  <button id="b-feed" onclick="go('tab-feed')">العلف</button>
  <button id="b-settings" onclick="go('tab-settings')">إعدادات</button>
</div>

<script>
/* ======= المفاتيح / وضع التدريب ======= */
const KEY='sheep_data_pwa_v2';
const KEY_TRAIN='sheep_data_pwa_training';
let TRAIN=false; // افتراضي: مغلق
let SIMPLE=false;

let DB = (()=>{ 
  try{ const t=localStorage.getItem(KEY); return t?JSON.parse(t):null }catch{ return null } 
})() || {sheep:{},events:[],finance:[],settings:{farm:'',groups:'أمهات, فحول, مواليد, تسمين, للبيع'}};

function save(){
  try{
    localStorage.setItem(TRAIN? KEY_TRAIN : KEY, JSON.stringify(DB));
  }catch(e){
    alert('تعذّر الحفظ: قد تكون مساحة المتصفح ممتلئة.');
  }
}

/* ======= تنقّل ======= */
function go(id){
  document.querySelectorAll('.card').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  const map={'tab-herd':'b-herd','tab-add':'b-add','tab-events':'b-events','tab-feed':'b-feed','tab-settings':'b-settings'};
  document.getElementById(map[id]).classList.add('active');
  if(id==='tab-herd'){ renderList(); statsToUI(); }
  if(id==='tab-events') renderEvents();
  if(id==='tab-feed') renderFeed();
  if(id==='tab-settings') renderSettings();
}

/* ======= أدوات ======= */
function byId(x){return document.getElementById(x)}
function dstr(){return new Date().toISOString().slice(0,10)}
function fmt(d){if(!d) return '—'; try{return new Date(d).toLocaleDateString('ar')}catch(e){return d}}
function toggleSimpleMode(){ SIMPLE=!SIMPLE; byId('lblSimple').textContent=SIMPLE?'مشغّل':'مغلق'; renderList(); }
function setTrain(on){ TRAIN=!!on; const raw=localStorage.getItem(TRAIN?KEY_TRAIN:KEY); if(raw){ try{ DB=JSON.parse(raw) }catch{} } renderSettings(); renderList(); renderEvents(); renderFeed(); statsToUI(); alert('تم التحويل إلى '+(TRAIN?'وضع التدريب':'الوضع العادي')); }
function clearTrain(){ localStorage.removeItem(KEY_TRAIN); if(TRAIN){ DB={sheep:{},events:[],finance:[],settings:{farm:'',groups:'أمهات, فحول, مواليد, تسمين, للبيع'}}; save(); } alert('تم تصفير بيانات وضع التدريب'); renderList(); renderEvents(); renderFeed(); statsToUI(); }

/* ======= إحصاءات ======= */
function getStats(){
  const alive=Object.values(DB.sheep).filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  const ewes=alive.filter(s=>s.sex==='أنثى').length;
  const since=new Date(); since.setDate(since.getDate()-30);
  const birth30=DB.events.filter(e=>e.type==='birth'&&new Date(e.date)>=since).length;
  const feed30=DB.finance.filter(f=>new Date(f.date)>=since).reduce((a,b)=>a+(+b.cost||0),0);
  const soldEvents=DB.events.filter(e=>e.type==='movement' && /بيع/.test(e.details||'') && new Date(e.date)>=since);
  const sold30=soldEvents.length;
  const rev30=soldEvents.reduce((a,e)=>a+(+e.amount||0),0);
  return {total:alive.length,ewes,birth30,feed30,sold30,rev30};
}
function statsToUI(){
  const s=getStats();
  byId('s_total').textContent=s.total;
  byId('s_ewes').textContent=s.ewes;
  byId('s_birth30').textContent=s.birth30;
  byId('s_feed30').textContent=s.feed30.toFixed(0);
  byId('s_sold30').textContent=s.sold30;
  byId('s_rev30').textContent=s.rev30.toFixed(0);
}

/* ======= أبناء الأم / الدُفعات ======= */
function getChildren(momId){
  return Object.values(DB.sheep).filter(ch => (ch.motherId||'').trim() === (momId||'').trim());
}
function groupChildrenByBirth(momId){
  const kids = getChildren(momId).slice().sort((a,b)=>(a.dob||'').localeCompare(b.dob||''));
  const map = {};
  kids.forEach(k=>{
    const key = k.dob || 'غير مُسجّل';
    (map[key] ||= []).push(k);
  });
  return map;
}
function toggleKids(momId){
  const row = document.getElementById('kids-'+momId);
  if(row) row.classList.toggle('hidden');
}
function latestBirthDate(momId){
  const groups = groupChildrenByBirth(momId);
  const dates = Object.keys(groups).filter(d => d && d !== 'غير مُسجّل');
  if(!dates.length) return dstr();
  dates.sort();
  return dates[dates.length-1];
}

/* ======= إضافة مولود/توأم/دفعة ======= */
function addChild(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('لم يتم العثور على الأم'); return; }
  const next = getChildren(momId).length + 1;
  const suggested = momId + '-' + String(next).padStart(2,'0');
  go('tab-add');
  byId('f_id').value    = suggested;
  byId('f_sex').value   = 'أنثى';
  byId('f_group').value = 'مواليد';
  byId('f_dob').value   = dstr();
  byId('f_w').value     = '';
  byId('f_mom').value   = momId;
  byId('f_dad').value   = mom.fatherId || '';
  byId('f_notes').value = 'مولود من الأم '+momId;
  byId('f_id').focus();
}
function addTwin(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('لم يتم العثور على الأم'); return; }
  const next = getChildren(momId).length + 1;
  const suggested = momId + '-' + String(next).padStart(2,'0');
  go('tab-add');
  byId('f_id').value    = suggested;
  byId('f_sex').value   = 'أنثى';
  byId('f_group').value = 'مواليد';
  byId('f_dob').value   = latestBirthDate(momId);
  byId('f_w').value     = '';
  byId('f_mom').value   = momId;
  byId('f_dad').value   = mom.fatherId || '';
  byId('f_notes').value = 'توأم للأم '+momId;
  byId('f_id').focus();
}
function addMany(momId){
  const mom = DB.sheep[momId]; if(!mom){ alert('لم يتم العثور على الأم'); return; }
  let n = parseInt(prompt('كم عدد المواليد؟', '2')||'0', 10);
  if(!Number.isFinite(n) || n<=0){ alert('عدد غير صالح'); return; }
  const sexAns = (prompt('الجنس: اكتب "أنثى" أو "ذكر" أو "مختلط"', 'مختلط')||'').trim();
  const mode = /ذكر/i.test(sexAns) ? 'M' : (/أنث/i.test(sexAns) ? 'F' : 'X');
  const sameBatch = (prompt('نفس تاريخ آخر دفعة؟ (نعم/لا)', 'نعم')||'نعم').trim();
  const date = /^ن|^y|^Y|^yes|^نعم/.test(sameBatch) ? latestBirthDate(momId) : dstr();

  let next = getChildren(momId).length + 1;
  const nowISO = new Date().toISOString();
  for(let i=0;i<n;i++){
    const id = momId + '-' + String(next++).padStart(2,'0');
    let sex = 'أنثى';
    if(mode==='M') sex = 'ذكر';
    else if(mode==='X') sex = (i%2===0 ? 'أنثى' : 'ذكر');
    DB.sheep[id] = {
      id, sex, group:'مواليد', dob:date, lastWeight:null,
      motherId:momId, fatherId:mom.fatherId||'',
      notes:'مضاف كدفعة', status:'حية', createdAt:nowISO, updatedAt:nowISO
    };
  }
  DB.events.push({type:'birth', ids:[momId], date, details:`${n} مولود`});
  save(); renderList(); statsToUI(); renderEvents?.();
  const kidsBox = document.getElementById('kids-'+momId); if(kidsBox) kidsBox.classList.remove('hidden');
  alert('تمت إضافة '+n+' مواليد ✅');
}

/* ======= بيع / حذف / وزن ======= */
let _undo=null; // للرجوع بعد حذف
function deleteSheep(id){
  const s=DB.sheep[id];
  if(!s){ alert('غير موجود'); return; }
  if(!confirm('حذف الوسم "'+id+'" وجميع سجلاته؟')) return;
  _undo={id,data:JSON.parse(JSON.stringify(s))};
  delete DB.sheep[id];
  DB.events = DB.events.filter(e => !(e.ids||[]).includes(id));
  save(); renderList(); statsToUI();
  if(confirm('تم الحذف. تبي تراجع؟')){ DB.sheep[_undo.id]=_undo.data; save(); renderList(); statsToUI(); _undo=null; }
}
function sellSheep(id){
  const s=DB.sheep[id]; if(!s) return;
  const price = parseFloat(prompt('سعر البيع (ريال):','')||'');
  if(!isFinite(price)) return alert('السعر غير صالح');
  const date  = prompt('تاريخ البيع (YYYY-MM-DD)', dstr()) || dstr();
  s.status='مباعة';
  s.soldPrice=price;
  s.soldDate=date;
  s.updatedAt=new Date().toISOString();
  DB.events.push({type:'movement',ids:[id],date,details:'بيع',amount:price});
  save(); renderList(); statsToUI(); renderEvents();
  // تحويل الفلتر تلقائياً للمباعة لإظهار الشيء الذي بعته
  byId('fltStatus').value='sold'; renderList();
  alert('تم البيع ✅');
}
function edit(id){
  const s=DB.sheep[id]; if(!s) return;
  byId('f_id').value=s.id; byId('f_sex').value=s.sex||'أنثى'; byId('f_group').value=s.group||'';
  byId('f_dob').value=s.dob||''; byId('f_w').value=s.lastWeight??''; byId('f_mom').value=s.motherId||''; byId('f_dad').value=s.fatherId||'';
  byId('f_notes').value=s.notes||''; go('tab-add');
}
function weight(id){
  const s=DB.sheep[id]; if(!s) return;
  const v=prompt('الوزن (كجم):', s.lastWeight ?? '');
  if(v==null) return;
  const w=parseFloat(v);
  if(!isFinite(w)) return alert('رقم غير صالح');
  s.lastWeight=w; s.updatedAt=new Date().toISOString();
  DB.events.push({type:'weight',ids:[id],date:dstr(),details:`${w} كجم`});
  save(); renderList(); statsToUI(); go('tab-herd');
}

/* ======= القطيع (قائمة) ======= */
function renderList(){
  const q=(byId('q')?.value||'').toLowerCase();
  const sort=byId('sort')?.value||'created';
  const flt=byId('fltStatus')?.value||'alive';
  let arr=Object.values(DB.sheep);

  if(q){
    arr=arr.filter(s=>(s.id||'').toLowerCase().includes(q)
      ||(s.group||'').toLowerCase().includes(q)
      ||(s.status||'').toLowerCase().includes(q));
  }
  if(flt==='alive') arr=arr.filter(s=>s.status!=='مباعة'&&s.status!=='نافقة');
  else if(flt==='sold') arr=arr.filter(s=>s.status==='مباعة');

  arr.sort((a,b)=>{
    if(sort==='id') return (a.id||'').localeCompare(b.id||'');
    if(sort==='dob') return (b.dob||'').localeCompare(a.dob||'');
    if(sort==='group') return (a.group||'').localeCompare(b.group||'');
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });

  const box=byId('list'); box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="item"><div>لا توجد سجلات هنا.. غيّر الفلتر أو اضغط + لإضافة رأس جديد</div></div>'; return; }

  arr.forEach(s=>{
    const isEwe = (s.sex||'').includes('أنث');
    const birthsGrouped = isEwe ? groupChildrenByBirth(s.id) : {};
    const birthsCount   = isEwe ? Object.keys(birthsGrouped).length : 0;

    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div style="flex:1">
        <div class="row">
          <b>${s.id||''}</b>
          ${
            SIMPLE
            ? ''
            : `<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                 <span class="badge">${s.group||'—'}</span>
                 ${s.status==='مباعة' ? '<span class="badge" style="background:#fee2e2;border-color:#fecaca;color:#991b1b">مباعة'+(s.soldPrice!=null?(' • '+s.soldPrice+'ر.س'):'')+'</span>':''}
                 ${isEwe ? `<span class="badge birth toggle" title="عرض الأبناء" onclick="toggleKids('${s.id}')">🍼 ${birthsCount}</span>`:''}
               </div>`
          }
        </div>
        <div class="k">${s.sex||''} • ${s.status||'حية'} • ${fmt(s.dob)} ${s.lastWeight!=null?('• '+s.lastWeight+' كجم'):''}</div>

        ${
          (isEwe && !SIMPLE)
          ? `<div id="kids-${s.id}" class="kids hidden">
               ${
                 Object.keys(birthsGrouped).length
                 ? Object.entries(birthsGrouped).map(([date,list])=>`
                   <div class="group">
                     <h4>دفعة ${date==='غير مُسجّل'?'بدون تاريخ':fmt(date)} — ${list.length} ${list.length>1?'مواليد':'مولود'}</h4>
                     ${list.map(ch=>`
                       <div class="kid">
                         <div><b>${ch.id||''}</b> • ${ch.sex||''} ${ch.lastWeight!=null?('• '+ch.lastWeight+' كجم'):''}</div>
                         <div class="k">${ch.group||''}</div>
                       </div>
                     `).join('')}
                   </div>
                 `).join('')
                 : `<div class="k">لا يوجد أبناء مسجّلين لهذه الأم بعد.</div>`
               }
             </div>`
          : ''
        }
      </div>

      <div class="row" style="gap:6px;flex-wrap:wrap">
        ${ isEwe && s.status!=='مباعة' ? `<button class="btn gray" onclick="addChild('${s.id}')">＋ مولود</button>` : '' }
        ${ isEwe && !SIMPLE && s.status!=='مباعة' ? `<button class="btn gray" onclick="addTwin('${s.id}')">＋ توأم</button>` : '' }
        ${ isEwe && !SIMPLE && s.status!=='مباعة' ? `<button class="btn gray" onclick="addMany('${s.id}')">＋ متعدد</button>` : '' }
        ${ s.status!=='مباعة' ? `<button class="btn warn" onclick="sellSheep('${s.id}')">💸 بيع</button>` : '' }
        <button class="btn" onclick="edit('${s.id}')">تعديل</button>
        <button class="btn" onclick="weight('${s.id}')">⚖️</button>
        <button class="btn danger" onclick="deleteSheep('${s.id}')">🗑️ حذف</button>
      </div>
    `;
    box.appendChild(el);
  });
}

/* ======= إضافة سريعة ======= */
function clearQuick(){['f_id','f_group','f_dob','f_w','f_mom','f_dad','f_notes'].forEach(x=>byId(x).value=''); byId('f_sex').value='أنثى'}
function saveQuick(){
  const id=(byId('f_id').value||'').trim();
  if(!id) return alert('اكتب الوسم');
  const s={
    id,
    sex:byId('f_sex').value||'أنثى',
    group:byId('f_group').value||'',
    dob:byId('f_dob').value||'',
    lastWeight: byId('f_w').value?parseFloat(byId('f_w').value):null,
    motherId:byId('f_mom').value||'',
    fatherId:byId('f_dad').value||'',
    notes:byId('f_notes').value||'',
    status: DB.sheep[id]?.status || 'حية',
    soldPrice: DB.sheep[id]?.soldPrice ?? null,
    soldDate:  DB.sheep[id]?.soldDate  ?? '',
    createdAt: DB.sheep[id]?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  DB.sheep[id]=s; save();
  clearQuick(); statsToUI(); renderList(); alert('تم الحفظ ✅'); go('tab-herd');
}

/* ======= سجلات ======= */
let EV_FILTER='all';
function filterEv(btn){EV_FILTER=btn.dataset.t; renderEvents()}
function renderEvents(){
  const box=byId('events'); box.innerHTML='';
  let arr=DB.events.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  if(EV_FILTER!=='all') arr=arr.filter(e=>e.type===EV_FILTER);
  if(!arr.length){ box.innerHTML='<div class="item">لا توجد سجلات بعد.</div>'; return; }
  const map={birth:'🍼 ولادة',weight:'⚖️ وزن',vaccination:'💉 تطعيم',movement:'🔁 بيع/شراء',feed:'🌾 علف'};
  arr.forEach(e=>{
    const el=document.createElement('div'); el.className='item';
    const det=(e.type==='movement'&&/بيع/.test(e.details||'')) ? (e.details+' — '+(e.amount||0)+' ر.س') : (e.details||'');
    el.innerHTML=`<div style="flex:1"><b>${map[e.type]||e.type}</b><div class="k">${det}</div></div><div class="k">${fmt(e.date)}</div>`;
    box.appendChild(el);
  });
}

/* ======= عمليات سريعة (ولادة/تطعيم/حركة) ======= */
function openBirth(){
  const mom=prompt('وسم الأم؟'); if(!mom) return;
  const cnt=parseInt(prompt('عدد المواليد؟ (1/2/..)')||'1',10);
  DB.events.push({type:'birth',ids:[mom],date:dstr(),details:`${cnt} مولود`});
  save(); alert('سُجّلت الولادة'); statsToUI(); renderEvents(); go('tab-events');
}
function openWeightPrompt(){
  const id=prompt('وسم الرأس؟'); if(!id||!DB.sheep[id]) return alert('الوسم غير موجود');
  weight(id);
}
function openVacc(){
  const ids=(prompt('الوسوم (افصل بفاصلة)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const name=prompt('اسم اللقاح؟')||'لقاح';
  const next=prompt('موعد قادم (YYYY-MM-DD) اختياري')||'';
  ids.forEach(id=>{
    if(DB.sheep[id]){ DB.sheep[id].vaccinations=(DB.sheep[id].vaccinations||[]); DB.sheep[id].vaccinations.push({name,date:dstr(),next}); }
  });
  DB.events.push({type:'vaccination',ids,date:dstr(),details:`${name}${next? ' — القادم: '+next:''}`});
  save(); alert('تم التطعيم'); renderEvents(); go('tab-events');
}
function openMove(){
  const type=prompt('العملية: بيع / شراء / نفوق / نقل')||'بيع';
  const ids=(prompt('الوسوم (افصل بفاصلة)')||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!ids.length) return;
  const date=dstr();
  let det=type; let amt=null; let to='';
  if(type==='بيع'||type==='شراء'){ amt=parseFloat(prompt('القيمة (ريال)')||'0'); det+=` — ${amt} ريال`; }
  if(type==='نقل'){ to=prompt('إلى أي مجموعة؟')||''; det+=to?` — إلى ${to}`:''; }
  ids.forEach(id=>{
    const s=DB.sheep[id]; if(!s) return;
    if(type==='بيع'){ s.status='مباعة'; s.soldPrice=amt; s.soldDate=date; }
    else if(type==='شراء') s.status='حية';
    else if(type==='نفوق') s.status='نافقة';
    else if(type==='نقل') s.group=to;
    s.updatedAt=new Date().toISOString();
  });
  DB.events.push({type:'movement',ids,date,details:det,amount:(type==='بيع'&&amt)?amt:0});
  save(); alert('تم تسجيل الحركة'); renderEvents(); renderList(); statsToUI(); go('tab-events');
}

/* ======= العلف/المصروفات ======= */
function renderFeed(){
  const tb=byId('tblFeed').querySelector('tbody'); tb.innerHTML='';
  DB.finance.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.type}</td><td>${r.name||'—'}</td><td>${r.qty||0}</td><td>${r.cost||0}</td><td>${r.notes||''}</td>`;
    tb.appendChild(tr);
  });
}
function saveFeed(){
  const t=byId('fd_type').value,
        name=byId('fd_name').value||'',
        date=byId('fd_date').value||dstr(),
        qty=byId('fd_qty').value?parseFloat(byId('fd_qty').value):0,
        cost=byId('fd_cost').value?parseFloat(byId('fd_cost').value):0,
        notes=byId('fd_notes').value||'';
  DB.finance.push({type:t,name,date,qty,cost,notes});
  DB.events.push({type:'feed',ids:[],date,details:`${t} — ${name} — ${qty||0} كجم — ${cost||0} ريال ${notes? ' — '+notes:''}`});
  save();
  byId('fd_name').value=''; byId('fd_qty').value=''; byId('fd_cost').value=''; byId('fd_notes').value='';
  renderFeed(); statsToUI(); alert('تم الحفظ ✅');
}

/* ======= إعدادات ======= */
function renderSettings(){
  byId('farm').value=DB.settings.farm||'';
  byId('groups').value=DB.settings.groups||'';
  byId('lblTrain').textContent = TRAIN? 'مشغّل' : 'مغلق';
  const dl=byId('dlGroups'); dl.innerHTML='';
  (DB.settings.groups||'').split(',').map(x=>x.trim()).filter(Boolean).forEach(g=>{
    const o=document.createElement('option'); o.value=g; dl.appendChild(o);
  });
}
function saveSettings(){ DB.settings.farm=byId('farm').value; DB.settings.groups=byId('groups').value; save(); renderSettings(); }

/* ======= تصدير/استيراد ======= */
function exportData(){ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sheep-data.json'; a.click(); }
function importData(ev){ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ DB=JSON.parse(r.result); save(); go('tab-herd'); renderList(); renderEvents(); renderFeed(); renderSettings(); statsToUI(); alert('تم الاستيراد ✅'); }catch{ alert('ملف غير صالح'); } }; r.readAsText(f); }

/* تهيئة */
go('tab-herd'); renderSettings(); statsToUI();

/* PWA */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=2').catch(console.warn); }); }
</script>
</body>
</html>
